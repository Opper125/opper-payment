<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OPPER Payment</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Segoe UI', Arial, sans-serif; }
        body { background: linear-gradient(135deg, #e0f7fa, #b2ebf2); min-height: 100vh; padding: 10px; overflow-x: hidden; font-size: 16px; }
        .id-badge { position: fixed; top: 10px; right: 10px; background: #80deea; border: 2px solid #5d4037; border-radius: 8px; padding: 8px 12px; font-weight: bold; color: #333; box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1); z-index: 100; }
        .container { width: 100%; max-width: 500px; padding: 20px; background: #ffffff; border-radius: 15px; box-shadow: 0 8px 16px rgba(0, 0, 0, 0.2); margin: 20px auto; display: none; }
        .container.active { display: block; }
        h2 { text-align: center; color: #2e7d32; margin-bottom: 20px; font-size: 1.5rem; }
        .form-group { margin-bottom: 20px; }
        label { display: block; color: #444; margin-bottom: 8px; font-weight: bold; font-size: 1rem; }
        input, select { width: 100%; padding: 12px; border: 2px solid #5d4037; border-radius: 8px; background: #e0f7fa; color: #333; outline: none; font-size: 1rem; transition: border-color 0.3s ease; }
        input:focus, select:focus { border-color: #0288d1; }
        button { width: 100%; padding: 12px; background: #80deea; border: 2px solid #5d4037; border-radius: 8px; color: #333; font-weight: bold; cursor: pointer; font-size: 1rem; transition: all 0.3s ease; }
        button:hover { background: #4fc3f7; transform: translateY(-2px); box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2); }
        .menu { display: flex; justify-content: space-around; position: fixed; bottom: 0; left: 0; width: 100%; background: #ffffff; padding: 10px; box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.1); z-index: 100; }
        .menu button { flex: 1; margin: 0 5px; display: flex; flex-direction: column; align-items: center; font-size: 0.9rem; padding: 5px; background: #80deea; border: none; }
        .menu img { width: 24px; height: 24px; margin-bottom: 5px; }
        .history-item { padding: 10px; border-radius: 5px; margin-bottom: 5px; font-size: 0.9rem; transition: all 0.3s ease; }
        .history-item.out { background: #ffebee; color: #d32f2f; border: 1px solid #d32f2f; }
        .history-item.in { background: #e8f5e9; color: #2e7d32; border: 1px solid #2e7d32; }
        .history-header { background: #80deea; padding: 10px; border-radius: 8px; margin-bottom: 10px; border: 2px solid #5d4037; font-size: 0.9rem; }
        .status { padding: 5px 10px; border-radius: 5px; display: inline-block; font-weight: bold; font-size: 0.9rem; }
        .status.pending { background: #ffeb3b; color: #333; }
        .status.approved { background: #4caf50; color: #fff; }
        .status.rejected { background: #f44336; color: #fff; }
        .transfer-animation { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); font-size: 1.5rem; color: #fff; background: rgba(76, 175, 80, 0.9); padding: 20px; border-radius: 10px; text-align: center; box-shadow: 0 0 20px rgba(0, 0, 0, 0.3); animation: transferPulse 1.5s ease-out; z-index: 200; }
        @keyframes transferPulse { 0% { opacity: 0; transform: translate(-50%, -50%) scale(0.5); } 50% { opacity: 1; transform: translate(-50%, -50%) scale(1.1); } 100% { opacity: 0; transform: translate(-50%, -50%) scale(1); } }
        .receiver-message { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: linear-gradient(135deg, #0288d1, #4fc3f7); color: #fff; padding: 15px 25px; border-radius: 10px; font-size: 1.2rem; font-weight: bold; box-shadow: 0 0 15px rgba(0, 0, 0, 0.2); animation: fadeInOut 2s ease-out; z-index: 200; text-align: center; }
        @keyframes fadeInOut { 0% { opacity: 0; transform: translate(-50%, -50%) scale(0.8); } 20% { opacity: 1; transform: translate(-50%, -50%) scale(1); } 80% { opacity: 1; transform: translate(-50%, -50%) scale(1); } 100% { opacity: 0; transform: translate(-50%, -50%) scale(0.8); } }
        .error-message { color: #f44336; text-align: center; margin-top: 10px; font-weight: bold; font-size: 0.9rem; }
        .hidden { display: none; }
        .passport-submitted { margin-top: 20px; padding: 15px; background: #e8f5e9; border-radius: 8px; border: 2px solid #2e7d32; }
        .warning { position: fixed; top: 10px; left: 50%; transform: translateX(-50%); background: #f44336; color: #fff; padding: 10px 20px; border-radius: 5px; font-weight: bold; animation: slideDown 2s ease-out; z-index: 200; }
        @keyframes slideDown { 0% { opacity: 0; transform: translate(-50%, -100%); } 20% { opacity: 1; transform: translate(-50%, 0); } 80% { opacity: 1; transform: translate(-50%, 0); } 100% { opacity: 0; transform: translate(-50%, 0); } }
    </style>
</head>
<body>
    <div class="id-badge" id="id-badge">ID: </div>

    <!-- Wallet Section -->
    <div id="wallet" class="container active">
        <h2>My Wallet</h2>
        <div class="form-group">
            <label>Balance</label>
            <p><span id="balance">0 Ks</span></p>
            <button id="transfer-btn" onclick="toggleTransfer()" disabled>Transfer Money</button>
            <p id="wallet-status" class="status pending">Passport Verification Required</p>
        </div>
        <div id="transfer" class="form-group hidden">
            <label>Recipient Phone Number</label>
            <input type="tel" id="transfer-phone" placeholder="09xxxxxxxxx" required oninput="checkPhone()">
            <p id="receiver-name"></p>
            <label>Amount (Ks)</label>
            <input type="number" id="transfer-amount" placeholder="Max 1,000,000 Ks" required>
            <label>Note</label>
            <input type="text" id="transfer-note" placeholder="Note (optional)">
            <label>Payment PIN (6 digits)</label>
            <input type="password" id="transfer-pin" maxlength="6" placeholder="Enter 6-digit PIN" required>
            <button id="confirm-transfer-btn">Confirm Transfer</button>
            <p id="transfer-error" class="error-message hidden"></p>
        </div>
    </div>

    <!-- Host Section (Transaction History) -->
    <div id="host" class="container">
        <h2>Transaction History</h2>
        <div class="form-group">
            <div class="history-header">
                <select id="month-filter" onchange="loadHistory()">
                    <option value="current">Current Month</option>
                    <option value="previous">Previous Month</option>
                </select>
                <p>Total Received: <span id="total-in">0 Ks</span></p>
                <p>Total Sent: <span id="total-out">0 Ks</span></p>
            </div>
            <div id="history-list"></div>
        </div>
    </div>
    
    <div id="mi" class="container">
        <h2>My Profile</h2>
        <div class="form-group">
            <p>Your ID: <span id="mi-id"></span></p>
            <p id="mi-status" class="status pending">Passport Verification Required</p>
            <div id="passport-form" class="form-group">
                <h3>Submit Passport Details</h3>
                <label>Passport Number</label>
                <input type="text" id="passport-number" placeholder="Enter Passport Number" required>
                <label>Address</label>
                <input type="text" id="address" placeholder="Enter Address" required>
                <label>Phone Number (09xxxxxxxxx)</label>
                <input type="tel" id="phone" placeholder="09xxxxxxxxx" required>
                <label>Payment PIN (6 digits)</label>
                <input type="password" id="payment-pin" maxlength="6" placeholder="Enter 6-digit PIN" required>
                <label>Passport Image</label>
                <input type="file" id="passport-image" accept="image/*" required>
                <label>Selfie with Passport</label>
                <input type="file" id="selfie-image" accept="image/*" required>
                <button id="submit-passport-btn">Submit</button>
            </div>
            <div id="passport-submitted" class="passport-submitted hidden">
                <h3>Submitted</h3>
                <p>Phone Number: <span id="submitted-phone"></span></p>
                <p>Passport Number: <span id="submitted-passport"></span></p>
                <p>Address: <span id="submitted-address"></span></p>
                <p>Submitted At: <span id="submitted-time"></span></p>
            </div>
        </div>
    </div>

    <div class="menu">
        <button onclick="showSection('wallet')"><img src="https://cdn-icons-png.flaticon.com/512/1250/1250689.png" alt="Home">Wallet</button>
        <button onclick="showSection('host')"><img src="https://cdn-icons-png.flaticon.com/512/2099/2099058.png" alt="Host">History</button>
        <button onclick="showSection('mi')"><img src="https://cdn-icons-png.flaticon.com/512/1077/1077063.png" alt="MI">Profile</button>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script>
        const supabaseUrl = 'https://vtsczzlnhsrgnbkfyizi.supabase.co';
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZ0c2N6emxuaHNyZ25ia2Z5aXppIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDI2ODYwODMsImV4cCI6MjA1ODI2MjA4M30.LjP2g0WXgg6FVTM5gPIkf_qlXakkj8Hf5xzXVsx7y68';
        const supabase = window.supabase.createClient(supabaseUrl, supabaseKey);
        const imgurClientId = '5befa9dd970c7d0';

        let currentUser = { user_id: null, balance: 0, passport_status: 'pending', phone: null };

        async function initializeUser() {
            try {
                let userId = localStorage.getItem('userId');
                if (!userId) {
                    userId = Math.floor(100000 + Math.random() * 900000).toString();
                    while (true) {
                        const { data: existingUser, error } = await supabase
                            .from('users')
                            .select('user_id')
                            .eq('user_id', userId)
                            .single();
                        if (error && error.code !== 'PGRST116') throw error;
                        if (!existingUser) break;
                        userId = Math.floor(100000 + Math.random() * 900000).toString();
                    }
                    localStorage.setItem('userId', userId);

                    const { error: insertError } = await supabase
                        .from('users')
                        .insert({ user_id: userId, balance: 0, passport_status: 'pending' });
                    if (insertError) throw insertError;
                }
                currentUser.user_id = userId;

                document.getElementById('id-badge').textContent = `ID: ${userId}`;
                document.getElementById('mi-id').textContent = userId;

                const { data: user, error } = await supabase
                    .from('users')
                    .select('*')
                    .eq('user_id', userId)
                    .single();
                if (error && error.code !== 'PGRST116') throw error;
                if (user) currentUser = user;

                document.getElementById('balance').textContent = `${currentUser.balance} Ks`;
                updateStatus(currentUser.passport_status);

                supabase.channel('users-channel')
                    .on('postgres_changes', { event: '*', schema: 'public', table: 'users', filter: `user_id=eq.${userId}` }, payload => {
                        currentUser = { ...currentUser, ...payload.new };
                        document.getElementById('balance').textContent = `${currentUser.balance} Ks`;
                        updateStatus(currentUser.passport_status);
                    })
                    .subscribe();

                supabase.channel('transactions-channel')
                    .on('postgres_changes', { event: 'INSERT', schema: 'public', table: 'transactions' }, () => loadHistory())
                    .subscribe();

                loadHistory();
            } catch (error) {
                console.error('Initialization Error:', error.message);
                alert('An error occurred. Please try again.');
            }
        }

        function showSection(sectionId) {
            ['wallet', 'host', 'mi'].forEach(id => {
                document.getElementById(id).classList.toggle('active', id === sectionId);
            });
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        function toggleTransfer() {
            if (currentUser.passport_status !== 'approved') {
                alert('Passport must be approved to transfer money.');
                return;
            }
            document.getElementById('transfer').classList.toggle('hidden');
        }

        async function checkPhone() {
            try {
                const phone = document.getElementById('transfer-phone').value;
                document.getElementById('receiver-name').textContent = '';
                if (phone.match(/^09\d{9}$/)) {
                    const { data: receiver, error } = await supabase
                        .from('users')
                        .select('user_id, phone, passport_status')
                        .eq('phone', phone)
                        .single();
                    if (error && error.code !== 'PGRST116') throw error;
                    if (receiver && receiver.passport_status === 'approved') {
                        const message = document.createElement('div');
                        message.className = 'receiver-message';
                        message.innerHTML = `Recipient: ${receiver.phone}<br>ID: ${receiver.user_id}`;
                        document.body.appendChild(message);
                        setTimeout(() => message.remove(), 2000);
                    } else {
                        document.getElementById('receiver-name').textContent = 'Account not found or passport not approved.';
                    }
                }
            } catch (error) {
                console.error('Check Phone Error:', error.message);
                document.getElementById('receiver-name').textContent = 'An error occurred.';
            }
        }

        async function loadHistory() {
            try {
                const month = document.getElementById('month-filter').value;
                const monthFilter = month === 'current' ? new Date().getMonth() : new Date().getMonth() - 1;
                const { data: transactions, error } = await supabase
                    .from('transactions')
                    .select('*')
                    .or(`from_phone.eq.${currentUser.phone},to_phone.eq.${currentUser.phone}`)
                    .gte('timestamp', new Date(new Date().setMonth(monthFilter)).toISOString().split('T')[0]);
                if (error) throw error;

                const historyList = document.getElementById('history-list');
                historyList.innerHTML = '';
                let totalIn = 0, totalOut = 0;

                (transactions || []).forEach(t => {
                    const item = document.createElement('div');
                    item.className = `history-item ${t.from_phone === currentUser.phone ? 'out' : 'in'}`;
                    item.innerHTML = `${t.from_phone === currentUser.phone ? '-' : '+'}${t.amount} Ks<br>Phone: ${t.from_phone === currentUser.phone ? t.to_phone : t.from_phone}<br>Note: ${t.note || 'None'}<br>Time: ${t.timestamp}`;
                    historyList.appendChild(item);
                    if (t.from_phone === currentUser.phone) totalOut += t.amount;
                    else totalIn += t.amount;
                });

                document.getElementById('total-in').textContent = `${totalIn} Ks`;
                document.getElementById('total-out').textContent = `${totalOut} Ks`;
            } catch (error) {
                console.error('Load History Error:', error.message);
            }
        }

        function updateStatus(status) {
            const walletStatus = document.getElementById('wallet-status');
            const miStatus = document.getElementById('mi-status');
            walletStatus.className = `status ${status}`;
            miStatus.className = `status ${status}`;
            walletStatus.textContent = status === 'pending' ? 'Passport Verification Required' : status === 'approved' ? 'Approved' : 'Passport Rejected';
            miStatus.textContent = walletStatus.textContent;

            const passportForm = document.getElementById('passport-form');
            const passportSubmitted = document.getElementById('passport-submitted');

            if (status === 'approved') {
                document.getElementById('transfer-btn').disabled = false;
                passportForm.classList.add('hidden');
                passportSubmitted.classList.remove('hidden');
                document.getElementById('submitted-phone').textContent = currentUser.phone || 'N/A';
                document.getElementById('submitted-passport').textContent = currentUser.passport_number || 'N/A';
                document.getElementById('submitted-address').textContent = currentUser.address || 'N/A';
                document.getElementById('submitted-time').textContent = currentUser.submitted_at ? new Date(currentUser.submitted_at).toLocaleString() : 'N/A';
            } else if (status === 'pending' && currentUser.submitted_at) {
                passportForm.classList.add('hidden');
                passportSubmitted.classList.remove('hidden');
                document.getElementById('submitted-phone').textContent = currentUser.phone || 'N/A';
                document.getElementById('submitted-passport').textContent = currentUser.passport_number || 'N/A';
                document.getElementById('submitted-address').textContent = currentUser.address || 'N/A';
                document.getElementById('submitted-time').textContent = currentUser.submitted_at ? new Date(currentUser.submitted_at).toLocaleString() : 'N/A';
            } else {
                passportForm.classList.remove('hidden');
                passportSubmitted.classList.add('hidden');
            }
        }

        async function uploadToImgur(file) {
            try {
                const formData = new FormData();
                formData.append('image', file);
                const response = await fetch('https://api.imgur.com/3/image', {
                    method: 'POST',
                    headers: { Authorization: `Client-ID ${imgurClientId}` },
                    body: formData
                });
                const data = await response.json();
                if (!data.success) throw new Error('Imgur Upload Failed');
                return data.data.link;
            } catch (error) {
                console.error('Imgur Upload Error:', error.message);
                throw error;
            }
        }

        async function updateUserData(data) {
            try {
                const response = await fetch('/.netlify/functions/data', {
                    method: 'POST',
                    body: JSON.stringify(data),
                    headers: { 'Content-Type': 'application/json' }
                });
                if (!response.ok) throw new Error('Failed to update data');
            } catch (error) {
                console.error('Update Data Error:', error.message);
            }
        }

        document.getElementById('submit-passport-btn').addEventListener('click', async () => {
            try {
                const passportNumber = document.getElementById('passport-number').value;
                const address = document.getElementById('address').value;
                const phone = document.getElementById('phone').value;
                const paymentPin = document.getElementById('payment-pin').value;
                const passportImage = document.getElementById('passport-image').files[0];
                const selfieImage = document.getElementById('selfie-image').files[0];

                if (!passportNumber || !address || !phone.match(/^09\d{9}$/) || paymentPin.length !== 6 || !passportImage || !selfieImage) {
                    const warning = document.createElement('div');
                    warning.className = 'warning';
                    warning.textContent = 'Please fill all fields correctly. PIN must be 6 digits.';
                    document.body.appendChild(warning);
                    setTimeout(() => warning.remove(), 2000);
                    return;
                }

                const [passportUrl, selfieUrl] = await Promise.all([
                    uploadToImgur(passportImage),
                    uploadToImgur(selfieImage)
                ]);

                const updatedData = {
                    user_id: currentUser.user_id,
                    phone,
                    payment_pin: paymentPin,
                    passport_number: passportNumber,
                    address,
                    passport_image: passportUrl,
                    selfie_image: selfieUrl,
                    submitted_at: new Date().toISOString()
                };

                await supabase.from('users').update(updatedData).eq('user_id', currentUser.user_id);
                await updateUserData(updatedData);

                currentUser = { ...currentUser, ...updatedData, passport_status: 'pending' };
                alert('Passport details submitted successfully. Awaiting approval.');
                updateStatus('pending');
            } catch (error) {
                console.error('Submit Passport Error:', error.message);
                alert('An error occurred while submitting passport details.');
            }
        });

        document.getElementById('confirm-transfer-btn').addEventListener('click', async () => {
            try {
                const phone = document.getElementById('transfer-phone').value;
                const amount = parseInt(document.getElementById('transfer-amount').value);
                const note = document.getElementById('transfer-note').value;
                const pin = document.getElementById('transfer-pin').value;

                if (!phone.match(/^09\d{9}$/) || amount > 1000000 || amount <= 0 || pin.length !== 6) {
                    document.getElementById('transfer-error').textContent = 'Invalid input. Max 1,000,000 Ks, PIN must be 6 digits.';
                    document.getElementById('transfer-error').classList.remove('hidden');
                    return;
                }

                const { data: sender, error: senderError } = await supabase
                    .from('users')
                    .select('*')
                    .eq('user_id', currentUser.user_id)
                    .eq('payment_pin', pin)
                    .single();
                if (senderError) throw senderError;
                const { data: receiver, error: receiverError } = await supabase
                    .from('users')
                    .select('*')
                    .eq('phone', phone)
                    .single();
                if (receiverError) throw receiverError;

                if (!sender || !receiver || sender.balance < amount || receiver.passport_status !== 'approved') {
                    document.getElementById('transfer-error').textContent = !sender ? 'Incorrect PIN.' : !receiver ? 'Recipient account not found.' : sender.balance < amount ? 'Insufficient balance.' : 'Recipient passport not approved.';
                    document.getElementById('transfer-error').classList.remove('hidden');
                    return;
                }

                const now = new Date().toLocaleString('en-US', { timeZone: 'Asia/Yangon' });
                const { error: updateSenderError } = await supabase
                    .from('users')
                    .update({ balance: sender.balance - amount })
                    .eq('user_id', sender.user_id);
                if (updateSenderError) throw updateSenderError;
                const { error: updateReceiverError } = await supabase
                    .from('users')
                    .update({ balance: receiver.balance + amount })
                    .eq('user_id', receiver.user_id);
                if (updateReceiverError) throw updateReceiverError;
                const { error: insertError } = await supabase
                    .from('transactions')
                    .insert({ from_phone: sender.phone, to_phone: receiver.phone, amount, note, timestamp: now });
                if (insertError) throw insertError;

                currentUser.balance = sender.balance - amount;
                document.getElementById('balance').textContent = `${currentUser.balance} Ks`;
                document.getElementById('transfer-error').classList.add('hidden');
                document.getElementById('transfer').classList.add('hidden');

                const animation = document.createElement('div');
                animation.className = 'transfer-animation';
                animation.innerHTML = `Transfer Successful<br>${amount} Ks<br><span style="font-size: 2rem;">✔</span>`;
                document.body.appendChild(animation);
                setTimeout(() => animation.remove(), 1500);
            } catch (error) {
                console.error('Transfer Error:', error.message);
                document.getElementById('transfer-error').textContent = 'An error occurred during transfer.';
                document.getElementById('transfer-error').classList.remove('hidden');
            }
        });

        window.onload = initializeUser;
    </script>
</body>
</html>

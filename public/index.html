<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>OPPER+ Premium Payment</title>
    <style>
        /* Base Styles */
        :root {
            --primary: #d42628;
            --primary-dark: #b51f21;
            --primary-light: #f15456;
            --secondary: #fcd92b;
            --secondary-dark: #d9bc25;
            --secondary-light: #ffe563;
            --dark-blue: #051441;
            --dark-blue-light: #152654;
            --light: #ffffff;
            --dark: #13111a;
            --gray-light: #e5e7eb;
            --gray: #94a3b8;
            --gray-dark: #334155;
            --success: #10b981;
            --error: #ef4444;
            --warning: #f59e0b;
            --info: #3b82f6;
            --radius-sm: 0.375rem;
            --radius-md: 0.75rem;
            --radius-lg: 1.25rem;
            --radius-full: 9999px;
            --shadow-sm: 0 2px 4px rgba(0, 0, 0, 0.1);
            --shadow-md: 0 4px 10px rgba(0, 0, 0, 0.15);
            --shadow-lg: 0 10px 25px rgba(0, 0, 0, 0.25);
            --transition-fast: 0.2s ease;
            --transition-normal: 0.3s ease;
            --transition-slow: 0.5s ease;
            --font-main: 'Pyidaungsu', 'Poppins', sans-serif;
            --font-display: 'Padauk', 'Playfair Display', serif;
            --gradient-primary: linear-gradient(135deg, var(--primary), var(--primary-light));
            --gradient-secondary: linear-gradient(135deg, var(--secondary), var(--secondary-light));
            --gradient-dark: linear-gradient(135deg, var(--dark-blue), var(--dark-blue-light));
            --gradient-glass: linear-gradient(135deg, rgba(255, 255, 255, 0.1), rgba(255, 255, 255, 0.05));
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: var(--font-main);
            -webkit-tap-highlight-color: transparent;
        }

        body {
            background: var(--gradient-dark);
            min-height: 100vh;
            padding: 0;
            overflow-x: hidden;
            color: var(--light);
            position: relative;
            touch-action: auto;
        }

        /* Typography */
        h1, h2, h3, h4 {
            font-family: var(--font-display);
            font-weight: 700;
            letter-spacing: -0.02em;
        }

        /* Animation and Effects */
        .intro-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: var(--dark-blue);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 10001;
            animation: introFadeOut 1s ease 6s forwards;
        }

        .intro-logo-wrapper {
            position: relative;
            width: 220px;
            height: 220px;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .intro-logo-circle {
            position: absolute;
            width: 100%;
            height: 100%;
            border-radius: 50%;
            border: 3px solid var(--primary);
            animation: logoCircleExpand 3s ease-out;
        }

        .intro-logo {
            width: 180px;
            height: 180px;
            transform: scale(0.5);
            opacity: 0;
            animation: logoReveal 2s ease 0.5s forwards;
        }

        .intro-text {
            margin-top: 30px;
            font-size: 2.5rem;
            font-weight: 800;
            color: var(--light);
            opacity: 0;
            text-align: center;
            animation: slideUpFade 1.5s ease 2.5s forwards;
        }

        .intro-text .primary {
            color: var(--primary);
            position: relative;
            display: inline-block;
        }

        .intro-text .primary::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            width: 0%;
            height: 3px;
            background: var(--primary);
            animation: textUnderline 1s ease 3.5s forwards;
        }

        .intro-tagline {
            margin-top: 20px;
            font-size: 1.2rem;
            opacity: 0;
            color: var(--gray-light);
            animation: slideUpFade 1.5s ease 3s forwards;
        }

        @keyframes logoCircleExpand {
            0% { transform: scale(0); opacity: 0; }
            40% { transform: scale(1.2); opacity: 0.8; }
            70% { transform: scale(0.9); opacity: 1; }
            100% { transform: scale(1); opacity: 1; }
        }

        @keyframes logoReveal {
            0% { transform: scale(0.5); opacity: 0; }
            100% { transform: scale(1); opacity: 1; }
        }

        @keyframes slideUpFade {
            0% { transform: translateY(30px); opacity: 0; }
            100% { transform: translateY(0); opacity: 1; }
        }

        @keyframes textUnderline {
            0% { width: 0; }
            100% { width: 100%; }
        }

        @keyframes introFadeOut {
            0% { opacity: 1; visibility: visible; }
            100% { opacity: 0; visibility: hidden; }
        }

        .particles-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: -1;
            overflow: hidden;
        }

        .particle {
            position: absolute;
            background: var(--primary-light);
            border-radius: 50%;
            opacity: 0.3;
            animation: float linear infinite;
        }

        @keyframes float {
            0% { transform: translateY(0) rotate(0); }
            100% { transform: translateY(-100vh) rotate(360deg); }
        }

        /* UI Components */
        .download-bar {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            background: var(--primary);
            padding: 12px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            z-index: 1000;
            box-shadow: var(--shadow-md);
        }

        .download-bar p {
            font-size: 1rem;
            font-weight: 600;
            color: var(--light);
        }

        .download-bar button {
            padding: 8px 16px;
            background: var(--light);
            border: none;
            border-radius: var(--radius-full);
            color: var(--primary);
            font-weight: 600;
            cursor: pointer;
            position: relative;
            overflow: hidden;
            transition: transform var(--transition-normal);
        }

        .download-bar button:active {
            transform: scale(0.95);
        }

        .download-bar .close-btn {
            background: transparent;
            color: var(--light);
            font-size: 1.2rem;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 0;
        }

        .logo-header {
            position: fixed;
            top: 70px;
            left: 0;
            width: 100%;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0 20px;
            z-index: 100;
        }

        .logo {
            width: 60px;
            height: 60px;
            filter: drop-shadow(0 0 8px rgba(212, 38, 40, 0.5));
            transition: transform var(--transition-normal);
        }

        .logo:active {
            transform: scale(0.95);
        }

        .id-badge {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid var(--primary);
            border-radius: var(--radius-full);
            padding: 8px 16px;
            font-weight: 600;
            color: var(--primary);
            box-shadow: var(--shadow-sm);
            backdrop-filter: blur(10px);
            transition: transform var(--transition-normal);
        }

        .id-badge:active {
            transform: scale(0.95);
        }

        .container {
            width: 100%;
            max-width: 480px;
            padding: 25px;
            background: var(--gradient-glass);
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-lg);
            margin: 140px auto 100px;
            display: none;
            backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.15);
            transition: all var(--transition-normal);
            min-height: calc(100vh - 250px);
            overflow-y: auto;
        }

        .container.active {
            display: block;
            animation: containerFadeIn 0.5s ease forwards;
        }

        @keyframes containerFadeIn {
            0% { opacity: 0; transform: translateY(20px); }
            100% { opacity: 1; transform: translateY(0); }
        }

        h2 {
            text-align: center;
            color: var(--light);
            margin-bottom: 25px;
            font-size: 2rem;
            font-weight: 700;
            position: relative;
        }

        h2::after {
            content: '';
            position: absolute;
            bottom: -10px;
            left: 50%;
            transform: translateX(-50%);
            width: 60px;
            height: 3px;
            background: var(--primary);
            border-radius: var(--radius-full);
        }

        .form-group {
            margin-bottom: 25px;
        }

        label {
            display: block;
            color: var(--light);
            margin-bottom: 10px;
            font-weight: 600;
            font-size: 1.1rem;
        }

        input, select {
            width: 100%;
            padding: 16px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: var(--radius-md);
            background: rgba(255, 255, 255, 0.08);
            color: var(--light);
            outline: none;
            font-size: 1rem;
            transition: all var(--transition-normal);
        }

        input:focus, select:focus {
            border-color: var(--primary);
            box-shadow: 0 0 0 2px rgba(212, 38, 40, 0.3);
        }

        .icon-input {
            position: relative;
        }

        .icon-input input {
            padding-left: 48px;
        }

        .icon-input .icon {
            position: absolute;
            left: 16px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--primary);
            font-size: 1.2rem;
        }

        button {
            width: 100%;
            padding: 16px;
            background: var(--gradient-primary);
            border: none;
            border-radius: var(--radius-md);
            color: var(--light);
            font-weight: 700;
            font-size: 1.1rem;
            cursor: pointer;
            position: relative;
            overflow: hidden;
            transition: all var(--transition-normal);
            box-shadow: var(--shadow-md);
        }

        button:hover, button:focus {
            background: var(--primary);
            box-shadow: var(--shadow-lg);
        }

        button:active {
            transform: translateY(2px);
        }

        button:disabled {
            background: var(--gray);
            cursor: not-allowed;
        }

        /* Balance Display */
        .balance-display {
            background: var(--gradient-primary);
            padding: 25px;
            border-radius: var(--radius-md);
            margin-bottom: 25px;
            color: var(--light);
            position: relative;
            overflow: hidden;
            box-shadow: var(--shadow-md);
        }

        .balance-display::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle, rgba(255, 255, 255, 0.2) 0%, transparent 70%);
            transform: rotate(45deg);
            animation: shine 5s infinite;
        }

        .balance-label {
            font-size: 1rem;
            opacity: 0.9;
            margin-bottom: 5px;
        }

        .balance-amount {
            font-size: 2.5rem;
            font-weight: 700;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
            letter-spacing: 0.05em;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .balance-amount .currency {
            font-size: 1.5rem;
            margin-right: 8px;
            opacity: 0.8;
        }

        .balance-card {
            position: relative;
            padding-bottom: 25px;
            z-index: 1;
        }

        .balance-card-pattern {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            opacity: 0.1;
            z-index: -1;
            background-image: repeating-linear-gradient(45deg, rgba(255, 255, 255, 0.1) 0, rgba(255, 255, 255, 0.1) 2px, transparent 0, transparent 8px);
        }

        .balance-actions {
            display: flex;
            justify-content: space-between;
            margin-top: 15px;
            gap: 12px;
        }

        .balance-action-btn {
            flex: 1;
            font-size: 0.9rem;
            padding: 12px;
            border-radius: var(--radius-md);
            border: 1px solid rgba(255, 255, 255, 0.3);
            background: rgba(255, 255, 255, 0.2);
            transition: all var(--transition-normal);
        }

        .balance-action-btn:hover, .balance-action-btn:focus {
            background: rgba(255, 255, 255, 0.3);
        }

        @keyframes shine {
            0% { transform: translate(-100%, -100%) rotate(45deg); }
            100% { transform: translate(100%, 100%) rotate(45deg); }
        }

        .status {
            padding: 6px 12px;
            border-radius: var(--radius-full);
            display: inline-block;
            font-weight: 600;
            font-size: 0.9rem;
            margin-top: 5px;
            text-align: center;
        }

        .status.pending {
            background: var(--warning);
            color: var(--dark);
        }

        .status.approved {
            background: var(--success);
            color: var(--light);
        }

        .status.rejected {
            background: var(--error);
            color: var(--light);
        }

        /* Transaction History */
        .history-header {
            background: rgba(255, 255, 255, 0.1);
            padding: 18px;
            border-radius: var(--radius-md);
            margin-bottom: 20px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            font-size: 0.95rem;
            color: var(--light);
        }

        .history-summary {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin-top: 15px;
        }

        .summary-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .summary-label {
            color: var(--gray-light);
        }

        .summary-value {
            font-weight: 600;
        }

        .value-in {
            color: var(--success);
        }

        .value-out {
            color: var(--error);
        }

        .history-item {
            padding: 18px;
            border-radius: var(--radius-md);
            margin-bottom: 15px;
            font-size: 0.95rem;
            background: rgba(255, 255, 255, 0.07);
            border: 1px solid rgba(255, 255, 255, 0.1);
            position: relative;
            transition: transform var(--transition-normal), box-shadow var(--transition-normal);
        }

        .history-item:active {
            transform: scale(0.98);
            box-shadow: var(--shadow-sm);
        }

        .history-item.out {
            border-left: 4px solid var(--error);
        }

        .history-item.in {
            border-left: 4px solid var(--success);
        }

        .transaction-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }

        .transaction-date {
            font-size: 0.85rem;
            color: var(--gray-light);
        }

        .transaction-amount {
            font-weight: 700;
            font-size: 1.2rem;
        }

        .transaction-amount.out {
            color: var(--error);
        }

        .transaction-amount.in {
            color: var(--success);
        }

        .transaction-detail {
            display: flex;
            justify-content: space-between;
            margin-top: 10px;
            font-size: 0.9rem;
        }

        .transaction-detail-label {
            color: var(--gray-light);
        }

        .transaction-detail-value {
            font-weight: 600;
        }

        .transaction-note {
            margin-top: 10px;
            padding-top: 10px;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
            font-style: italic;
            color: var(--gray-light);
        }

        .history-item .print-btn {
            position: absolute;
            bottom: 12px;
            right: 12px;
            width: 36px;
            height: 36px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            background: rgba(255, 255, 255, 0.1);
            border: none;
            color: var(--light);
            cursor: pointer;
            transition: all var(--transition-normal);
        }

        .history-item .print-btn:hover {
            background: rgba(255, 255, 255, 0.2);
            transform: scale(1.1);
        }

        /* Transfer Animation */
        .transfer-animation {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: var(--primary);
            color: var(--light);
            padding: 30px;
            border-radius: var(--radius-lg);
            text-align: center;
            font-size: 1.2rem;
            font-weight: 600;
            z-index: 10000;
            animation: popIn 0.5s ease forwards;
            box-shadow: var(--shadow-lg);
        }

        .transfer-loading {
            display: flex;
            flex-direction: column;
            align-items: center;
            margin-top: 20px;
        }

        .loading-spinner {
            width: 40px;
            height: 40px;
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-top: 4px solid var(--light);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .success-animation {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: var(--success);
            color: var(--light);
            padding: 30px;
            border-radius: var(--radius-lg);
            text-align: center;
            font-size: 1.5rem;
            font-weight: 700;
            z-index: 10001;
            animation: popIn 0.5s ease forwards, fadeOut 1s ease 4s forwards;
            box-shadow: var(--shadow-lg);
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .success-animation .checkmark {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            background: var(--light);
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 20px;
            position: relative;
            animation: scaleCheckmark 0.5s ease-out 0.5s forwards;
            transform: scale(0);
        }

        .success-animation .checkmark::before {
            content: '';
            width: 40px;
            height: 20px;
            border-bottom: 4px solid var(--success);
            border-right: 4px solid var(--success);
            transform: rotate(45deg) translate(-5%, -10%);
            opacity: 0;
            animation: drawCheckmark 0.3s ease 1s forwards;
        }

        @keyframes scaleCheckmark {
            0% { transform: scale(0); }
            50% { transform: scale(1.2); }
            100% { transform: scale(1); }
        }

        @keyframes drawCheckmark {
            0% { opacity: 0; }
            100% { opacity: 1; }
        }

        /* Receipt */
        .receipt-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(5, 20, 65, 0.9);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 10001;
            backdrop-filter: blur(5px);
        }

        .receipt-content {
            width: 90%;
            max-width: 400px;
            display: flex;
            flex-direction: column;
            align-items: center;
            animation: slideUpReceipt 0.5s ease forwards;
        }

        @keyframes slideUpReceipt {
            0% { transform: translateY(50px); opacity: 0; }
            100% { transform: translateY(0); opacity: 1; }
        }

        .receipt {
            width: 100%;
            background: var(--light);
            border-radius: var(--radius-lg);
            overflow: hidden;
            box-shadow: var(--shadow-lg);
            color: var(--dark);
            position: relative;
        }

        .receipt::before, .receipt::after {
            content: '';
            position: absolute;
            left: 0;
            width: 100%;
            height: 15px;
            background-image: radial-gradient(circle at 10px -5px, transparent 12px, var(--light) 12px);
            background-size: 20px 20px;
            background-repeat: repeat-x;
        }

        .receipt::before {
            top: -8px;
        }

        .receipt::after {
            bottom: -8px;
            transform: rotate(180deg);
        }

        .receipt-header {
            background: var(--primary);
            padding: 20px;
            text-align: center;
            position: relative;
        }

        .receipt-header::after {
            content: '';
            position: absolute;
            bottom: -2px;
            left: 0;
            width: 100%;
            height: 4px;
            background-image: repeating-linear-gradient(45deg, var(--primary-dark), var(--primary-dark) 10px, var(--primary) 10px, var(--primary) 20px);
        }

        .receipt-logo {
            width: 70px;
            height: 70px;
            background: var(--light);
            border-radius: 50%;
            margin: 0 auto;
            padding: 15px;
            margin-bottom: 10px;
        }

        .receipt-logo img {
            width: 100%;
            height: 100%;
            object-fit: contain;
        }

        .receipt-title {
            color: var(--light);
            font-size: 1.5rem;
            margin-bottom: 5px;
        }

        .receipt-subtitle {
            color: rgba(255, 255, 255, 0.8);
            font-size: 0.9rem;
        }

        .receipt-body {
            padding: 20px;
        }

        .receipt-detail {
            display: flex;
            justify-content: space-between;
            padding: 12px 0;
            border-bottom: 1px dashed var(--gray-light);
        }

        .receipt-detail:last-child {
            border-bottom: none;
        }

        .detail-label {
            color: var(--gray-dark);
            font-weight: 500;
        }

        .detail-value {
            font-weight: 600;
            text-align: right;
        }

        .receipt-amount {
            background: rgba(212, 38, 40, 0.1);
            border-radius: var(--radius-md);
            padding: 15px;
            margin: 20px 0;
            text-align: center;
        }

        .amount-label {
            font-size: 0.9rem;
            color: var(--primary);
            margin-bottom: 5px;
        }

        .amount-value {
            font-size: 2rem;
            font-weight: 700;
            color: var(--primary);
        }

        .receipt-footer {
            text-align: center;
            padding: 20px;
            background: #f8f9fa;
            border-top: 1px solid #eaeaea;
        }

        .receipt-note {
            font-size: 0.85rem;
            color: var(--gray-dark);
            font-style: italic;
            margin-bottom: 10px;
        }

        .receipt-qr {
            width: 120px;
            height: 120px;
            margin: 0 auto;
            background: var(--light);
            padding: 10px;
            border-radius: var(--radius-sm);
            box-shadow: var(--shadow-sm);
        }

        .receipt-qr img {
            width: 100%;
            height: 100%;
        }

        .receipt-watermark {
            font-size: 0.8rem;
            color: var(--gray);
            text-align: center;
            margin-top: 15px;
        }

        .action-buttons {
            display: flex;
            gap: 15px;
            margin-top: 25px;
            width: 100%;
        }

        .action-buttons button {
            flex: 1;
            padding: 14px;
        }

        .download-btn {
            background: var(--success);
        }

        .close-btn {
            background: var(--gray-dark);
        }

        /* Menu Bar */
        .menu {
            display: flex;
            justify-content: space-around;
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100%;
            background: rgba(19, 17, 26, 0.9);
            padding: 15px 5px;
            box-shadow: 0 -4px 20px rgba(0, 0, 0, 0.4);
            z-index: 100;
            backdrop-filter: blur(12px);
            border-top: 1px solid rgba(255, 255, 255, 0.1);
        }

        .menu-button {
            flex: 1;
            margin: 0 5px;
            display: flex;
            flex-direction: column;
            align-items: center;
            background: transparent;
            border: none;
            color: var(--gray);
            font-size: 0.8rem;
            padding: 10px;
            border-radius: var(--radius-md);
            position: relative;
            box-shadow: none;
        }

        .menu-button.active {
            color: var(--primary);
            font-weight: 600;
        }

        .menu-button::after {
            content: '';
            position: absolute;
            bottom: -5px;
            width: 0;
            height: 3px;
            border-radius: var(--radius-full);
            background: var(--primary);
            transition: width var(--transition-normal);
        }

        .menu-button.active::after {
            width: 40%;
        }

        .menu-icon {
            font-size: 1.5rem;
            margin-bottom: 5px;
        }

        /* Error Message */
        .error-message {
            color: var(--error);
            text-align: center;
            margin-top: 12px;
            font-weight: 600;
            font-size: 0.9rem;
        }

        /* Responsive */
        @media (max-width: 480px) {
            .intro-logo-wrapper {
                width: 180px;
                height: 180px;
            }

            .intro-logo {
                width: 150px;
                height: 150px;
            }

            .intro-text {
                font-size: 2rem;
            }

            .balance-amount {
                font-size: 2rem;
            }

            h2 {
                font-size: 1.8rem;
            }

            .download-bar p {
                font-size: 0.9rem;
            }

            .container {
                padding: 20px;
                margin-top: 120px;
            }

            .action-buttons {
                flex-direction: column;
                gap: 10px;
            }
        }

        /* Utility Classes */
        .hidden {
            display: none;
        }

        .mt-5 {
            margin-top: 5px;
        }

        .mt-10 {
            margin-top: 10px;
        }

        .mt-15 {
            margin-top: 15px;
        }

        .mt-20 {
            margin-top: 20px;
        }

        /* Animation for Message Alerts */
        .message-alert {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            padding: 15px 25px;
            border-radius: var(--radius-full);
            color: var(--light);
            font-weight: 600;
            box-shadow: var(--shadow-lg);
            z-index: 10000;
            animation: alertSlideDown 0.3s ease forwards, alertFadeOut 0.3s ease 3s forwards;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .alert-success {
            background: var(--success);
        }

        .alert-error {
            background: var(--error);
        }

        .alert-info {
            background: var(--info);
        }

        .alert-warning {
            background: var(--warning);
        }

        @keyframes alertSlideDown {
            0% { transform: translate(-50%, -100%); opacity: 0; }
            100% { transform: translate(-50%, 0); opacity: 1; }
        }

        @keyframes alertFadeOut {
            0% { opacity: 1; }
            100% { opacity: 0; visibility: hidden; }
        }
    </style>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700;800&family=Playfair+Display:wght@700&display=swap" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Padauk:wght@400;700&family=Pyidaungsu:wght@400;700&display=swap" rel="stylesheet">
</head>
<body>
    <!-- Intro Animation -->
    <div class="intro-container" id="intro-container">
        <div class="intro-logo-wrapper">
            <div class="intro-logo-circle"></div>
            <img class="intro-logo" src="https://github.com/Opper125/opper-payment/raw/main/logo.png" alt="OPPER+ Logo">
        </div>
        <div class="intro-text">
            <span class="primary">KPAY+</span> Premium
        </div>
        <div class="intro-tagline">ဘယ်နေရာမှာမဆို ငွေပေးချေနိုင်သော စနစ်</div>
    </div>

    <!-- Download APK Bar -->
    <div class="download-bar" id="download-bar">
        <p>KPAY+ App ကိုရယူပြီး အကောင်းဆုံးအတွေ့အကြုံကို ခံစားလိုက်ပါ။</p>
        <div style="display: flex; align-items: center; gap: 10px;">
            <button onclick="downloadApk()">ဒေါင်းလုပ်ဆွဲမည်</button>
            <button class="close-btn" onclick="hideDownloadBar()"><i class="fas fa-times"></i></button>
        </div>
    </div>

    <!-- Background Particles -->
    <div class="particles-container" id="particles-container"></div>

    <!-- Logo and ID Badge -->
    <div class="logo-header">
        <img class="logo" src="https://github.com/Opper125/opper-payment/raw/main/logo.png" alt="OPPER+ Logo">
        <div class="id-badge" id="id-badge">ID: ဖော်ပြထားခြင်းမရှိသေးပါ</div>
    </div>

    <!-- Wallet Section -->
    <div id="wallet" class="container active">
        <h2>ငွေအိတ်</h2>
        
        <div class="balance-card">
            <div class="balance-display">
                <div class="balance-card-pattern"></div>
                <div class="balance-label">လက်ကျန်ငွေ</div>
                <div class="balance-amount">
                    <span class="currency">Ks</span>
                    <span id="balance">0</span>
                </div>
                <div class="balance-actions">
                    <button class="balance-action-btn" onclick="showTopupOptions()">ငွေဖြည့်မည်</button>
                    <button class="balance-action-btn" onclick="toggleTransfer()">ငွေလွှဲမည်</button>
                </div>
            </div>
            <div id="wallet-status-container" class="mt-5" style="text-align: center;">
                <span id="wallet-status" class="status pending">အကောင့်အတည်ပြုရန်လိုအပ်နေသည်</span>
            </div>
        </div>
        
        <div id="transfer" class="form-group hidden">
            <h3 style="text-align: center; margin-bottom: 20px;">ငွေလွှဲခြင်း</h3>
            
            <label>လက်ခံမည့်ဖုန်းနံပါတ်</label>
            <div class="icon-input">
                <i class="fas fa-phone icon"></i>
                <input type="tel" id="transfer-phone" placeholder="09xxxxxxxxx" required oninput="checkPhone()">
            </div>
            <p id="receiver-name" class="mt-5" style="font-weight: 600;"></p>
            
            <label class="mt-15">ငွေပမာဏ (ကျပ်)</label>
            <div class="icon-input">
                <i class="fas fa-money-bill-wave icon"></i>
                <input type="number" id="transfer-amount" placeholder="1,000,000 ကျပ်အထိ" required>
            </div>
            
            <label class="mt-15">မှတ်ချက်</label>
            <div class="icon-input">
                <i class="fas fa-sticky-note icon"></i>
                <input type="text" id="transfer-note" placeholder="မှတ်ချက် (ထည့်လိုက မထည့်လိုက ရပါသည်)">
            </div>
            
            <label class="mt-15">လုံခြုံရေးပင်နံပါတ် (၆ လုံး)</label>
            <div class="icon-input">
                <i class="fas fa-lock icon"></i>
                <input type="password" id="transfer-pin" maxlength="6" placeholder="၆ လုံးပင်နံပါတ်ထည့်ပါ" required>
            </div>
            
            <div class="mt-20">
                <button id="confirm-transfer-btn">ငွေလွှဲမည်</button>
            </div>
            <button class="mt-10" style="background: var(--gray-dark);" onclick="toggleTransfer()">နောက်သို့</button>
            <p id="transfer-error" class="error-message hidden"></p>
        </div>
    </div>

    <!-- Transaction History Section -->
    <div id="history" class="container">
        <h2>ငွေသွင်း/ထုတ် မှတ်တမ်း</h2>
        
        <div class="history-header">
            <select id="month-filter" onchange="loadHistory()">
                <option value="current">လက်ရှိလ</option>
                <option value="previous">ပြီးခဲ့သောလ</option>
                <option value="all">အားလုံး</option>
            </select>
            
            <div class="history-summary">
                <div class="summary-row">
                    <span class="summary-label">ရရှိခဲ့သော စုစုပေါင်း</span>
                    <span class="summary-value value-in" id="total-in">0 ကျပ်</span>
                </div>
                <div class="summary-row">
                    <span class="summary-label">ပို့ခဲ့သော စုစုပေါင်း</span>
                    <span class="summary-value value-out" id="total-out">0 ကျပ်</span>
                </div>
            </div>
        </div>
        
        <div id="history-list" style="overflow-y: auto;"></div>
    </div>

    <!-- Profile Section -->
    <div id="profile" class="container">
        <h2>ကိုယ်ရေးအချက်အလက်</h2>
        
        <div class="form-group">
            <p style="margin-bottom: 10px;">သင့်အိုင်ဒီ: <span id="profile-id" style="font-weight: 600;"></span></p>
            <p id="profile-status-container" style="margin-bottom: 20px; text-align: center;">
                <span id="profile-status" class="status pending">အကောင့်အတည်ပြုရန်လိုအပ်နေသည်</span>
            </p>
            
            <div id="passport-form" class="form-group">
                <h3 style="text-align: center; margin-bottom: 20px;">အကောင့်အတည်ပြုရန် အချက်အလက်များ</h3>
                
                <label>သက်သေခံကတ်ပြားအမှတ်</label>
                <div class="icon-input">
                    <i class="fas fa-id-card icon"></i>
                    <input type="text" id="passport-number" placeholder="သက်သေခံကတ်ပြားအမှတ်ထည့်ပါ" required>
                </div>
                
                <label class="mt-15">နေရပ်လိပ်စာ</label>
                <div class="icon-input">
                    <i class="fas fa-home icon"></i>
                    <input type="text" id="address" placeholder="နေရပ်လိပ်စာထည့်ပါ" required>
                </div>
                
                <label class="mt-15">ဖုန်းနံပါတ် (09xxxxxxxxx)</label>
                <div class="icon-input">
                    <i class="fas fa-phone icon"></i>
                    <input type="tel" id="phone" placeholder="09xxxxxxxxx" required>
                </div>
                
                <label class="mt-15">လုံခြုံရေးပင်နံပါတ် (၆ လုံး)</label>
                <div class="icon-input">
                    <i class="fas fa-lock icon"></i>
                    <input type="password" id="payment-pin" maxlength="6" placeholder="၆ လုံးပင်နံပါတ်ထည့်ပါ" required>
                </div>
                
                <label class="mt-15">သက်သေခံကတ်ပြား ဓာတ်ပုံ</label>
                <input type="file" id="passport-image" accept="image/*" required>
                
                <label class="mt-15">သက်သေခံကတ်ပြားနှင့်အတူ ကိုယ်တိုင်ဓာတ်ပုံ</label>
                <input type="file" id="selfie-image" accept="image/*" required>
                
                <button id="submit-passport-btn" class="mt-20">တင်သွင်းမည်</button>
            </div>
            
            <div id="passport-submitted" class="hidden" style="background: rgba(255, 255, 255, 0.1); padding: 20px; border-radius: var(--radius-md); margin-top: 20px;">
                <h3 style="text-align: center; margin-bottom: 15px;">တင်သွင်းပြီးပါပြီ</h3>
                <p style="margin-bottom: 10px;">ဖုန်းနံပါတ်: <span id="submitted-phone" style="font-weight: 600;"></span></p>
                <p style="margin-bottom: 10px;">သက်သေခံကတ်ပြားအမှတ်: <span id="submitted-passport" style="font-weight: 600;"></span></p>
                <p style="margin-bottom: 10px;">နေရပ်လိပ်စာ: <span id="submitted-address" style="font-weight: 600;"></span></p>
                <p>တင်သွင်းသည့်အချိန်: <span id="submitted-time" style="font-weight: 600;"></span></p>
            </div>
        </div>
    </div>

    <!-- Services Section -->
    <div id="services" class="container">
        <h2>ဝန်ဆောင်မှုများ</h2>
        
        <div class="services-grid" style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px; margin-top: 15px;">
            <button style="display: flex; flex-direction: column; align-items: center; height: 120px; justify-content: center;" onclick="showService('mobile-topup')">
                <i class="fas fa-mobile-alt" style="font-size: 2rem; margin-bottom: 10px;"></i>
                ဖုန်းငွေဖြည့်ရန်
            </button>
            
            <button style="display: flex; flex-direction: column; align-items: center; height: 120px; justify-content: center;" onclick="showService('bill-payment')">
                <i class="fas fa-file-invoice" style="font-size: 2rem; margin-bottom: 10px;"></i>
                ဘေလ်ပေးချေရန်
            </button>
            
            <button style="display: flex; flex-direction: column; align-items: center; height: 120px; justify-content: center;" onclick="showService('game-topup')">
                <i class="fas fa-gamepad" style="font-size: 2rem; margin-bottom: 10px;"></i>
                ဂိမ်းငွေဖြည့်ရန်
            </button>
            
            <button style="display: flex; flex-direction: column; align-items: center; height: 120px; justify-content: center;" onclick="showService('merchant')">
                <i class="fas fa-store" style="font-size: 2rem; margin-bottom: 10px;"></i>
                ဆိုင်များ
            </button>
        </div>
        
        <div id="service-details" class="hidden" style="margin-top: 25px;">
            <h3 id="service-title" style="text-align: center; margin-bottom: 20px;"></h3>
            <div id="service-content"></div>
            <button style="background: var(--gray-dark); margin-top: 20px;" onclick="hideServiceDetails()">နောက်သို့</button>
        </div>
    </div>

    <!-- Receipt Overlay -->
    <div class="receipt-overlay" id="receipt-overlay">
        <div class="receipt-content">
            <div class="receipt" id="receipt-container">
                <div class="receipt-header">
                    <div class="receipt-logo">
                        <img src="https://i.imgur.com/Yt7QeLf.png" alt="OPPER+ Logo">
                    </div>
                    <div class="receipt-title">ငွေလွှဲပြေစာ</div>
                    <div class="receipt-subtitle">အတည်ပြုပြီး</div>
                </div>
                
                <div class="receipt-body" id="receipt-details">
                    <!-- Content will be dynamically filled -->
                </div>
                
                <div class="receipt-footer">
                    <div class="receipt-note">ဤငွေလွှဲပြေစာသည် တရားဝင်အတည်ပြုပြီးဖြစ်ပါသည်</div>
                    <div class="receipt-qr">
                        <img id="receipt-qr-code" src="https://api.qrserver.com/v1/create-qr-code/?data=placeholder&size=150x150" alt="QR Code">
                    </div>
                    <div class="receipt-watermark">OPPER+ Premium Payment System</div>
                </div>
            </div>
            
            <div class="action-buttons">
                <button class="download-btn" onclick="downloadReceipt()">
                    <i class="fas fa-download" style="margin-right: 8px;"></i> ဒေါင်းလုပ်ဆွဲမည်
                </button>
                <button class="close-btn" onclick="closeReceipt()">
                    <i class="fas fa-times" style="margin-right: 8px;"></i> ပိတ်မည်
                </button>
            </div>
        </div>
    </div>

    <!-- Menu Bar -->
    <div class="menu">
        <button class="menu-button active" onclick="showSection('wallet')" id="wallet-btn">
            <i class="fas fa-wallet menu-icon"></i>
            ငွေအိတ်
        </button>
        <button class="menu-button" onclick="showSection('history')" id="history-btn">
            <i class="fas fa-history menu-icon"></i>
            မှတ်တမ်း
        </button>
        <button class="menu-button" onclick="showSection('services')" id="services-btn">
            <i class="fas fa-th-large menu-icon"></i>
            ဝန်ဆောင်မှု
        </button>
        <button class="menu-button" onclick="showSection('profile')" id="profile-btn">
            <i class="fas fa-user menu-icon"></i>
            ပရိုဖိုင်
        </button>
    </div>

    <!-- Hidden elements for generation -->
    <div style="display: none;" id="photo-content"></div>

    <!-- Audio Elements -->
    <audio id="transfer-sent-sound" src="https://soundbible.com/mp3/accomplished-579.mp3" preload="auto"></audio>
    <audio id="transfer-received-sound" src="https://soundbible.com/mp3/accomplished-579.mp3" preload="auto"></audio>
    <audio id="notification-sound" src="https://soundbible.com/mp3/ping-82822.mp3" preload="auto"></audio>

    <!-- Loading Libraries -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    
    <script>
        // Initialize Supabase Client
        const supabaseUrl = 'https://vtsczzlnhsrgnbkfyizi.supabase.co';
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZ0c2N6emxuaHNyZ25ia2Z5aXppIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDI2ODYwODMsImV4cCI6MjA1ODI2MjA4M30.LjP2g0WXgg6FVTM5gPIkf_qlXakkj8Hf5xzXVsx7y68';
        const supabase = window.supabase.createClient(supabaseUrl, supabaseKey, { fetch: (...args) => fetch(...args) });
        
        // Global variables
        let currentUser = { user_id: null, balance: 0, passport_status: 'pending', phone: null };
        let allowTransfers = true;
        let currentTransactionId = null;
        
        // Create background particles
        function createParticles() {
            const container = document.getElementById('particles-container');
            const particleCount = 20;
            
            for (let i = 0; i < particleCount; i++) {
                const particle = document.createElement('div');
                particle.className = 'particle';
                
                // Random size between 5px and 20px
                const size = Math.random() * 15 + 5;
                particle.style.width = `${size}px`;
                particle.style.height = `${size}px`;
                
                // Random position
                const posX = Math.random() * 100;
                particle.style.left = `${posX}%`;
                particle.style.bottom = `-${size}px`;
                
                // Random speed between 30s and 60s
                const duration = Math.random() * 30 + 30;
                particle.style.animationDuration = `${duration}s`;
                
                // Add to container
                container.appendChild(particle);
            }
        }
        
        // Format currency
        function formatCurrency(amount) {
            return new Intl.NumberFormat('my-MM').format(amount);
        }
        
        // Format date
        function formatDate(dateString) {
            const date = new Date(dateString);
            return date.toLocaleString('my-MM', {
                year: 'numeric',
                month: 'short',
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });
        }
        
        // Show message alert
        function showAlert(message, type = 'success') {
            const alert = document.createElement('div');
            alert.className = `message-alert alert-${type}`;
            
            let icon = '';
            switch(type) {
                case 'success':
                    icon = '<i class="fas fa-check-circle"></i>';
                    break;
                case 'error':
                    icon = '<i class="fas fa-exclamation-circle"></i>';
                    break;
                case 'info':
                    icon = '<i class="fas fa-info-circle"></i>';
                    break;
                case 'warning':
                    icon = '<i class="fas fa-exclamation-triangle"></i>';
                    break;
            }
            
            alert.innerHTML = `${icon} ${message}`;
            document.body.appendChild(alert);
            
            setTimeout(() => {
                alert.remove();
            }, 3500);
            
            document.getElementById('notification-sound').play();
        }
        
        // Retry operation with backoff
        async function retryOperation(operation, maxRetries = 3, delay = 1000) {
            for (let i = 0; i < maxRetries; i++) {
                try {
                    return await operation();
                } catch (error) {
                    if (i === maxRetries - 1) throw error;
                    console.warn(`Retry ${i + 1}/${maxRetries} failed: ${error.message}`);
                    await new Promise(resolve => setTimeout(resolve, delay));
                }
            }
        }
        
        // Initialize user
        async function initializeUser() {
            try {
                let userId = localStorage.getItem('userId');
                if (!userId) {
                    userId = Math.floor(100000 + Math.random() * 900000).toString();
                    
                    await retryOperation(async () => {
                        const { data: existingUser, error } = await supabase
                            .from('users')
                            .select('user_id')
                            .eq('user_id', userId)
                            .single();
                        
                        if (error && error.code !== 'PGRST116') throw new Error(`Check ID Error: ${error.message}`);
                        if (existingUser) throw new Error('Duplicate ID');
                    });
                    
                    await retryOperation(async () => {
                        const { error: insertError } = await supabase
                            .from('users')
                            .insert({ user_id: userId, balance: 0, passport_status: 'pending' });
                        
                        if (insertError) throw new Error(`Insert User Error: ${insertError.message}`);
                    });
                    
                    localStorage.setItem('userId', userId);
                }
                
                currentUser.user_id = userId;
                document.getElementById('id-badge').textContent = `ID: ${userId}`;
                document.getElementById('profile-id').textContent = userId;
                
                await retryOperation(async () => {
                    const { data: user, error } = await supabase
                        .from('users')
                        .select('*')
                        .eq('user_id', userId)
                        .single();
                    
                    if (error && error.code !== 'PGRST116') throw new Error(`Fetch User Error: ${error.message}`);
                    if (user) currentUser = user;
                });
                
                document.getElementById('balance').textContent = formatCurrency(currentUser.balance);
                updateStatus(currentUser.passport_status);
                
                await checkTransferSettings();
                await loadHistory();
                
                // Set up real-time subscriptions
                setupRealtimeSubscriptions(userId);
                
                createParticles();
                
            } catch (error) {
                console.error('Initialize User Error:', error.message);
                showAlert(`အကောင့်ဖွင့်ရာတွင် အမှားရှိနေပါသည်: ${error.message}`, 'error');
            }
        }
        
        // Set up realtime subscriptions
        function setupRealtimeSubscriptions(userId) {
            // User updates
            supabase.channel('users-channel')
                .on('postgres_changes', 
                    { event: '*', schema: 'public', table: 'users', filter: `user_id=eq.${userId}` }, 
                    payload => {
                        currentUser = { ...currentUser, ...payload.new };
                        document.getElementById('balance').textContent = formatCurrency(currentUser.balance);
                        updateStatus(currentUser.passport_status);
                    }
                )
                .subscribe();
            
            // Transaction updates
            supabase.channel('transactions-channel')
                .on('postgres_changes', 
                    { event: 'INSERT', schema: 'public', table: 'transactions' }, 
                    async payload => {
                        const transaction = payload.new;
                        
                        // Only show notification for receiving money
                        if (transaction.to_user_id === currentUser.user_id && 
                            transaction.from_user_id !== currentUser.user_id) {
                            
                            showAlert(`${formatCurrency(transaction.amount)} ကျပ် လက်ခံရရှိပါသည်`, 'success');
                            document.getElementById('transfer-received-sound').play();
                            
                            // Reload history if history tab is active
                            if (document.getElementById('history').classList.contains('active')) {
                                await loadHistory();
                            }
                        }
                    }
                )
                .subscribe();
        }
        
        // Check transfer settings
        async function checkTransferSettings() {
            try {
                const { data, error } = await supabase
                    .from('settings')
                    .select('allow_transfers')
                    .single();
                
                if (error) throw new Error(`Fetch Settings Error: ${error.message}`);
                allowTransfers = data.allow_transfers;
                
                const transferBtn = document.getElementById('transfer-btn');
                transferBtn.disabled = !allowTransfers || currentUser.passport_status !== 'approved';
                
            } catch (error) {
                console.error('Check Transfer Settings Error:', error.message);
                allowTransfers = false;
            }
        }
        
        // Update status display
        function updateStatus(status) {
            const walletStatus = document.getElementById('wallet-status');
            const profileStatus = document.getElementById('profile-status');
            const passportForm = document.getElementById('passport-form');
            const passportSubmitted = document.getElementById('passport-submitted');
            const transferBtn = document.getElementById('transfer-btn');
            
            walletStatus.className = `status ${status}`;
            profileStatus.className = `status ${status}`;
            
            switch(status) {
                case 'pending':
                    walletStatus.textContent = 'အကောင့်အတည်ပြုရန်လိုအပ်နေသည်';
                    profileStatus.textContent = 'အကောင့်အတည်ပြုရန်လိုအပ်နေသည်';
                    passportForm.classList.remove('hidden');
                    passportSubmitted.classList.add('hidden');
                    transferBtn.disabled = true;
                    break;
                case 'approved':
                    walletStatus.textContent = 'အကောင့်အတည်ပြုပြီး';
                    profileStatus.textContent = 'အကောင့်အတည်ပြုပြီး';
                    passportForm.classList.add('hidden');
                    passportSubmitted.classList.remove('hidden');
                    transferBtn.disabled = !allowTransfers;
                    
                    // Update submitted info
                    if (currentUser.phone) {
                        document.getElementById('submitted-phone').textContent = currentUser.phone;
                        document.getElementById('submitted-passport').textContent = currentUser.passport_number || 'N/A';
                        document.getElementById('submitted-address').textContent = currentUser.address || 'N/A';
                        document.getElementById('submitted-time').textContent = formatDate(currentUser.updated_at);
                    }
                    break;
                case 'rejected':
                    walletStatus.textContent = 'အကောင့်ငြင်းပယ်ခံရပါသည်';
                    profileStatus.textContent = 'အကောင့်ငြင်းပယ်ခံရပါသည်';
                    passportForm.classList.remove('hidden');
                    passportSubmitted.classList.add('hidden');
                    transferBtn.disabled = true;
                    break;
            }
        }
        
        // Show a specific section
        function showSection(sectionId) {
            ['wallet', 'history', 'services', 'profile'].forEach(id => {
                document.getElementById(id).classList.toggle('active', id === sectionId);
                document.getElementById(`${id}-btn`).classList.toggle('active', id === sectionId);
            });
            
            // If switching to history, reload it
            if (sectionId === 'history') {
                loadHistory();
            }
            
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }
        
        // Toggle transfer form
        function toggleTransfer() {
            const transferSection = document.getElementById('transfer');
            transferSection.classList.toggle('hidden');
            
            // Clear form if closing
            if (transferSection.classList.contains('hidden')) {
                document.getElementById('transfer-phone').value = '';
                document.getElementById('transfer-amount').value = '';
                document.getElementById('transfer-note').value = '';
                document.getElementById('transfer-pin').value = '';
                document.getElementById('receiver-name').textContent = '';
                document.getElementById('transfer-error').classList.add('hidden');
            }
        }
        
        // Check phone number for receiver info
        async function checkPhone() {
            const phoneInput = document.getElementById('transfer-phone');
            const receiverName = document.getElementById('receiver-name');
            
            if (phoneInput.value.length < 9) {
                receiverName.textContent = '';
                return;
            }
            
            try {
                const { data, error } = await supabase
                    .from('users')
                    .select('user_id, phone, passport_status')
                    .eq('phone', phoneInput.value)
                    .single();
                
                if (error && error.code !== 'PGRST116') {
                    receiverName.textContent = '';
                    return;
                }
                
                if (data) {
                    if (data.user_id === currentUser.user_id) {
                        receiverName.textContent = '❌ ကိုယ့်ကိုယ်ကို ငွေလွှဲ၍မရပါ';
                        receiverName.style.color = 'var(--error)';
                    } else if (data.passport_status !== 'approved') {
                        receiverName.textContent = '❌ အကောင့်အတည်မပြုရသေးသော အသုံးပြုသူ';
                        receiverName.style.color = 'var(--error)';
                    } else {
                        receiverName.textContent = '✓ အသုံးပြုသူရှိပါသည်';
                        receiverName.style.color = 'var(--success)';
                    }
                } else {
                    receiverName.textContent = '❓ အသုံးပြုသူရှာမတွေ့ပါ';
                    receiverName.style.color = 'var(--warning)';
                }
            } catch (error) {
                console.error('Check Phone Error:', error.message);
                receiverName.textContent = '';
            }
        }
        
        // Load transaction history
        async function loadHistory() {
            try {
                const historyList = document.getElementById('history-list');
                historyList.innerHTML = '<div class="loading-spinner" style="margin: 30px auto;"></div>';
                
                const monthFilter = document.getElementById('month-filter').value;
                let startDate = new Date();
                
                if (monthFilter === 'previous') {
                    startDate.setMonth(startDate.getMonth() - 1);
                    startDate.setDate(1);
                } else if (monthFilter === 'current') {
                    startDate.setDate(1);
                } else {
                    // For 'all', go back 6 months
                    startDate.setMonth(startDate.getMonth() - 6);
                }
                
                const { data: transactions, error } = await supabase.rpc(
                    'get_transaction_history',
                    { p_user_id: currentUser.user_id }
                );
                
                if (error) throw new Error(`Fetch Transactions Error: ${error.message}`);
                
                // Calculate totals
                let totalIn = 0;
                let totalOut = 0;
                
                historyList.innerHTML = '';
                
                if (transactions.length === 0) {
                    historyList.innerHTML = `<div style="text-align: center; padding: 30px; color: var(--gray-light);">
                        <i class="fas fa-history" style="font-size: 3rem; margin-bottom: 15px; opacity: 0.5;"></i>
                        <p>မှတ်တမ်းများမရှိသေးပါ</p>
                    </div>`;
                }
                
                transactions.forEach(transaction => {
                    // Update totals
                    if (transaction.transaction_type === 'received') {
                        totalIn += transaction.amount;
                    } else {
                        totalOut += transaction.amount + transaction.fee;
                    }
                    
                    const item = document.createElement('div');
                    item.className = `history-item ${transaction.transaction_type === 'received' ? 'in' : 'out'}`;
                    
                    item.innerHTML = `
                        <div class="transaction-header">
                            <div class="transaction-type">
                                <i class="fas fa-${transaction.transaction_type === 'received' ? 'arrow-down' : 'arrow-up'}"></i>
                                ${transaction.transaction_type === 'received' ? 'ရရှိခဲ့သော' : 'ပို့ခဲ့သော'}
                            </div>
                            <div class="transaction-amount ${transaction.transaction_type === 'received' ? 'in' : 'out'}">
                                ${transaction.transaction_type === 'received' ? '+' : '-'} ${formatCurrency(transaction.amount)} ကျပ်
                            </div>
                        </div>
                        
                        <div class="transaction-date">
                            <i class="far fa-clock" style="margin-right: 5px;"></i> ${formatDate(transaction.created_at)}
                        </div>
                        
                        <div class="transaction-detail">
                            <span class="transaction-detail-label">
                                ${transaction.transaction_type === 'received' ? 'လွှဲပေးသူ' : 'လက်ခံသူ'}:
                            </span>
                            <span class="transaction-detail-value">
                                ${transaction.transaction_type === 'received' ? 
                                    (transaction.from_phone || 'အမည်မသိ') : 
                                    (transaction.to_phone || 'အမည်မသိ')}
                            </span>
                        </div>
                        
                        <div class="transaction-detail">
                            <span class="transaction-detail-label">အိုင်ဒီ:</span>
                            <span class="transaction-detail-value">${transaction.transaction_id}</span>
                        </div>
                        
                        ${transaction.fee > 0 ? `
                            <div class="transaction-detail">
                                <span class="transaction-detail-label">ဝန်ဆောင်ခ:</span>
                                <span class="transaction-detail-value">${formatCurrency(transaction.fee)} ကျပ်</span>
                            </div>
                        ` : ''}
                        
                        ${transaction.note ? `
                            <div class="transaction-note">
                                <i class="fas fa-sticky-note" style="margin-right: 5px;"></i> ${transaction.note}
                            </div>
                        ` : ''}
                        
                        <button class="print-btn" onclick="showReceipt('${transaction.transaction_id}', '${transaction.transaction_type}')">
                            <i class="fas fa-print"></i>
                        </button>
                    `;
                    
                    historyList.appendChild(item);
                });
                
                // Update totals display
                document.getElementById('total-in').textContent = `${formatCurrency(totalIn)} ကျပ်`;
                document.getElementById('total-out').textContent = `${formatCurrency(totalOut)} ကျပ်`;
                
            } catch (error) {
                console.error('Load History Error:', error.message);
                document.getElementById('history-list').innerHTML = `
                    <div style="text-align: center; padding: 20px; color: var(--error);">
                        <i class="fas fa-exclamation-circle" style="font-size: 2rem; margin-bottom: 10px;"></i>
                        <p>မှတ်တမ်းများ ရယူရာတွင် အမှားရှိပါသည်</p>
                    </div>
                `;
            }
        }
        
        // Hide download bar
        function hideDownloadBar() {
            document.getElementById('download-bar').style.display = 'none';
        }
        
        // Download APK
        function downloadApk() {
            alert('APK ဒေါင်းလုပ် စတင်ဆွဲယူနေပါပြီ');
            window.open('https://appsgeyser.io/18731061/OPPER-Payment', '_blank');
        }
        
        // Service section functions
        function showService(serviceId) {
            const serviceDetails = document.getElementById('service-details');
            const serviceTitle = document.getElementById('service-title');
            const serviceContent = document.getElementById('service-content');
            
            serviceDetails.classList.remove('hidden');
            
            switch(serviceId) {
                case 'mobile-topup':
                    serviceTitle.textContent = 'ဖုန်းငွေဖြည့်ဝန်ဆောင်မှု';
                    serviceContent.innerHTML = `
                        <div style="background: rgba(255, 255, 255, 0.1); padding: 20px; border-radius: var(--radius-md);">
                            <p style="text-align: center; margin-bottom: 20px;">ဝန်ဆောင်မှုကို အမြန်ဆုံး ပြန်လည်ရရှိနိုင်ရန် ဆောင်ရွက်နေပါသည်။</p>
                            <div style="text-align: center;">
                                <i class="fas fa-tools" style="font-size: 3rem; margin-bottom: 15px; color: var(--warning);"></i>
                                <p>ယခုလက်ရှိတွင် ပြင်ဆင်နေဆဲဖြစ်ပါသည်</p>
                            </div>
                        </div>
                    `;
                    break;
                case 'bill-payment':
                    serviceTitle.textContent = 'ဘေလ်ပေးချေခြင်း';
                    serviceContent.innerHTML = `
                        <div style="background: rgba(255, 255, 255, 0.1); padding: 20px; border-radius: var(--radius-md);">
                            <p style="text-align: center; margin-bottom: 20px;">ဝန်ဆောင်မှုကို အမြန်ဆုံး ပြန်လည်ရရှိနိုင်ရန် ဆောင်ရွက်နေပါသည်။</p>
                            <div style="text-align: center;">
                                <i class="fas fa-tools" style="font-size: 3rem; margin-bottom: 15px; color: var(--warning);"></i>
                                <p>ယခုလက်ရှိတွင် ပြင်ဆင်နေဆဲဖြစ်ပါသည်</p>
                            </div>
                        </div>
                    `;
                    break;
                case 'game-topup':
                    serviceTitle.textContent = 'ဂိမ်းငွေဖြည့်ခြင်း';
                    serviceContent.innerHTML = `
                        <div style="background: rgba(255, 255, 255, 0.1); padding: 20px; border-radius: var(--radius-md);">
                            <p style="text-align: center; margin-bottom: 20px;">ဝန်ဆောင်မှုကို အမြန်ဆုံး ပြန်လည်ရရှိနိုင်ရန် ဆောင်ရွက်နေပါသည်။</p>
                            <div style="text-align: center;">
                                <i class="fas fa-tools" style="font-size: 3rem; margin-bottom: 15px; color: var(--warning);"></i>
                                <p>ယခုလက်ရှိတွင် ပြင်ဆင်နေဆဲဖြစ်ပါသည်</p>
                            </div>
                        </div>
                    `;
                    break;
                case 'merchant':
                    serviceTitle.textContent = 'ပေးချေနိုင်သော ဆိုင်များ';
                    serviceContent.innerHTML = `
                        <div style="background: rgba(255, 255, 255, 0.1); padding: 20px; border-radius: var(--radius-md);">
                            <p style="text-align: center; margin-bottom: 20px;">ဝန်ဆောင်မှုကို အမြန်ဆုံး ပြန်လည်ရရှိနိုင်ရန် ဆောင်ရွက်နေပါသည်။</p>
                            <div style="text-align: center;">
                                <i class="fas fa-tools" style="font-size: 3rem; margin-bottom: 15px; color: var(--warning);"></i>
                                <p>ယခုလက်ရှိတွင် ပြင်ဆင်နေဆဲဖြစ်ပါသည်</p>
                            </div>
                        </div>
                    `;
                    break;
            }
        }
        
        function hideServiceDetails() {
            document.getElementById('service-details').classList.add('hidden');
        }
        
        // Show topup options
        function showTopupOptions() {
            showAlert('ဤဝန်ဆောင်မှုကို မကြာမီရရှိနိုင်ပါတော့မည်', 'info');
        }
        
        // Submit passport verification
        async function submitPassport() {
            const passportNumber = document.getElementById('passport-number').value;
            const address = document.getElementById('address').value;
            const phone = document.getElementById('phone').value;
            const pin = document.getElementById('payment-pin').value;
            const passportFile = document.getElementById('passport-image').files[0];
            const selfieFile = document.getElementById('selfie-image').files[0];
            
            if (!passportNumber || !address || !phone || !pin || !passportFile || !selfieFile) {
                showAlert('ကျေးဇူးပြု၍ အချက်အလက်အားလုံး ဖြည့်သွင်းပါ', 'error');
                return;
            }
            
            if (phone.length < 9 || !phone.startsWith('09')) {
                showAlert('မှန်ကန်သော ဖုန်းနံပါတ်ထည့်သွင်းပါ', 'error');
                return;
            }
            
            if (pin.length !== 6 || isNaN(pin)) {
                showAlert('ပင်နံပါတ် ၆ လုံးဖြစ်ရပါမည်', 'error');
                return;
            }
            
            try {
                // Show loading state
                const submitBtn = document.getElementById('submit-passport-btn');
                const originalText = submitBtn.textContent;
                submitBtn.textContent = 'တင်သွင်းနေသည်...';
                submitBtn.disabled = true;
                
                // Upload passport image
                const passportPath = `passports/${currentUser.user_id}_${Date.now()}_passport`;
                const { data: passportData, error: passportError } = await supabase.storage
                    .from('verification')
                    .upload(passportPath, passportFile);
                
                if (passportError) throw new Error(`Passport Upload Error: ${passportError.message}`);
                
                // Upload selfie image
                const selfiePath = `selfies/${currentUser.user_id}_${Date.now()}_selfie`;
                const { data: selfieData, error: selfieError } = await supabase.storage
                    .from('verification')
                    .upload(selfiePath, selfieFile);
                
                if (selfieError) throw new Error(`Selfie Upload Error: ${selfieError.message}`);
                
                // Get public URLs
                const passportUrl = supabase.storage.from('verification').getPublicUrl(passportPath).data.publicUrl;
                const selfieUrl = supabase.storage.from('verification').getPublicUrl(selfiePath).data.publicUrl;
                
                // Update user
                const { error: updateError } = await supabase
                    .from('users')
                    .update({
                        passport_number: passportNumber,
                        address: address,
                        phone: phone,
                        payment_pin: pin,
                        passport_image: passportUrl,
                        selfie_image: selfieUrl,
                        updated_at: new Date().toISOString()
                    })
                    .eq('user_id', currentUser.user_id);
                
                if (updateError) throw new Error(`Update User Error: ${updateError.message}`);
                
                // Update local user
                currentUser = {
                    ...currentUser,
                    passport_number: passportNumber,
                    address: address,
                    phone: phone,
                    payment_pin: pin,
                    passport_image: passportUrl,
                    selfie_image: selfieUrl
                };
                
                showAlert('အချက်အလက်များ အောင်မြင်စွာ တင်သွင်းပြီးပါပြီ', 'success');
                
                // Reset form
                document.getElementById('passport-number').value = '';
                document.getElementById('address').value = '';
                document.getElementById('phone').value = '';
                document.getElementById('payment-pin').value = '';
                document.getElementById('passport-image').value = '';
                document.getElementById('selfie-image').value = '';
                
                // Show pending message
                document.getElementById('passport-form').classList.add('hidden');
                document.getElementById('passport-submitted').classList.remove('hidden');
                
                document.getElementById('submitted-phone').textContent = phone;
                document.getElementById('submitted-passport').textContent = passportNumber;
                document.getElementById('submitted-address').textContent = address;
                document.getElementById('submitted-time').textContent = formatDate(new Date());
                
            } catch (error) {
                console.error('Submit Passport Error:', error.message);
                showAlert(`အချက်အလက်တင်သွင်းရာတွင် အမှားရှိပါသည်: ${error.message}`, 'error');
            } finally {
                // Reset button
                const submitBtn = document.getElementById('submit-passport-btn');
                submitBtn.textContent = 'တင်သွင်းမည်';
                submitBtn.disabled = false;
            }
        }
        
        // Process transfer
        async function processTransfer() {
            const recipientPhone = document.getElementById('transfer-phone').value;
            const amount = parseInt(document.getElementById('transfer-amount').value);
            const note = document.getElementById('transfer-note').value;
            const pin = document.getElementById('transfer-pin').value;
            const errorMsg = document.getElementById('transfer-error');
            
            errorMsg.classList.add('hidden');
            
            if (!recipientPhone || !amount || !pin) {
                errorMsg.textContent = 'ကျေးဇူးပြု၍ လိုအပ်သော အချက်အလက်များ ဖြည့်သွင်းပါ';
                errorMsg.classList.remove('hidden');
                return;
            }
            
            if (recipientPhone.length < 9 || !recipientPhone.startsWith('09')) {
                errorMsg.textContent = 'မှန်ကန်သော ဖုန်းနံပါတ်ထည့်သွင်းပါ';
                errorMsg.classList.remove('hidden');
                return;
            }
            
            if (amount < 1000 || amount > 1000000) {
                errorMsg.textContent = 'ငွေပမာဏသည် ၁,၀၀၀ မှ ၁,၀၀၀,၀၀၀ ကျပ်အတွင်း ဖြစ်ရပါမည်';
                errorMsg.classList.remove('hidden');
                return;
            }
            
            if (pin.length !== 6 || isNaN(pin)) {
                errorMsg.textContent = 'ပင်နံပါတ် ၆ လုံးဖြစ်ရပါမည်';
                errorMsg.classList.remove('hidden');
                return;
            }
            
            if (pin !== currentUser.payment_pin) {
                errorMsg.textContent = 'ပင်နံပါတ်မှားယွင်းနေပါသည်';
                errorMsg.classList.remove('hidden');
                return;
            }
            
            try {
                // Show loading animation
                const transferAnimation = document.createElement('div');
                transferAnimation.className = 'transfer-animation';
                transferAnimation.innerHTML = `
                    <div>ငွေလွှဲခြင်းလုပ်ငန်းစဥ်</div>
                    <div class="transfer-loading">
                        <div class="loading-spinner"></div>
                        <div style="margin-top: 10px;">ခေတ္တစောင့်ဆိုင်းပေးပါ...</div>
                    </div>
                `;
                document.body.appendChild(transferAnimation);
                
                // Check if recipient exists and is approved
                const { data: recipient, error: recipientError } = await supabase
                    .from('users')
                    .select('user_id, passport_status')
                    .eq('phone', recipientPhone)
                    .single();
                
                if (recipientError) {
                    document.body.removeChild(transferAnimation);
                    errorMsg.textContent = 'လက်ခံမည့်သူ ရှာမတွေ့ပါ';
                    errorMsg.classList.remove('hidden');
                    return;
                }
                
                if (recipient.user_id === currentUser.user_id) {
                    document.body.removeChild(transferAnimation);
                    errorMsg.textContent = 'ကိုယ့်ကိုယ်ကို ငွေလွှဲ၍မရပါ';
                    errorMsg.classList.remove('hidden');
                    return;
                }
                
                if (recipient.passport_status !== 'approved') {
                    document.body.removeChild(transferAnimation);
                    errorMsg.textContent = 'လက်ခံမည့်သူ၏ အကောင့်သည် အတည်ပြုထားခြင်းမရှိသေးပါ';
                    errorMsg.classList.remove('hidden');
                    return;
                }
                
                // Check if transfers are allowed
                if (!allowTransfers) {
                    document.body.removeChild(transferAnimation);
                    errorMsg.textContent = 'ယခုလက်ရှိတွင် ငွေလွှဲခြင်းဝန်ဆောင်မှု ရပ်ဆိုင်းထားပါသည်';
                    errorMsg.classList.remove('hidden');
                    return;
                }
                
                // Check if user has sufficient balance
                if (currentUser.balance < amount) {
                    document.body.removeChild(transferAnimation);
                    errorMsg.textContent = 'လက်ကျန်ငွေ မလုံလောက်ပါ';
                    errorMsg.classList.remove('hidden');
                    return;
                }
                
                // Generate transaction ID
                const transactionId = 'TXN' + Date.now() + Math.floor(Math.random() * 1000).toString().padStart(3, '0');
                
                // Deduct from sender first
                const { error: deductError } = await supabase
                    .from('users')
                    .update({ 
                        balance: currentUser.balance - amount,
                        updated_at: new Date().toISOString()
                    })
                    .eq('user_id', currentUser.user_id);
                
                if (deductError) {
                    document.body.removeChild(transferAnimation);
                    throw new Error(`Deduct Error: ${deductError.message}`);
                }
                
                // Add to recipient
                const { error: addError } = await supabase
                    .from('users')
                    .update({ 
                        balance: db.raw(`balance + ${amount}`),
                        updated_at: new Date().toISOString()
                    })
                    .eq('user_id', recipient.user_id);
                
                if (addError) {
                    // Rollback sender deduction if recipient update fails
                    await supabase
                        .from('users')
                        .update({ 
                            balance: currentUser.balance,
                            updated_at: new Date().toISOString()
                        })
                        .eq('user_id', currentUser.user_id);
                    
                    document.body.removeChild(transferAnimation);
                    throw new Error(`Add Error: ${addError.message}`);
                }
                
                // Record transaction
                const { error: transactionError } = await supabase
                    .from('transactions')
                    .insert({
                        transaction_id: transactionId,
                        from_user_id: currentUser.user_id,
                        to_user_id: recipient.user_id,
                        from_phone: currentUser.phone,
                        to_phone: recipientPhone,
                        amount: amount,
                        fee: 0,
                        note: note,
                        created_at: new Date().toISOString()
                    });
                
                if (transactionError) {
                    document.body.removeChild(transferAnimation);
                    throw new Error(`Transaction Error: ${transactionError.message}`);
                }
                
                // Update local user
                currentUser.balance -= amount;
                
                // Show success animation
                document.body.removeChild(transferAnimation);
                
                const successAnimation = document.createElement('div');
                successAnimation.className = 'success-animation';
                successAnimation.innerHTML = `
                    <div class="checkmark"></div>
                    <div>ငွေလွှဲပြီးပါပြီ</div>
                    <div style="font-size: 1rem; margin-top: 5px; font-weight: normal;">${formatCurrency(amount)} ကျပ်</div>
                `;
                document.body.appendChild(successAnimation);
                
                // Play sound
                document.getElementById('transfer-sent-sound').play();
                
                // Save transaction ID for receipt
                currentTransactionId = transactionId;
                
                // Remove success animation after delay
                setTimeout(() => {
                    document.body.removeChild(successAnimation);
                    
                    // Show receipt
                    showReceipt(transactionId, 'sent');
                    
                    // Reset form and close
                    toggleTransfer();
                }, 5000);
                
            } catch (error) {
                console.error('Transfer Error:', error.message);
                errorMsg.textContent = `ငွေလွှဲရာတွင် အမှားရှိပါသည်: ${error.message}`;
                errorMsg.classList.remove('hidden');
                
                // Remove any lingering animations
                const animations = document.querySelectorAll('.transfer-animation, .success-animation');
                animations.forEach(el => el.remove());
            }
        }
        
        // Show receipt
        async function showReceipt(transactionId, type) {
            try {
                const { data: transaction, error } = await supabase
                    .from('transactions')
                    .select('*')
                    .eq('transaction_id', transactionId)
                    .single();
                
                if (error) throw new Error(`Fetch Transaction Error: ${error.message}`);
                
                const receiptDetails = document.getElementById('receipt-details');
                
                receiptDetails.innerHTML = `
                    <div class="receipt-amount">
                        <div class="amount-label">${type === 'sent' ? 'ပေးပို့ငွေ' : 'လက်ခံရရှိငွေ'}</div>
                        <div class="amount-value">${formatCurrency(transaction.amount)} ကျပ်</div>
                    </div>
                    
                    <div class="receipt-detail">
                        <span class="detail-label">အိုင်ဒီ</span>
                        <span class="detail-value">${transaction.transaction_id}</span>
                    </div>
                    
                    <div class="receipt-detail">
                        <span class="detail-label">ရက်စွဲ</span>
                        <span class="detail-value">${formatDate(transaction.created_at)}</span>
                    </div>
                    
                    <div class="receipt-detail">
                        <span class="detail-label">${type === 'sent' ? 'လက်ခံသူ' : 'ပေးပို့သူ'}</span>
                        <span class="detail-value">${type === 'sent' ? transaction.to_phone : transaction.from_phone}</span>
                    </div>
                    
                    ${transaction.fee > 0 ? `
                        <div class="receipt-detail">
                            <span class="detail-label">ဝန်ဆောင်ခ</span>
                            <span class="detail-value">${formatCurrency(transaction.fee)} ကျပ်</span>
                        </div>
                    ` : ''}
                    
                    ${transaction.note ? `
                        <div class="receipt-detail">
                            <span class="detail-label">မှတ်ချက်</span>
                            <span class="detail-value">${transaction.note}</span>
                        </div>
                    ` : ''}
                `;
                
                // Generate QR code
                const qrData = JSON.stringify({
                    id: transaction.transaction_id,
                    amount: transaction.amount,
                    date: transaction.created_at,
                    type: type,
                    from: transaction.from_phone,
                    to: transaction.to_phone
                });
                
                document.getElementById('receipt-qr-code').src = `https://api.qrserver.com/v1/create-qr-code/?data=${encodeURIComponent(qrData)}&size=150x150`;
                
                // Show receipt
                document.getElementById('receipt-overlay').style.display = 'flex';
                
            } catch (error) {
                console.error('Show Receipt Error:', error.message);
                showAlert('ပြေစာပြသရာတွင် အမှားရှိပါသည်', 'error');
            }
        }
        
        // Close receipt
        function closeReceipt() {
            document.getElementById('receipt-overlay').style.display = 'none';
        }
        
        // Download receipt
        function downloadReceipt() {
            try {
                const receiptContainer = document.getElementById('receipt-container');
                
                html2canvas(receiptContainer, {
                    scale: 2,
                    logging: false,
                    useCORS: true,
                    backgroundColor: '#ffffff'
                }).then(canvas => {
                    const link = document.createElement('a');
                    link.download = 'OPPER+_Receipt.png';
                    link.href = canvas.toDataURL('image/png');
                    link.click();
                    
                    showAlert('ပြေစာ ဒေါင်းလုပ်ဆွဲပြီးပါပြီ', 'success');
                });
            } catch (error) {
                console.error('Download Receipt Error:', error.message);
                showAlert('ပြေစာဒေါင်းလုပ်ဆွဲရာတွင် အမှားရှိပါသည်', 'error');
            }
        }
        
        // Event listeners
        window.onload = () => {
            initializeUser();
            
            // Add event listeners
            document.getElementById('submit-passport-btn').addEventListener('click', submitPassport);
            document.getElementById('confirm-transfer-btn').addEventListener('click', processTransfer);
            
            // Set timeout to hide intro container if it doesn't disappear
            setTimeout(() => {
                const introContainer = document.getElementById('intro-container');
                if (introContainer && getComputedStyle(introContainer).visibility !== 'hidden') {
                    introContainer.style.display = 'none';
                }
            }, 8000);
        };
    </script>
</body>
</html>

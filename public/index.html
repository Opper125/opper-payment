<!DOCTYPE html>
<html lang="my">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>KPAY+ ငွေလွှဲစနစ်</title>
    <style>
@import url('https://fonts.googleapis.com/css2?family=Noto+Sans+Myanmar:wght@400;500;600;700&display=swap');

:root {
    --primary-color: #0A8FDC;
    --primary-light: #E2F3FB;
    --primary-dark: #0873B1;
    --success-color: #28a745;
    --warning-color: #ffc107;
    --danger-color: #dc3545;
    --text-color: #333;
    --text-light: #666;
    --background-color: #f8f9fa;
    --card-bg: #ffffff;
    --border-color: #ddd;
    --card-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    --spacing-xs: 5px;
    --spacing-sm: 10px;
    --spacing-md: 15px;
    --spacing-lg: 20px;
    --spacing-xl: 30px;
    --border-radius-sm: 5px;
    --border-radius-md: 10px;
    --border-radius-lg: 15px;
    --font-size-xs: 12px;
    --font-size-sm: 14px;
    --font-size-md: 16px;
    --font-size-lg: 18px;
    --font-size-xl: 24px;
}

* {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
}

body {
    font-family: 'Noto Sans Myanmar', sans-serif;
    background-color: var(--background-color);
    color: var(--text-color);
    line-height: 1.6;
}

.app-container {
    max-width: 480px;
    margin: 0 auto;
    min-height: 100vh;
    background-color: var(--background-color);
    position: relative;
}

.app-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: var(--spacing-md);
    background-color: var(--card-bg);
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    position: sticky;
    top: 0;
    z-index: 100;
}

.logo {
    display: flex;
    align-items: center;
}

.logo img {
    width: 30px;
    height: 30px;
    margin-right: var(--spacing-sm);
}

.logo h1 {
    font-size: var(--font-size-lg);
    color: var(--primary-color);
    font-weight: 600;
}

.user-info {
    display: flex;
    align-items: center;
}

.user-info span {
    margin-right: var(--spacing-sm);
}

.avatar {
    width: 32px;
    height: 32px;
    border-radius: 50%;
    overflow: hidden;
    border: 2px solid var(--primary-light);
}

.avatar img {
    width: 100%;
    height: 100%;
    object-fit: cover;
}

.auth-container {
    display: flex;
    justify-content: center;
    align-items: center;
    min-height: calc(100vh - 60px);
    padding: var(--spacing-lg);
}

.auth-card {
    width: 100%;
    background-color: var(--card-bg);
    border-radius: var(--border-radius-md);
    box-shadow: var(--card-shadow);
    padding: var(--spacing-xl);
}

.auth-card h2 {
    margin-bottom: var(--spacing-lg);
    text-align: center;
    color: var(--primary-color);
}

.tabs {
    display: flex;
    margin-bottom: var(--spacing-lg);
    border-bottom: 1px solid var(--border-color);
}

.tab {
    flex: 1;
    padding: var(--spacing-md);
    background: none;
    border: none;
    font-family: inherit;
    font-size: var(--font-size-md);
    color: var(--text-light);
    position: relative;
    cursor: pointer;
}

.tab.active {
    color: var(--primary-color);
    font-weight: 500;
}

.tab.active::after {
    content: '';
    position: absolute;
    bottom: -1px;
    left: 0;
    width: 100%;
    height: 2px;
    background-color: var(--primary-color);
}

.form-group {
    margin-bottom: var(--spacing-md);
}

.form-group label {
    display: block;
    margin-bottom: var(--spacing-xs);
    font-size: var(--font-size-sm);
    color: var(--text-light);
}

.form-group input {
    width: 100%;
    padding: var(--spacing-md);
    border: 1px solid var(--border-color);
    border-radius: var(--border-radius-sm);
    font-family: inherit;
    font-size: var(--font-size-md);
}

.form-group input:focus {
    outline: none;
    border-color: var(--primary-color);
}

.btn {
    display: inline-block;
    padding: var(--spacing-md) var(--spacing-lg);
    border: none;
    border-radius: var(--border-radius-sm);
    font-family: inherit;
    font-size: var(--font-size-md);
    font-weight: 500;
    cursor: pointer;
    text-align: center;
    transition: background-color 0.2s, transform 0.1s;
}

.btn:active {
    transform: translateY(1px);
}

.btn-primary {
    background-color: var(--primary-color);
    color: white;
}

.btn-primary:hover {
    background-color: var(--primary-dark);
}

.btn-outline {
    background-color: transparent;
    border: 1px solid var(--border-color);
    color: var(--text-color);
}

.btn-outline:hover {
    background-color: var(--background-color);
}

.btn-outline.danger {
    color: var(--danger-color);
    border-color: var(--danger-color);
}

.btn-outline.danger:hover {
    background-color: rgba(220, 53, 69, 0.1);
}

.btn-sm {
    padding: var(--spacing-xs) var(--spacing-md);
    font-size: var(--font-size-sm);
}

.btn-block {
    display: block;
    width: 100%;
}

.main-container {
    padding: var(--spacing-md);
}

.quick-actions {
    display: grid;
    grid-template-columns: repeat(4, 1fr);
    gap: var(--spacing-md);
    margin-bottom: var(--spacing-lg);
}

.action-card {
    display: flex;
    flex-direction: column;
    align-items: center;
    padding: var(--spacing-md);
    background-color: var(--card-bg);
    border-radius: var(--border-radius-md);
    box-shadow: var(--card-shadow);
    cursor: pointer;
    transition: transform 0.2s;
}

.action-card:hover {
    transform: translateY(-2px);
}

.action-card .icon {
    width: 40px;
    height: 40px;
    margin-bottom: var(--spacing-sm);
}

.action-card .icon img {
    width: 100%;
    height: 100%;
    object-fit: contain;
}

.action-card span {
    font-size: var(--font-size-sm);
    text-align: center;
}

.transaction-summary {
    background-color: var(--card-bg);
    border-radius: var(--border-radius-md);
    padding: var(--spacing-md);
    margin-bottom: var(--spacing-lg);
    box-shadow: var(--card-shadow);
}

.transaction-summary h3 {
    margin-bottom: var(--spacing-md);
    font-size: var(--font-size-md);
    color: var(--text-color);
}

.transaction-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: var(--spacing-md) 0;
    border-bottom: 1px solid var(--border-color);
}

.transaction-item:last-child {
    border-bottom: none;
}

.transaction-left {
    display: flex;
    align-items: center;
}

.transaction-icon {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    background-color: var(--primary-light);
    display: flex;
    justify-content: center;
    align-items: center;
    margin-right: var(--spacing-md);
}

.transaction-icon img {
    width: 20px;
    height: 20px;
}

.transaction-info h4 {
    font-size: var(--font-size-md);
    margin-bottom: 2px;
}

.transaction-info p {
    font-size: var(--font-size-xs);
    color: var(--text-light);
}

.transaction-amount {
    font-weight: 600;
    font-size: var(--font-size-md);
}

.transaction-amount.positive {
    color: var(--success-color);
}

.transaction-amount.negative {
    color: var(--danger-color);
}

.empty-state {
    text-align: center;
    padding: var(--spacing-lg);
    color: var(--text-light);
    font-size: var(--font-size-sm);
}

.services-section {
    background-color: var(--card-bg);
    border-radius: var(--border-radius-md);
    padding: var(--spacing-md);
    box-shadow: var(--card-shadow);
}

.services-section h3 {
    margin-bottom: var(--spacing-md);
    font-size: var(--font-size-md);
    color: var(--text-color);
}

.services-grid {
    display: grid;
    grid-template-columns: repeat(4, 1fr);
    gap: var(--spacing-md);
}

.service-card {
    display: flex;
    flex-direction: column;
    align-items: center;
    cursor: pointer;
}

.service-card .icon {
    width: 40px;
    height: 40px;
    margin-bottom: var(--spacing-sm);
}

.service-card .icon img {
    width: 100%;
    height: 100%;
    object-fit: contain;
}

.service-card span {
    font-size: var(--font-size-xs);
    text-align: center;
}

.overlay-screen {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background-color: var(--background-color);
    z-index: 500;
    overflow-y: auto;
}

.overlay-header {
    display: flex;
    align-items: center;
    padding: var(--spacing-md);
    background-color: var(--card-bg);
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    position: sticky;
    top: 0;
}

.back-button {
    background: none;
    border: none;
    font-size: var(--font-size-xl);
    line-height: 1;
    cursor: pointer;
    margin-right: var(--spacing-md);
    color: var(--text-color);
}

.overlay-header h2 {
    font-size: var(--font-size-lg);
    flex: 1;
}

.overlay-content {
    padding: var(--spacing-lg);
}

.history-filter {
    display: flex;
    gap: var(--spacing-sm);
    margin-bottom: var(--spacing-lg);
    overflow-x: auto;
    padding-bottom: var(--spacing-sm);
}

.filter-btn {
    padding: var(--spacing-sm) var(--spacing-md);
    background-color: var(--background-color);
    border: 1px solid var(--border-color);
    border-radius: var(--border-radius-sm);
    font-family: inherit;
    font-size: var(--font-size-sm);
    cursor: pointer;
    white-space: nowrap;
}

.filter-btn.active {
    background-color: var(--primary-color);
    color: white;
    border-color: var(--primary-color);
}

.history-list {
    display: flex;
    flex-direction: column;
    gap: var(--spacing-md);
}

.history-item {
    background-color: var(--card-bg);
    border-radius: var(--border-radius-md);
    padding: var(--spacing-md);
    box-shadow: var(--card-shadow);
}

.history-item-header {
    display: flex;
    justify-content: space-between;
    margin-bottom: var(--spacing-sm);
}

.history-item-type {
    font-weight: 600;
    font-size: var(--font-size-md);
}

.history-item-date {
    font-size: var(--font-size-xs);
    color: var(--text-light);
}

.history-item-body {
    display: flex;
    justify-content: space-between;
    margin-bottom: var(--spacing-sm);
}

.history-item-user {
    font-size: var(--font-size-sm);
}

.history-item-amount {
    font-weight: 600;
    font-size: var(--font-size-md);
}

.history-item-footer {
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.history-item-status {
    font-size: var(--font-size-xs);
    padding: 2px var(--spacing-sm);
    border-radius: 10px;
}

.status-success {
    background-color: rgba(40, 167, 69, 0.1);
    color: var(--success-color);
}

.status-pending {
    background-color: rgba(255, 193, 7, 0.1);
    color: var(--warning-color);
}

.status-failed {
    background-color: rgba(220, 53, 69, 0.1);
    color: var(--danger-color);
}

.history-item-id {
    font-size: var(--font-size-xs);
    color: var(--text-light);
}

.profile-summary {
    display: flex;
    flex-direction: column;
    align-items: center;
    margin-bottom: var(--spacing-xl);
}

.profile-avatar {
    width: 80px;
    height: 80px;
    border-radius: 50%;
    overflow: hidden;
    margin-bottom: var(--spacing-md);
    border: 3px solid var(--primary-light);
}

.profile-avatar img {
    width: 100%;
    height: 100%;
    object-fit: cover;
}

.profile-summary h3 {
    font-size: var(--font-size-lg);
    margin-bottom: var(--spacing-xs);
}

.profile-summary p {
    font-size: var(--font-size-sm);
    color: var(--text-light);
    margin-bottom: var(--spacing-xs);
}

.profile-actions {
    display: flex;
    flex-direction: column;
    gap: var(--spacing-md);
}

.topup-options {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: var(--spacing-md);
    margin-bottom: var(--spacing-lg);
}

.topup-option {
    display: flex;
    flex-direction: column;
    align-items: center;
    padding: var(--spacing-md);
    background-color: var(--card-bg);
    border-radius: var(--border-radius-md);
    box-shadow: var(--card-shadow);
    cursor: pointer;
    transition: transform 0.2s;
}

.topup-option:hover {
    transform: translateY(-2px);
}

.topup-option img {
    width: 50px;
    height: 50px;
    border-radius: var(--border-radius-sm);
    margin-bottom: var(--spacing-sm);
}

.topup-option span {
    font-size: var(--font-size-sm);
    text-align: center;
}

.topup-option.active {
    background-color: var(--primary-light);
    border: 2px solid var(--primary-color);
}

.receipt-container {
    background-color: var(--card-bg);
    border-radius: var(--border-radius-md);
    padding: var(--spacing-lg);
    box-shadow: var(--card-shadow);
}

.receipt-header {
    display: flex;
    flex-direction: column;
    align-items: center;
    margin-bottom: var(--spacing-lg);
    padding-bottom: var(--spacing-md);
    border-bottom: 1px dashed var(--border-color);
}

.receipt-header img {
    width: 50px;
    height: 50px;
    margin-bottom: var(--spacing-sm);
}

.receipt-header h2 {
    font-size: var(--font-size-lg);
    margin-bottom: var(--spacing-xs);
    color: var(--primary-color);
}

.receipt-details {
    margin-bottom: var(--spacing-lg);
}

.receipt-row {
    display: flex;
    justify-content: space-between;
    margin-bottom: var(--spacing-sm);
}

.receipt-row .label {
    font-size: var(--font-size-sm);
    color: var(--text-light);
}

.receipt-row .value {
    font-size: var(--font-size-sm);
    font-weight: 500;
}

.receipt-footer {
    text-align: center;
    padding-top: var(--spacing-md);
    border-top: 1px dashed var(--border-color);
}

.receipt-footer p {
    font-size: var(--font-size-xs);
    color: var(--text-light);
    margin-bottom: var(--spacing-md);
}

.verify-info {
    background-color: var(--primary-light);
    padding: var(--spacing-md);
    border-radius: var(--border-radius-sm);
    margin-bottom: var(--spacing-lg);
}

.verify-info p {
    font-size: var(--font-size-sm);
    color: var(--primary-color);
}

.file-preview {
    margin-top: var(--spacing-sm);
    width: 100%;
    height: 150px;
    border-radius: var(--border-radius-sm);
    background-color: var(--background-color);
    overflow: hidden;
    display: flex;
    justify-content: center;
    align-items: center;
}

.file-preview img {
    max-width: 100%;
    max-height: 100%;
    object-fit: contain;
}

.service-detail-content {
    background-color: var(--card-bg);
    border-radius: var(--border-radius-md);
    padding: var(--spacing-lg);
    box-shadow: var(--card-shadow);
}

.alert {
    position: fixed;
    bottom: 20px;
    left: 50%;
    transform: translateX(-50%);
    width: 90%;
    max-width: 400px;
    background-color: white;
    border-radius: var(--border-radius-md);
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    z-index: 1000;
    overflow: hidden;
}

.alert.success {
    border-left: 4px solid var(--success-color);
}

.alert.error {
    border-left: 4px solid var(--danger-color);
}

.alert.info {
    border-left: 4px solid var(--primary-color);
}

.alert-content {
    padding: var(--spacing-md) var(--spacing-lg);
}

.alert p {
    margin: 0;
    font-size: var(--font-size-sm);
}

.alert-close {
    position: absolute;
    top: 10px;
    right: 10px;
    background: none;
    border: none;
    font-size: 18px;
    cursor: pointer;
    color: var(--text-light);
}

.download-bar {
    position: fixed;
    bottom: 0;
    left: 0;
    width: 100%;
    background-color: var(--card-bg);
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: var(--spacing-md);
    box-shadow: 0 -2px 8px rgba(0, 0, 0, 0.1);
    z-index: 900;
}

.download-bar p {
    margin: 0;
    font-size: var(--font-size-sm);
    flex: 1;
}

.download-close {
    background: none;
    border: none;
    font-size: 18px;
    cursor: pointer;
    color: var(--text-light);
    padding: 0 var(--spacing-sm);
}

.particle {
    position: absolute;
    top: -30px;
    animation: fall 3s linear infinite;
}

@keyframes fall {
    0% {
        transform: translateY(0) rotate(0deg);
        opacity: 1;
    }
    100% {
        transform: translateY(100vh) rotate(720deg);
        opacity: 0;
    }
}

input[type="file"] {
    padding: var(--spacing-sm);
    border: 1px dashed var(--border-color);
    border-radius: var(--border-radius-sm);
    background-color: var(--background-color);
    cursor: pointer;
}

select {
    width: 100%;
    padding: var(--spacing-md);
    border: 1px solid var(--border-color);
    border-radius: var(--border-radius-sm);
    font-family: inherit;
    font-size: var(--font-size-md);
    background-color: white;
    appearance: none;
    background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 20 20' fill='%23666'%3E%3Cpath fill-rule='evenodd' d='M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z' clip-rule='evenodd'/%3E%3C/svg%3E");
    background-repeat: no-repeat;
    background-position: right 10px center;
    background-size: 20px;
}

@media (max-width: 480px) {
    .quick-actions {
        grid-template-columns: repeat(4, 1fr);
    }
    
    .services-grid {
        grid-template-columns: repeat(4, 1fr);
    }
}

@media (max-width: 380px) {
    .app-container {
        padding: 0;
    }
    
    .quick-actions {
        grid-template-columns: repeat(2, 1fr);
    }
    
    .services-grid {
        grid-template-columns: repeat(3, 1fr);
    }
}

.hidden {
    display: none !important;
}

.disabled {
    opacity: 0.7;
    pointer-events: none;
}

.loading {
    text-align: center;
    padding: var(--spacing-md);
    color: var(--text-light);
}

.status-message {
    background-color: var(--primary-light);
    padding: var(--spacing-md);
    border-radius: var(--border-radius-sm);
    margin-bottom: var(--spacing-lg);
    color: var(--primary-color);
    font-size: var(--font-size-sm);
}

.status-message a {
    color: var(--primary-dark);
    font-weight: 500;
    text-decoration: none;
}
    </style>
    <meta name="theme-color" content="#0A8FDC">
</head>
<body>
    <div class="app-container">
        <!-- ဟေဒါ -->
        <header class="app-header">
            <div class="logo">
                <img src="https://github.com/Opper125/opper-payment/raw/main/logo.png" alt="KPAY+ Logo">
                <h1>OPPER+</h1>
            </div>
            <div class="user-info" id="userInfo">
                <span id="userBalance">0.00 MMK</span>
                <div class="avatar" id="userAvatar">
                    <img src="https://cdn-icons-png.flaticon.com/512/149/149071.png" alt="User">
                </div>
            </div>
        </header>

        <!-- အကောင့်ဝင်ရန် ဖန်သားပြင် -->
        <div class="auth-container" id="authScreen">
            <div class="auth-card">
                <div class="tabs">
                    <button class="tab active" id="loginTab">အကောင့်ဝင်ရန်</button>
                    <button class="tab" id="registerTab">အကောင့်အသစ်ဖွင့်ရန်</button>
                </div>
                
                <div class="auth-form" id="loginForm">
                    <div class="form-group">
                        <label for="loginEmail">အီးမေးလ်</label>
                        <input type="email" id="loginEmail" placeholder="သင့်အီးမေးလ်ထည့်ပါ">
                    </div>
                    <div class="form-group">
                        <label for="loginPassword">စကားဝှက်</label>
                        <input type="password" id="loginPassword" placeholder="သင့်စကားဝှက်ထည့်ပါ">
                    </div>
                    <button class="btn btn-primary" id="loginButton">အကောင့်ဝင်ရန်</button>
                </div>
                
                <div class="auth-form hidden" id="registerForm">
                    <div class="form-group">
                        <label for="registerEmail">အီးမေးလ်</label>
                        <input type="email" id="registerEmail" placeholder="အီးမေးလ်ထည့်ပါ">
                    </div>
                    <div class="form-group">
                        <label for="registerPassword">စကားဝှက်</label>
                        <input type="password" id="registerPassword" placeholder="စကားဝှက်ထည့်ပါ">
                    </div>
                    <div class="form-group">
                        <label for="registerPhone">ဖုန်းနံပါတ်</label>
                        <input type="tel" id="registerPhone" placeholder="09xxxxxxxxx">
                    </div>
                    <button class="btn btn-primary" id="registerButton">အကောင့်ဖွင့်ရန်</button>
                </div>
            </div>
        </div>

        <!-- အဓိက ဖန်သားပြင် -->
        <main class="main-container hidden" id="mainScreen">
            <!-- အမြန်လွှဲခလုပ်များ -->
            <div class="quick-actions">
                <div class="action-card" id="topupButton">
                    <div class="icon">
                        <img src="https://cdn-icons-png.flaticon.com/512/2489/2489756.png" alt="ငွေဖြည့်">
                    </div>
                    <span>ငွေဖြည့်</span>
                </div>
                <div class="action-card" id="transferButton">
                    <div class="icon">
                        <img src="https://cdn-icons-png.flaticon.com/512/5454/5454292.png" alt="ငွေလွှဲ">
                    </div>
                    <span>ငွေလွှဲ</span>
                </div>
                <div class="action-card" id="historyButton">
                    <div class="icon">
                        <img src="https://cdn-icons-png.flaticon.com/512/2356/2356780.png" alt="မှတ်တမ်း">
                    </div>
                    <span>မှတ်တမ်း</span>
                </div>
                <div class="action-card" id="profileButton">
                    <div class="icon">
                        <img src="https://cdn-icons-png.flaticon.com/512/1077/1077063.png" alt="ပရိုဖိုင်">
                    </div>
                    <span>ပရိုဖိုင်</span>
                </div>
            </div>

            <!-- ငွေလွှဲမှု အကျဉ်းချုပ် -->
            <div class="transaction-summary">
                <h3>လတ်တလော ငွေလွှဲမှုများ</h3>
                <div class="transaction-list" id="transactionList">
                    <!-- ငွေလွှဲမှုများကို JavaScript ဖြင့် ဖော်ပြမည် -->
                    <div class="empty-state">လတ်တလော ငွေလွှဲမှုမရှိသေးပါ</div>
                </div>
            </div>

            <!-- ဝန်ဆောင်မှုများ -->
            <div class="services-section">
                <h3>ဝန်ဆောင်မှုများ</h3>
                <div class="services-grid">
                    <div class="service-card" onclick="showService('internet')">
                        <div class="icon"><img src="https://cdn-icons-png.flaticon.com/512/3028/3028582.png" alt="အင်တာနက်"></div>
                        <span>အင်တာနက်</span>
                    </div>
                    <div class="service-card" onclick="showService('electricity')">
                        <div class="icon"><img src="https://cdn-icons-png.flaticon.com/512/1598/1598673.png" alt="လျှပ်စစ်"></div>
                        <span>လျှပ်စစ်</span>
                    </div>
                    <div class="service-card" onclick="showService('water')">
                        <div class="icon"><img src="https://cdn-icons-png.flaticon.com/512/1748/1748687.png" alt="ရေ"></div>
                        <span>ရေဖိုး</span>
                    </div>
                    <div class="service-card" onclick="showService('donation')">
                        <div class="icon"><img src="https://cdn-icons-png.flaticon.com/512/3349/3349234.png" alt="အလှူငွေ"></div>
                        <span>အလှူပြုရန်</span>
                    </div>
                </div>
            </div>
        </main>

        <!-- ငွေလွှဲ ဖန်သားပြင် -->
        <div class="overlay-screen hidden" id="transferScreen">
            <div class="overlay-header">
                <button class="back-button" onclick="hideSection('transferScreen')">←</button>
                <h2>ငွေလွှဲရန်</h2>
            </div>
            <div class="overlay-content">
                <div class="form-group">
                    <label for="receiverPhone">လက်ခံမည့်ဖုန်းနံပါတ်</label>
                    <input type="tel" id="receiverPhone" placeholder="09xxxxxxxxx">
                </div>
                <div class="form-group">
                    <label for="transferAmount">ငွေပမာဏ (MMK)</label>
                    <input type="number" id="transferAmount" placeholder="0">
                </div>
                <div class="form-group">
                    <label for="transferNote">မှတ်ချက်</label>
                    <input type="text" id="transferNote" placeholder="မှတ်ချက်ရေးရန် (မဖြစ်မနေမဟုတ်ပါ)">
                </div>
                <button class="btn btn-primary" id="confirmTransferButton">ငွေလွှဲမည်</button>
            </div>
        </div>

        <!-- မှတ်တမ်း ဖန်သားပြင် -->
        <div class="overlay-screen hidden" id="historyScreen">
            <div class="overlay-header">
                <button class="back-button" onclick="hideSection('historyScreen')">←</button>
                <h2>ငွေလွှဲမှုမှတ်တမ်း</h2>
            </div>
            <div class="overlay-content">
                <div class="history-filter">
                    <button class="filter-btn active" data-filter="all">အားလုံး</button>
                    <button class="filter-btn" data-filter="in">ဝင်ငွေ</button>
                    <button class="filter-btn" data-filter="out">ထွက်ငွေ</button>
                </div>
                <div class="history-list" id="historyList">
                    <!-- ငွေလွှဲမှုမှတ်တမ်းများကို JavaScript ဖြင့် ဖော်ပြမည် -->
                </div>
            </div>
        </div>

        <!-- ပရိုဖိုင် ဖန်သားပြင် -->
        <div class="overlay-screen hidden" id="profileScreen">
            <div class="overlay-header">
                <button class="back-button" onclick="hideSection('profileScreen')">←</button>
                <h2>ပရိုဖိုင်</h2>
            </div>
            <div class="overlay-content">
                <div class="profile-summary">
                    <div class="profile-avatar">
                        <img id="profileAvatar" src="https://cdn-icons-png.flaticon.com/512/149/149071.png" alt="User">
                    </div>
                    <h3 id="profileName">အမည်</h3>
                    <p id="profilePhone">09xxxxxxxxx</p>
                    <p id="profileEmail">email@example.com</p>
                </div>
                
                <div class="profile-actions">
                    <button class="btn btn-outline" id="verifyIdButton">အိုင်ဒီအတည်ပြုရန်</button>
                    <button class="btn btn-outline" id="changePasswordButton">စကားဝှက်ပြောင်းရန်</button>
                    <button class="btn btn-outline danger" id="logoutButton">အကောင့်ထွက်ရန်</button>
                </div>
            </div>
        </div>

        <!-- ငွေဖြည့် ဖန်သားပြင် -->
        <div class="overlay-screen hidden" id="topupScreen">
            <div class="overlay-header">
                <button class="back-button" onclick="hideSection('topupScreen')">←</button>
                <h2>ငွေဖြည့်ရန်</h2>
            </div>
            <div class="overlay-content">
                <div class="topup-options">
                    <div class="topup-option" data-method="kbz">
                        <img src="https://play-lh.googleusercontent.com/lR5R7jCwIdKlm5CcPs6mSCQXQZmPiBGQ8yHHJsStNxp18Y6W7oLq7MOKQJ4ZlQwKEQ" alt="KBZ Pay">
                        <span>KBZ Pay</span>
                    </div>
                    <div class="topup-option" data-method="wave">
                        <img src="https://play-lh.googleusercontent.com/A7eI9K1nvMyliYWnjnX9L4bRdvnBL0H6Lj3CifTv38D5nyQKPlAxpZe-hHLCyDQm6g" alt="Wave Pay">
                        <span>Wave Money</span>
                    </div>
                    <div class="topup-option" data-method="aya">
                        <img src="https://play-lh.googleusercontent.com/RHfyZ-CMfJrHBTEzxUR_-KjCRDOvJR-tQK1Y5cMYqDy0linBkYBsQmNrOWxTXPAT6V4" alt="AYA Pay">
                        <span>AYA Pay</span>
                    </div>
                    <div class="topup-option" data-method="mpt">
                        <img src="https://play-lh.googleusercontent.com/_ZKgIz-4o2a0mnj1lbCGLvzsMi6Z8v75bXvTeG38KrNFXFd1WUn94RSBaQsRjfo_nSo" alt="MPT Money">
                        <span>MPT Money</span>
                    </div>
                </div>
                
                <div class="topup-form hidden" id="topupForm">
                    <div class="form-group">
                        <label for="topupAmount">ငွေပမာဏ (MMK)</label>
                        <input type="number" id="topupAmount" placeholder="0">
                    </div>
                    <div class="form-group">
                        <label for="topupPhone">သင့်ဖုန်းနံပါတ်</label>
                        <input type="tel" id="topupPhone" placeholder="09xxxxxxxxx">
                    </div>
                    <button class="btn btn-primary" id="confirmTopupButton">ဆက်လုပ်ရန်</button>
                </div>
            </div>
        </div>

        <!-- ပြေစာပြသည့် ဖန်သားပြင် -->
        <div class="overlay-screen hidden" id="receiptScreen">
            <div class="overlay-header">
                <button class="back-button" onclick="closeReceipt()">×</button>
                <h2>ငွေလွှဲဖြတ်ပိုင်း</h2>
            </div>
            <div class="overlay-content">
                <div class="receipt-container" id="receiptContainer">
                    <div class="receipt-header">
                        <img src="https://github.com/Opper125/opper-payment/raw/main/logo.png" alt="OPPER+ Logo">
                        <h2>OPPER+</h2>
                    </div>
                    <div class="receipt-details">
                        <div class="receipt-row">
                            <span class="label">အမျိုးအစား:</span>
                            <span class="value" id="receiptType">ငွေလွှဲမှု</span>
                        </div>
                        <div class="receipt-row">
                            <span class="label">ရက်စွဲ:</span>
                            <span class="value" id="receiptDate">2023-10-10 12:30</span>
                        </div>
                        <div class="receipt-row">
                            <span class="label">လုပ်ငန်းစဉ်နံပါတ်:</span>
                            <span class="value" id="receiptId">TXN123456789</span>
                        </div>
                        <div class="receipt-row">
                            <span class="label">ပို့သူ:</span>
                            <span class="value" id="receiptSender">09123456789</span>
                        </div>
                        <div class="receipt-row">
                            <span class="label">လက်ခံသူ:</span>
                            <span class="value" id="receiptReceiver">09987654321</span>
                        </div>
                        <div class="receipt-row">
                            <span class="label">ပမာဏ:</span>
                            <span class="value" id="receiptAmount">10,000 MMK</span>
                        </div>
                        <div class="receipt-row">
                            <span class="label">မှတ်ချက်:</span>
                            <span class="value" id="receiptNote">-</span>
                        </div>
                        <div class="receipt-row">
                            <span class="label">အခြေအနေ:</span>
                            <span class="value" id="receiptStatus">အောင်မြင်သည်</span>
                        </div>
                    </div>
                    <div class="receipt-footer">
                        <p>OPPER+ မှ ကျေးဇူးတင်ရှိပါသည်</p>
                        <button class="btn btn-sm" id="downloadReceiptButton" onclick="downloadReceipt()">ပြေစာဒေါင်းလုဒ်လုပ်ရန်</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- အိုင်ဒီအတည်ပြုသည့် ဖန်သားပြင် -->
        <div class="overlay-screen hidden" id="verifyIdScreen">
            <div class="overlay-header">
                <button class="back-button" onclick="hideSection('verifyIdScreen')">←</button>
                <h2>အိုင်ဒီအတည်ပြုရန်</h2>
            </div>
            <div class="overlay-content">
                <div class="verify-info">
                    <p>သင်၏ အိုင်ဒီကတ် (မှတ်ပုံတင်) နှင့် ကိုယ်တိုင်ဓာတ်ပုံကို ပေးပို့ရန် လိုအပ်ပါသည်။</p>
                </div>
                
                <div class="verify-form">
                    <div class="form-group">
                        <label for="idCardFile">အိုင်ဒီကတ် (မှတ်ပုံတင်) ဓာတ်ပုံ</label>
                        <input type="file" id="idCardFile" accept="image/*" onchange="previewFile('idCardFile')">
                        <div class="file-preview" id="idCardFilePreview"></div>
                    </div>
                    
                    <div class="form-group">
                        <label for="selfieFile">ကိုယ်တိုင်ဓာတ်ပုံ</label>
                        <input type="file" id="selfieFile" accept="image/*" onchange="previewFile('selfieFile')">
                        <div class="file-preview" id="selfieFilePreview"></div>
                    </div>
                    
                    <button class="btn btn-primary" id="submitVerificationButton">ပေးပို့ရန်</button>
                </div>
            </div>
        </div>

        <!-- ဝန်ဆောင်မှုအသေးစိတ် ဖန်သားပြင် -->
        <div class="overlay-screen hidden" id="serviceDetailScreen">
            <div class="overlay-header">
                <button class="back-button" onclick="hideServiceDetails()">←</button>
                <h2 id="serviceDetailTitle">ဝန်ဆောင်မှု</h2>
            </div>
            <div class="overlay-content">
                <div id="internetService" class="service-detail-content hidden">
                    <div class="form-group">
                        <label for="internetProvider">အင်တာနက်ပေးသွင်းသူ</label>
                        <select id="internetProvider">
                            <option value="">ရွေးချယ်ပါ</option>
                            <option value="mpt">MPT</option>
                            <option value="ooredoo">Ooredoo</option>
                            <option value="mytel">Mytel</option>
                            <option value="atom">Atom</option>
                            <option value="fiber">Myanmar Net</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="internetPhone">ဖုန်းနံပါတ် / အကောင့်နံပါတ်</label>
                        <input type="text" id="internetPhone" placeholder="ဖုန်းနံပါတ် သို့မဟုတ် အကောင့်နံပါတ်ထည့်ပါ">
                    </div>
                    <div class="form-group">
                        <label for="internetAmount">ငွေပမာဏ (MMK)</label>
                        <input type="number" id="internetAmount" placeholder="0">
                    </div>
                    <button class="btn btn-primary">ပေးဆောင်ရန်</button>
                </div>
                
                <div id="electricityService" class="service-detail-content hidden">
                    <div class="form-group">
                        <label for="electricityMeter">မီတာနံပါတ်</label>
                        <input type="text" id="electricityMeter" placeholder="မီတာနံပါတ်ထည့်ပါ">
                    </div>
                    <div class="form-group">
                        <label for="electricityAmount">ငွေပမာဏ (MMK)</label>
                        <input type="number" id="electricityAmount" placeholder="0">
                    </div>
                    <button class="btn btn-primary">ပေးဆောင်ရန်</button>
                </div>
                
                <div id="waterService" class="service-detail-content hidden">
                    <div class="form-group">
                        <label for="waterMeter">မီတာနံပါတ်</label>
                        <input type="text" id="waterMeter" placeholder="မီတာနံပါတ်ထည့်ပါ">
                    </div>
                    <div class="form-group">
                        <label for="waterAmount">ငွေပမာဏ (MMK)</label>
                        <input type="number" id="waterAmount" placeholder="0">
                    </div>
                    <button class="btn btn-primary">ပေးဆောင်ရန်</button>
                </div>
                
                <div id="donationService" class="service-detail-content hidden">
                    <div class="form-group">
                        <label for="donationOrg">အဖွဲ့အစည်းရွေးချယ်ပါ</label>
                        <select id="donationOrg">
                            <option value="">ရွေးချယ်ပါ</option>
                            <option value="redcross">ကြက်ခြေနီအသင်း</option>
                            <option value="orphans">မိဘမဲ့ကလေးများရိပ်မွန်</option>
                            <option value="monks">သံဃာဒါန</option>
                            <option value="disaster">သဘာဝဘေးအတွက်ကူညီရန်</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="donationAmount">အလှူငွေပမာဏ (MMK)</label>
                        <input type="number" id="donationAmount" placeholder="0">
                    </div>
                    <div class="form-group">
                        <label for="donationNote">မှတ်ချက်</label>
                        <input type="text" id="donationNote" placeholder="မှတ်ချက်ရေးရန်">
                    </div>
                    <button class="btn btn-primary">အလှူပြုရန်</button>
                </div>
            </div>
        </div>

        <!-- ပြဿနာ အကြောင်းကြားချက်များ -->
        <div class="alert hidden" id="alertBox">
            <div class="alert-content">
                <p id="alertMessage"></p>
            </div>
            <button class="alert-close" onclick="closeErrorAlert()">×</button>
        </div>
        
        <!-- ဒေါင်းလုဒ် သတိပေးချက် -->
        <div class="download-bar" id="downloadBar">
            <p>ပိုမိုကောင်းမွန်စွာအသုံးပြုရန် OPPER+ အက်ပ်ကို ဒေါင်းလုဒ်လုပ်ပါ။</p>
            <button class="btn btn-sm" onclick="downloadApk()">ဒေါင်းလုဒ်</button>
            <button class="download-close" onclick="hideDownloadBar()">×</button>
        </div>
    </div>
    
    <script>
const SUPABASE_URL = 'https://vtsczzlnhsrgnbkfyizi.supabase.co';
const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZ0c2N6emxuaHNyZ25ia2Z5aXppIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDI2ODYwODMsImV4cCI6MjA1ODI2MjA4M30.LjP2g0WXgg6FVTM5gPIkf_qlXakkj8Hf5xzXVsx7y68';
let supabaseClient = null;
let currentUser = null;
let currentUserDetails = null;
let currentToken = null;

document.addEventListener('DOMContentLoaded', function() {
    initializeApp();
    
    document.getElementById('loginTab').addEventListener('click', function() {
        document.getElementById('loginForm').classList.remove('hidden');
        document.getElementById('registerForm').classList.add('hidden');
        document.getElementById('loginTab').classList.add('active');
        document.getElementById('registerTab').classList.remove('active');
    });
    
    document.getElementById('registerTab').addEventListener('click', function() {
        document.getElementById('loginForm').classList.add('hidden');
        document.getElementById('registerForm').classList.remove('hidden');
        document.getElementById('loginTab').classList.remove('active');
        document.getElementById('registerTab').classList.add('active');
    });
    
    document.getElementById('loginButton').addEventListener('click', handleLogin);
    document.getElementById('registerButton').addEventListener('click', handleRegister);
    
    document.getElementById('topupButton')?.addEventListener('click', function() {
        showSection('topupScreen');
    });
    
    document.getElementById('transferButton')?.addEventListener('click', function() {
        showSection('transferScreen');
    });
    
    document.getElementById('historyButton')?.addEventListener('click', function() {
        showSection('historyScreen');
        loadHistory();
    });
    
    document.getElementById('profileButton')?.addEventListener('click', function() {
        showSection('profileScreen');
    });
    
    document.getElementById('confirmTransferButton')?.addEventListener('click', processTransfer);
    
    document.getElementById('verifyIdButton')?.addEventListener('click', function() {
        showSection('verifyIdScreen');
    });
    
    document.getElementById('submitVerificationButton')?.addEventListener('click', submitPassport);
    
    document.getElementById('logoutButton')?.addEventListener('click', logoutUser);
    
    const topupOptions = document.querySelectorAll('.topup-option');
    topupOptions.forEach(option => {
        option?.addEventListener('click', function() {
            document.getElementById('topupForm')?.classList.remove('hidden');
            
            topupOptions.forEach(opt => opt.classList.remove('active'));
            this.classList.add('active');
        });
    });
    
    document.getElementById('confirmTopupButton')?.addEventListener('click', function() {
        const amount = document.getElementById('topupAmount')?.value;
        const phone = document.getElementById('topupPhone')?.value;
        const selectedMethod = document.querySelector('.topup-option.active')?.dataset.method;
        
        if (!amount || !phone || !selectedMethod) {
            showCustomError('ကျေးဇူးပြု၍ အချက်အလက်အားလုံးဖြည့်စွက်ပါ');
            return;
        }
        
        if (parseInt(amount) < 1000) {
            showCustomError('အနည်းဆုံး ၁,၀၀၀ ကျပ် ဖြည့်သွင်းရပါမည်');
            return;
        }
        
        if (!isValidMyanmarPhone(phone)) {
            showCustomError('ဖုန်းနံပါတ်မှားယွင်းနေပါသည်');
            return;
        }
        
        simulatePayment(amount, 'topup');
    });
});

function initializeApp() {
    try {
        initializeSupabase();
        checkLoggedInStatus();
    } catch (error) {
        console.error('Supabase ချိတ်ဆက်ရာတွင် အမှားရှိသည်:', error);
        showCustomError('ဆာဗာချိတ်ဆက်ရာတွင် အမှားရှိသည်။ နောက်မှ ထပ်မံကြိုးစားပါ။');
    }

    setupDemoData();
}

function initializeSupabase() {
    try {
        supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
        console.log('Supabase ချိတ်ဆက်မှု အောင်မြင်ပါသည်');
    } catch (error) {
        console.error('Supabase ချိတ်ဆက်ရာတွင် အမှားရှိသည်:', error);
        throw error;
    }
}

async function checkLoggedInStatus() {
    const savedToken = localStorage.getItem('kpay_token');
    const savedEmail = localStorage.getItem('kpay_email');
    
    if (savedToken && savedEmail) {
        try {
            await validateSession(savedToken, savedEmail);
        } catch (error) {
            console.error('Session စစ်ဆေးရာတွင် အမှားရှိသည်:', error);
            localStorage.removeItem('kpay_token');
            localStorage.removeItem('kpay_email');
            showLoginScreen();
        }
    } else {
        showLoginScreen();
    }
}

async function validateSession(token, email) {
    try {
        const { data, error } = await supabaseClient
            .from('login_sessions')
            .select('*')
            .eq('session_token', token)
            .eq('is_active', true)
            .single();
        
        if (error || !data) {
            throw new Error('Session မတည်ရှိတော့ပါ သို့မဟုတ် သက်တမ်းကုန်ဆုံးသွားပါပြီ');
        }
        
        const expiresAt = new Date(data.expires_at);
        if (expiresAt < new Date()) {
            throw new Error('Session သက်တမ်းကုန်ဆုံးသွားပါပြီ');
        }
        
        const { data: userData, error: userError } = await supabaseClient
            .from('users')
            .select('*')
            .eq('user_id', data.user_id)
            .single();
        
        if (userError || !userData) {
            throw new Error('အသုံးပြုသူ မတွေ့ရှိပါ');
        }
        
        currentUser = userData;
        currentUserDetails = data;
        currentToken = token;
        
        hideLoginScreen();
        updateUIWithUserData();
    } catch (error) {
        console.error('Session စစ်ဆေးရာတွင် အမှားရှိသည်:', error);
        localStorage.removeItem('kpay_token');
        localStorage.removeItem('kpay_email');
        showLoginScreen();
        throw error;
    }
}

async function registerUser(email, password, phone) {
    try {
        if (!email || !password || !phone) {
            showCustomError('ကျေးဇူးပြု၍ အချက်အလက်အားလုံးဖြည့်စွက်ပါ');
            return;
        }
        
        if (!isValidMyanmarPhone(phone)) {
            showCustomError('ဖုန်းနံပါတ်မှားယွင်းနေပါသည်');
            return;
        }
        
        const user_id = generateUserId();
        
        const { data, error } = await supabaseClient.from('users').insert([
            {
                user_id,
                email,
                password_hash: password,
                phone,
                balance: "0",
                passport_status: "not_verified",
                is_admin: false
            }
        ]).select();
        
        if (error) {
            console.error('အသုံးပြုသူအသစ်ဖန်တီးရာတွင် အမှားရှိသည်:', error);
            if (error.code === '23505') {
                showCustomError('ဤအီးမေးလ် သို့မဟုတ် ဖုန်းနံပါတ်ကို အသုံးပြုပြီးသားဖြစ်သည်');
            } else {
                showCustomError('အသုံးပြုသူအသစ်ဖန်တီးရာတွင် အမှားရှိသည်');
            }
            return;
        }
        
        const sessionToken = generateSessionToken();
        const expiresAt = new Date();
        expiresAt.setDate(expiresAt.getDate() + 30);
        
        const { data: sessionData, error: sessionError } = await supabaseClient.from('login_sessions').insert([
            {
                user_id,
                session_token: sessionToken,
                device_info: navigator.userAgent,
                ip_address: "client_ip",
                is_active: true,
                created_at: new Date().toISOString(),
                expires_at: expiresAt.toISOString(),
                last_active: new Date().toISOString()
            }
        ]);
        
        if (sessionError) {
            console.error('Session ဖန်တီးရာတွင် အမှားရှိသည်:', sessionError);
            showCustomError('အကောင့်ဖွင့်အောင်မြင်သော်လည်း၊ အကောင့်ဝင်ရန် အခက်အခဲရှိသည်');
            return;
        }
        
        const { data: activityData, error: activityError } = await supabaseClient.from('activity_logs').insert([
            {
                user_id,
                action: 'register',
                details: JSON.stringify({ email }),
                ip_address: "client_ip",
                timestamp: new Date().toISOString()
            }
        ]);
        
        localStorage.setItem('kpay_token', sessionToken);
        localStorage.setItem('kpay_email', email);
        
        currentUser = data[0];
        currentToken = sessionToken;
        
        hideLoginScreen();
        updateUIWithUserData();
        
        showAlert('အကောင့်အသစ်ဖွင့်ခြင်း အောင်မြင်ပါသည်', 'success');
    } catch (error) {
        console.error('မှတ်ပုံတင်ရာတွင် အမှားရှိသည်:', error);
        showCustomError('အကောင့်ဖွင့်ရာတွင် အမှားရှိပါသည်။ ကျေးဇူးပြု၍ နောက်မှ ထပ်မံကြိုးစားပါ။');
    }
}

async function handleLogin() {
    const email = document.getElementById('loginEmail').value;
    const password = document.getElementById('loginPassword').value;
    
    if (!email || !password) {
        showCustomError('ကျေးဇူးပြု၍ အချက်အလက်အားလုံးဖြည့်စွက်ပါ');
        return;
    }
    
    try {
        const { data, error } = await supabaseClient
            .from('users')
            .select('*')
            .eq('email', email)
            .single();
        
        if (error || !data) {
            console.error('အသုံးပြုသူရှာဖွေရာတွင် အမှားရှိသည်:', error);
            showCustomError('အီးမေးလ် သို့မဟုတ် စကားဝှက် မှားယွင်းနေပါသည်');
            return;
        }
        
        if (data.password_hash !== password) {
            showCustomError('အီးမေးလ် သို့မဟုတ် စကားဝှက် မှားယွင်းနေပါသည်');
            return;
        }
        
        const sessionToken = generateSessionToken();
        const expiresAt = new Date();
        expiresAt.setDate(expiresAt.getDate() + 30);
        
        const { data: sessionData, error: sessionError } = await supabaseClient.from('login_sessions').insert([
            {
                user_id: data.user_id,
                session_token: sessionToken,
                device_info: navigator.userAgent,
                ip_address: "client_ip",
                is_active: true,
                created_at: new Date().toISOString(),
                expires_at: expiresAt.toISOString(),
                last_active: new Date().toISOString()
            }
        ]);
        
        if (sessionError) {
            console.error('Session ဖန်တီးရာတွင် အမှားရှိသည်:', sessionError);
            showCustomError('အကောင့်ဝင်ရာတွင် အခက်အခဲရှိသည်');
            return;
        }
        
        const { data: updateData, error: updateError } = await supabaseClient
            .from('users')
            .update({ last_login: new Date().toISOString() })
            .eq('user_id', data.user_id);
        
        const { data: activityData, error: activityError } = await supabaseClient.from('activity_logs').insert([
            {
                user_id: data.user_id,
                action: 'login',
                details: JSON.stringify({ email: data.email }),
                ip_address: "client_ip",
                timestamp: new Date().toISOString()
            }
        ]);
        
        localStorage.setItem('kpay_token', sessionToken);
        localStorage.setItem('kpay_email', email);
        
        currentUser = data;
        currentToken = sessionToken;
        
        hideLoginScreen();
        updateUIWithUserData();
        
        showAlert('အကောင့်ဝင်ရောက်ခြင်း အောင်မြင်ပါသည်', 'success');
    } catch (error) {
        console.error('အကောင့်ဝင်ရာတွင် အမှားရှိသည်:', error);
        showCustomError('အကောင့်ဝင်ရာတွင် အမှားရှိပါသည်။ ကျေးဇူးပြု၍ နောက်မှ ထပ်မံကြိုးစားပါ။');
    }
}

async function handleRegister() {
    const email = document.getElementById('registerEmail').value;
    const password = document.getElementById('registerPassword').value;
    const phone = document.getElementById('registerPhone').value;
    
    if (!email || !password || !phone) {
        showCustomError('ကျေးဇူးပြု၍ အချက်အလက်အားလုံးဖြည့်စွက်ပါ');
        return;
    }
    
    if (!isValidMyanmarPhone(phone)) {
        showCustomError('ဖုန်းနံပါတ်မှားယွင်းနေပါသည်');
        return;
    }
    
    registerUser(email, password, phone);
}

async function logoutUser() {
    try {
        if (!currentUser || !currentToken) {
            return;
        }
        
        const { data, error } = await supabaseClient
            .from('login_sessions')
            .update({ 
                is_active: false,
                last_active: new Date().toISOString()
            })
            .eq('session_token', currentToken);
        
        const { data: activityData, error: activityError } = await supabaseClient.from('activity_logs').insert([
            {
                user_id: currentUser.user_id,
                action: 'logout',
                details: JSON.stringify({}),
                ip_address: "client_ip",
                timestamp: new Date().toISOString()
            }
        ]);
        
        localStorage.removeItem('kpay_token');
        localStorage.removeItem('kpay_email');
        
        currentUser = null;
        currentToken = null;
        
        showLoginScreen();
        
        showAlert('အကောင့်မှထွက်ခြင်း အောင်မြင်ပါသည်', 'success');
    } catch (error) {
        console.error('အကောင့်မှထွက်ရာတွင် အမှားရှိသည်:', error);
        showCustomError('အကောင့်မှထွက်ရာတွင် အမှားရှိပါသည်။ ကျေးဇူးပြု၍ နောက်မှ ထပ်မံကြိုးစားပါ။');
    }
}

function showLoginScreen() {
    document.getElementById('authScreen').classList.remove('hidden');
    document.getElementById('mainScreen').classList.add('hidden');
}

function hideLoginScreen() {
    document.getElementById('authScreen').classList.add('hidden');
    document.getElementById('mainScreen').classList.remove('hidden');
}

function updateUIWithUserData() {
    if (!currentUser) return;
    
    document.getElementById('userBalance').textContent = formatCurrency(currentUser.balance) + ' MMK';
    
    document.getElementById('profileName').textContent = currentUser.username || currentUser.email.split('@')[0];
    document.getElementById('profilePhone').textContent = currentUser.phone || '-';
    document.getElementById('profileEmail').textContent = currentUser.email;
    
    checkTransferSettings();
    
    loadHistory();
}

function createParticles() {
    const count = 10;
    const container = document.querySelector('.main-container');
    
    if (!container) return;
    
    for (let i = 0; i < count; i++) {
        const particle = document.createElement('div');
        particle.className = 'particle';
        particle.style.left = Math.random() * 100 + '%';
        particle.style.animationDelay = Math.random() * 3 + 's';
        
        const coinImage = document.createElement('img');
        coinImage.src = 'https://cdn-icons-png.flaticon.com/512/2489/2489756.png';
        coinImage.alt = 'Coin';
        coinImage.style.width = '20px';
        coinImage.style.height = '20px';
        
        particle.appendChild(coinImage);
        container.appendChild(particle);
        
        setTimeout(() => {
            if (container.contains(particle)) {
                container.removeChild(particle);
            }
        }, 3000 + (Math.random() * 3000));
    }
}

function formatCurrency(amount) {
    if (!amount) return '0.00';
    return parseFloat(amount).toLocaleString('en-US', {
        minimumFractionDigits: 2,
        maximumFractionDigits: 2
    });
}

function formatDate(dateString) {
    const date = new Date(dateString);
    return date.toLocaleDateString('my-MM', {
        year: 'numeric',
        month: 'short',
        day: 'numeric',
        hour: '2-digit',
        minute: '2-digit'
    });
}

function showAlert(message, type = 'success') {
    const alertBox = document.getElementById('alertBox');
    if (!alertBox) return;
    
    const alertMessage = document.getElementById('alertMessage');
    if (!alertMessage) return;
    
    alertMessage.textContent = message;
    alertBox.className = `alert ${type}`;
    alertBox.classList.remove('hidden');
    
    setTimeout(() => {
        alertBox.classList.add('hidden');
    }, 3000);
}

function showCustomError(message) {
    const alertBox = document.getElementById('alertBox');
    if (!alertBox) return;
    
    const alertMessage = document.getElementById('alertMessage');
    if (!alertMessage) return;
    
    alertMessage.textContent = message;
    alertBox.className = 'alert error';
    alertBox.classList.remove('hidden');
}

function closeErrorAlert() {
    const alertBox = document.getElementById('alertBox');
    if (alertBox) {
        alertBox.classList.add('hidden');
    }
}

async function updateBalance() {
    if (!currentUser) return;
    
    try {
        const { data, error } = await supabaseClient
            .from('users')
            .select('balance')
            .eq('user_id', currentUser.user_id)
            .single();
        
        if (error) {
            console.error('လက်ကျန်ငွေရယူရာတွင် အမှားရှိသည်:', error);
            return;
        }
        
        currentUser.balance = data.balance;
        document.getElementById('userBalance').textContent = formatCurrency(data.balance) + ' MMK';
    } catch (error) {
        console.error('လက်ကျန်ငွေ update လုပ်ရာတွင် အမှားရှိသည်:', error);
    }
}

async function checkTransferSettings() {
    if (!currentUser) return;
    
    if (currentUser.passport_status !== 'verified') {
        document.getElementById('transferButton').classList.add('disabled');
        document.getElementById('transferAmount')?.setAttribute('max', '50000');
        updateStatus('ငွေလွှဲနိုင်သည့်ပမာဏကို တစ်ရက်လျှင် ၅၀,၀၀၀ ကျပ်သာ ခွင့်ပြုထားပါသည်။ အကန့်အသတ်မဲ့ငွေလွှဲနိုင်ရန် <a href="#" onclick="showSection(\'verifyIdScreen\')">အိုင်ဒီအတည်ပြုခြင်း</a> ပြုလုပ်ပါ။');
    } else {
        document.getElementById('transferButton').classList.remove('disabled');
        document.getElementById('transferAmount')?.removeAttribute('max');
        document.getElementById('verifyIdButton')?.setAttribute('disabled', 'disabled');
        document.getElementById('verifyIdButton').textContent = 'အိုင်ဒီအတည်ပြုပြီး';
        updateStatus('သင်၏အိုင်ဒီအတည်ပြုပြီးဖြစ်သည့်အတွက် ငွေလွှဲနိုင်သည့်ပမာဏ ကန့်သတ်ချက်မရှိပါ။');
    }
}

function updateStatus(status) {
    const statusElement = document.createElement('div');
    statusElement.className = 'status-message';
    statusElement.innerHTML = status;
    
    const existingStatus = document.querySelector('.status-message');
    if (existingStatus) {
        existingStatus.parentNode.removeChild(existingStatus);
    }
    
    const quickActions = document.querySelector('.quick-actions');
    if (quickActions) {
        quickActions.insertAdjacentElement('afterend', statusElement);
    }
}

function showSection(sectionId) {
    const sections = document.querySelectorAll('.overlay-screen');
    sections.forEach(section => {
        section.classList.add('hidden');
    });
    
    document.getElementById(sectionId).classList.remove('hidden');
    
    if (sectionId === 'historyScreen') {
        loadHistory();
    } else if (sectionId === 'transferScreen') {
        document.getElementById('receiverPhone').value = '';
        document.getElementById('transferAmount').value = '';
        document.getElementById('transferNote').value = '';
    }
}

function hideSection(sectionId) {
    document.getElementById(sectionId).classList.add('hidden');
}

async function checkPhone() {
    const receiverPhone = document.getElementById('receiverPhone').value;
    
    if (!receiverPhone) {
        showCustomError('ကျေးဇူးပြု၍ လက်ခံမည့်ဖုန်းနံပါတ်ထည့်ပါ');
        return false;
    }
    
    if (!isValidMyanmarPhone(receiverPhone)) {
        showCustomError('ဖုန်းနံပါတ်မှားယွင်းနေပါသည်');
        return false;
    }
    
    try {
        const { data, error } = await supabaseClient
            .from('users')
            .select('user_id, phone, email')
            .eq('phone', receiverPhone)
            .single();
        
        if (error || !data) {
            showCustomError('ဖုန်းနံပါတ်နှင့် အသုံးပြုသူမတွေ့ရှိပါ');
            return false;
        }
        
        if (data.user_id === currentUser.user_id) {
            showCustomError('သင့်ကိုယ်ပိုင်ဖုန်းနံပါတ်သို့ ငွေမလွှဲနိုင်ပါ');
            return false;
        }
        
        return data;
    } catch (error) {
        console.error('ဖုန်းနံပါတ်စစ်ဆေးရာတွင် အမှားရှိသည်:', error);
        showCustomError('ဖုန်းနံပါတ်စစ်ဆေးရာတွင် အမှားရှိပါသည်');
        return false;
    }
}

async function loadHistory() {
    if (!currentUser) return;
    
    try {
        const historyList = document.getElementById('historyList');
        if (!historyList) return;
        
        historyList.innerHTML = '<div class="loading">မှတ်တမ်းများရယူနေသည်...</div>';
        
        const { data, error } = await supabaseClient
            .from('transactions')
            .select('*')
            .or(`sender_id.eq.${currentUser.user_id},receiver_id.eq.${currentUser.user_id}`)
            .order('created_at', { ascending: false })
            .limit(20);
        
        if (error) {
            console.error('မှတ်တမ်းများရယူရာတွင် အမှားရှိသည်:', error);
            historyList.innerHTML = '<div class="empty-state">မှတ်တမ်းများရယူရာတွင် အမှားရှိပါသည်</div>';
            return;
        }
        
        if (!data || data.length === 0) {
            historyList.innerHTML = '<div class="empty-state">ငွေလွှဲမှုမှတ်တမ်းများမရှိသေးပါ</div>';
            return;
        }
        
        historyList.innerHTML = '';
        
        data.forEach(transaction => {
            const isOutgoing = transaction.sender_id === currentUser.user_id;
            const otherParty = isOutgoing ? transaction.receiver_id : transaction.sender_id;
            
            const historyItem = document.createElement('div');
            historyItem.className = 'history-item';
            historyItem.innerHTML = `
                <div class="history-item-header">
                    <div class="history-item-type">${isOutgoing ? 'ငွေလွှဲမှု' : 'ငွေလက်ခံမှု'}</div>
                    <div class="history-item-date">${formatDate(transaction.created_at)}</div>
                </div>
                <div class="history-item-body">
                    <div class="history-item-user">${otherParty}</div>
                    <div class="history-item-amount ${isOutgoing ? 'negative' : 'positive'}">
                        ${isOutgoing ? '-' : '+'} ${formatCurrency(transaction.amount)} MMK
                    </div>
                </div>
                <div class="history-item-footer">
                    <div class="history-item-status status-${transaction.status}">
                        ${getStatusText(transaction.status)}
                    </div>
                    <div class="history-item-id" onclick="showReceipt('${transaction.transaction_id}', '${isOutgoing ? 'out' : 'in'}')">
                        ပြေစာကြည့်ရန်
                    </div>
                </div>
            `;
            
            historyList.appendChild(historyItem);
        });
        
        updateTransactionList(data.slice(0, 3));
    } catch (error) {
        console.error('မှတ်တမ်းများရယူရာတွင် အမှားရှိသည်:', error);
        const historyList = document.getElementById('historyList');
        if (historyList) {
            historyList.innerHTML = '<div class="empty-state">မှတ်တမ်းများရယူရာတွင် အမှားရှိပါသည်</div>';
        }
    }
}

function updateTransactionList(transactions) {
    const transactionList = document.getElementById('transactionList');
    if (!transactionList) return;
    
    if (!transactions || transactions.length === 0) {
        transactionList.innerHTML = '<div class="empty-state">လတ်တလော ငွေလွှဲမှုမရှိသေးပါ</div>';
        return;
    }
    
    transactionList.innerHTML = '';
    
    transactions.forEach(transaction => {
        const isOutgoing = transaction.sender_id === currentUser.user_id;
        const otherParty = isOutgoing ? transaction.receiver_id : transaction.sender_id;
        
        const transactionItem = document.createElement('div');
        transactionItem.className = 'transaction-item';
        transactionItem.innerHTML = `
            <div class="transaction-left">
                <div class="transaction-icon">
                    <img src="https://cdn-icons-png.flaticon.com/512/${isOutgoing ? '5454' : '5956'}//${isOutgoing ? '5454292' : '5956592'}.png" alt="${isOutgoing ? 'ငွေလွှဲမှု' : 'ငွေလက်ခံမှု'}">
                </div>
                <div class="transaction-info">
                    <h4>${isOutgoing ? 'ငွေလွှဲမှု' : 'ငွေလက်ခံမှု'}</h4>
                    <p>${otherParty} • ${formatDate(transaction.created_at)}</p>
                </div>
            </div>
            <div class="transaction-amount ${isOutgoing ? 'negative' : 'positive'}">
                ${isOutgoing ? '-' : '+'} ${formatCurrency(transaction.amount)} MMK
            </div>
        `;
        
        transactionList.appendChild(transactionItem);
    });
}

function getStatusText(status) {
    switch (status) {
        case 'pending':
            return 'ဆောင်ရွက်ဆဲ';
        case 'success':
            return 'အောင်မြင်';
        case 'failed':
            return 'မအောင်မြင်';
        default:
            return status;
    }
}

function hideDownloadBar() {
    const downloadBar = document.getElementById('downloadBar');
    if (downloadBar) {
        downloadBar.style.display = 'none';
    }
    
    localStorage.setItem('hideDownloadBar', new Date().getTime());
}

function downloadApk() {
    window.location.href = 'https://appsgeyser.io/18731061/OPPER-Payment';
}

function previewFile(inputId) {
    const input = document.getElementById(inputId);
    const previewDiv = document.getElementById(inputId + 'Preview');
    
    if (input.files && input.files[0] && previewDiv) {
        const reader = new FileReader();
        
        reader.onload = function(e) {
            previewDiv.innerHTML = `<img src="${e.target.result}" alt="ရွေးချယ်ထားသောဖိုင်">`;
        };
        
        reader.readAsDataURL(input.files[0]);
    }
}

async function submitPassport() {
    if (!currentUser) return;
    
    const idCardFile = document.getElementById('idCardFile').files[0];
    const selfieFile = document.getElementById('selfieFile').files[0];
    
    if (!idCardFile || !selfieFile) {
        showCustomError('ကျေးဇူးပြု၍ အိုင်ဒီကတ်နှင့် ကိုယ်တိုင်ဓာတ်ပုံ နှစ်ခုစလုံးတင်ပါ');
        return;
    }
    
    try {
        const idCardPath = `verification/${currentUser.user_id}/id_card`;
        const selfiePath = `verification/${currentUser.user_id}/selfie`;
        
        const idCardUpload = await supabaseClient.storage.from('verification_documents').upload(idCardPath, idCardFile, {
            cacheControl: '3600',
            upsert: true
        });
        
        if (idCardUpload.error) {
            console.error('အိုင်ဒီကတ်ဓာတ်ပုံတင်ရာတွင် အမှားရှိသည်:', idCardUpload.error);
            showCustomError('အိုင်ဒီကတ်ဓာတ်ပုံတင်ရာတွင် အမှားရှိပါသည်။ ကျေးဇူးပြု၍ နောက်မှ ထပ်မံကြိုးစားပါ။');
            return;
        }
        
        const selfieUpload = await supabaseClient.storage.from('verification_documents').upload(selfiePath, selfieFile, {
            cacheControl: '3600',
            upsert: true
        });
        
        if (selfieUpload.error) {
            console.error('ကိုယ်တိုင်ဓာတ်ပုံတင်ရာတွင် အမှားရှိသည်:', selfieUpload.error);
            showCustomError('ကိုယ်တိုင်ဓာတ်ပုံတင်ရာတွင် အမှားရှိပါသည်။ ကျေးဇူးပြု၍ နောက်မှ ထပ်မံကြိုးစားပါ။');
            return;
        }
        
        const { data, error } = await supabaseClient.from('verification_requests').insert([
            {
                user_id: currentUser.user_id,
                id_document: idCardPath,
                selfie: selfiePath,
                status: 'pending',
                submitted_at: new Date().toISOString()
            }
        ]);
        
        if (error) {
            console.error('အတည်ပြုမှုတောင်းဆိုချက်ဖန်တီးရာတွင် အမှားရှိသည်:', error);
            showCustomError('အတည်ပြုမှုတောင်းဆိုချက်ဖန်တီးရာတွင် အမှားရှိပါသည်။ ကျေးဇူးပြု၍ နောက်မှ ထပ်မံကြိုးစားပါ။');
            return;
        }
        
        const { data: userData, error: userError } = await supabaseClient
            .from('users')
            .update({ passport_status: 'pending' })
            .eq('user_id', currentUser.user_id);
        
        if (!userError) {
            currentUser.passport_status = 'pending';
        }
        
        hideSection('verifyIdScreen');
        showAlert('အိုင်ဒီအတည်ပြုရန် တင်သွင်းခြင်း အောင်မြင်ပါသည်', 'success');
        
        checkTransferSettings();
    } catch (error) {
        console.error('အိုင်ဒီအတည်ပြုရန် တင်သွင်းရာတွင် အမှားရှိသည်:', error);
        showCustomError('အိုင်ဒီအတည်ပြုရန် တင်သွင်းရာတွင် အမှားရှိပါသည်။ ကျေးဇူးပြု၍ နောက်မှ ထပ်မံကြိုးစားပါ။');
    }
}

function showService(serviceId) {
    const serviceDetailScreen = document.getElementById('serviceDetailScreen');
    const serviceDetailTitle = document.getElementById('serviceDetailTitle');
    
    if (!serviceDetailScreen || !serviceDetailTitle) return;
    
    const serviceContents = document.querySelectorAll('.service-detail-content');
    serviceContents.forEach(content => {
        content.classList.add('hidden');
    });
    
    document.getElementById(serviceId + 'Service').classList.remove('hidden');
    
    switch (serviceId) {
        case 'internet':
            serviceDetailTitle.textContent = 'အင်တာနက်ဘေလ်ဆောင်ရန်';
            break;
        case 'electricity':
            serviceDetailTitle.textContent = 'လျှပ်စစ်မီတာဘေလ်ဆောင်ရန်';
            break;
        case 'water':
            serviceDetailTitle.textContent = 'ရေဖိုးဆောင်ရန်';
            break;
        case 'donation':
            serviceDetailTitle.textContent = 'အလှူငွေထည့်ဝင်ရန်';
            break;
    }
    
    serviceDetailScreen.classList.remove('hidden');
}

function hideServiceDetails() {
    document.getElementById('serviceDetailScreen').classList.add('hidden');
}

function showTopupOptions() {
    const topupScreen = document.getElementById('topupScreen');
    if (!topupScreen) return;
    
    topupScreen.classList.remove('hidden');
    document.getElementById('topupForm').classList.add('hidden');
    
    const topupOptions = document.querySelectorAll('.topup-option');
    topupOptions.forEach(option => {
        option.classList.remove('active');
    });
}

async function showReceipt(transactionId, type) {
    try {
        const { data, error } = await supabaseClient
            .from('transactions')
            .select('*')
            .eq('transaction_id', transactionId)
            .single();
        
        if (error || !data) {
            console.error('ငွေလွှဲမှုအချက်အလက်ရယူရာတွင် အမှားရှိသည်:', error);
            showCustomError('ငွေလွှဲမှုအချက်အလက်ရယူရာတွင် အမှားရှိပါသည်');
            return;
        }
        
        document.getElementById('receiptType').textContent = type === 'out' ? 'ငွေလွှဲမှု' : 'ငွေလက်ခံမှု';
        document.getElementById('receiptDate').textContent = formatDate(data.created_at);
        document.getElementById('receiptId').textContent = data.transaction_id;
        document.getElementById('receiptSender').textContent = data.sender_id;
        document.getElementById('receiptReceiver').textContent = data.receiver_id;
        document.getElementById('receiptAmount').textContent = formatCurrency(data.amount) + ' MMK';
        document.getElementById('receiptNote').textContent = data.description || '-';
        document.getElementById('receiptStatus').textContent = getStatusText(data.status);
        document.getElementById('receiptStatus').className = `value status-${data.status}`;
        
        document.getElementById('receiptScreen').classList.remove('hidden');
    } catch (error) {
        console.error('ပြေစာပြရာတွင် အမှားရှိသည်:', error);
        showCustomError('ပြေစာပြရာတွင် အမှားရှိပါသည်');
    }
}

function closeReceipt() {
    document.getElementById('receiptScreen').classList.add('hidden');
}

function downloadReceipt() {
    alert('ပြေစာဒေါင်းလုဒ်လုပ်နေသည်။ ခဏစောင့်ပါ...');
    
    setTimeout(() => {
        showAlert('ပြေစာဒေါင်းလုဒ်လုပ်ခြင်း အောင်မြင်ပါသည်', 'success');
    }, 1500);
}

async function processTransfer() {
    if (!currentUser) {
        showCustomError('ကျေးဇူးပြု၍ ဦးစွာအကောင့်ဝင်ပါ');
        return;
    }
    
    const receiverPhone = document.getElementById('receiverPhone').value;
    const amount = document.getElementById('transferAmount').value;
    const note = document.getElementById('transferNote').value;
    
    if (!receiverPhone || !amount) {
        showCustomError('ကျေးဇူးပြု၍ လက်ခံမည့်ဖုန်းနံပါတ်နှင့် ငွေပမာဏထည့်ပါ');
        return;
    }
    
    if (parseFloat(amount) <= 0) {
        showCustomError('ကျေးဇူးပြု၍ မှန်ကန်သော ငွေပမာဏထည့်ပါ');
        return;
    }
    
    if (parseFloat(amount) > parseFloat(currentUser.balance)) {
        showCustomError('သင့်တွင် လုံလောက်သော လက်ကျန်ငွေမရှိပါ');
        return;
    }
    
    try {
        const receiverData = await checkPhone();
        
        if (!receiverData) {
            return;
        }
        
        const transactionId = 'TXN' + Date.now().toString() + Math.floor(Math.random() * 1000).toString().padStart(3, '0');
        
        const { data, error } = await supabaseClient.from('transactions').insert([
            {
                transaction_id: transactionId,
                sender_id: currentUser.user_id,
                receiver_id: receiverData.user_id,
                amount: amount.toString(),
                description: note,
                status: 'pending',
                created_at: new Date().toISOString()
            }
        ]);
        
        if (error) {
            console.error('ငွေလွှဲမှုဖန်တီးရာတွင် အမှားရှိသည်:', error);
            showCustomError('ငွေလွှဲမှုဖန်တီးရာတွင် အမှားရှိပါသည်။ ကျေးဇူးပြု၍ နောက်မှ ထပ်မံကြိုးစားပါ။');
            return;
        }
        
        simulatePayment(amount, 'transfer', receiverData.user_id, transactionId);
        
        hideSection('transferScreen');
        showAlert('ငွေလွှဲမှုစတင်ပါပြီ', 'success');
    } catch (error) {
        console.error('ငွေလွှဲရာတွင် အမှားရှိသည်:', error);
        showCustomError('ငွေလွှဲရာတွင် အမှားရှိပါသည်။ ကျေးဇူးပြု၍ နောက်မှ ထပ်မံကြိုးစားပါ။');
    }
}

async function simulatePayment(amount, type, receiverId = null, transactionId = null) {
    if (!currentUser) return;
    
    const processingTime = Math.floor(Math.random() * 3000) + 2000;
    showAlert('ငွေလွှဲမှုဆောင်ရွက်နေသည်...', 'info');
    
    setTimeout(async () => {
        try {
            if (type === 'transfer') {
                const newSenderBalance = (parseFloat(currentUser.balance) - parseFloat(amount)).toString();
                
                const { data: senderData, error: senderError } = await supabaseClient
                    .from('users')
                    .update({ balance: newSenderBalance })
                    .eq('user_id', currentUser.user_id);
                
                if (senderError) {
                    console.error('ပို့သူငွေပမာဏ update လုပ်ရာတွင် အမှားရှိသည်:', senderError);
                    showCustomError('ငွေလွှဲရာတွင် အမှားရှိပါသည်။ ကျေးဇူးပြု၍ နောက်မှ ထပ်မံကြိုးစားပါ။');
                    return;
                }
                
                const { data: receiverUser, error: receiverFetchError } = await supabaseClient
                    .from('users')
                    .select('balance')
                    .eq('user_id', receiverId)
                    .single();
                
                if (receiverFetchError) {
                    console.error('လက်ခံသူအချက်အလက်ရယူရာတွင် အမှားရှိသည်:', receiverFetchError);
                    showCustomError('ငွေလွှဲရာတွင် အမှားရှိပါသည်။ ကျေးဇူးပြု၍ နောက်မှ ထပ်မံကြိုးစားပါ။');
                    return;
                }
                
                const newReceiverBalance = (parseFloat(receiverUser.balance) + parseFloat(amount)).toString();
                
                const { data: receiverData, error: receiverError } = await supabaseClient
                    .from('users')
                    .update({ balance: newReceiverBalance })
                    .eq('user_id', receiverId);
                
                if (receiverError) {
                    console.error('လက်ခံသူငွေပမာဏ update လုပ်ရာတွင် အမှားရှိသည်:', receiverError);
                    showCustomError('ငွေလွှဲရာတွင် အမှားရှိပါသည်။ ကျေးဇူးပြု၍ နောက်မှ ထပ်မံကြိုးစားပါ။');
                    return;
                }
                
                const { data: txnData, error: txnError } = await supabaseClient
                    .from('transactions')
                    .update({ status: 'success' })
                    .eq('transaction_id', transactionId);
                
                currentUser.balance = newSenderBalance;
                
                document.getElementById('userBalance').textContent = formatCurrency(newSenderBalance) + ' MMK';
                
                showAlert('ငွေလွှဲမှုအောင်မြင်ပါသည်', 'success');
                
                setTimeout(() => {
                    loadHistory();
                }, 1000);
            } else if (type === 'topup') {
                const newBalance = (parseFloat(currentUser.balance) + parseFloat(amount)).toString();
                
                const { data, error } = await supabaseClient
                    .from('users')
                    .update({ balance: newBalance })
                    .eq('user_id', currentUser.user_id);
                
                if (error) {
                    console.error('ငွေဖြည့်ရာတွင် အမှားရှိသည်:', error);
                    showCustomError('ငွေဖြည့်ရာတွင် အမှားရှိပါသည်။ ကျေးဇူးပြု၍ နောက်မှ ထပ်မံကြိုးစားပါ။');
                    return;
                }
                
                const topupTxnId = 'TOP' + Date.now().toString() + Math.floor(Math.random() * 1000).toString().padStart(3, '0');
                
                const { data: txnData, error: txnError } = await supabaseClient.from('transactions').insert([
                    {
                        transaction_id: topupTxnId,
                        sender_id: 'SYSTEM',
                        receiver_id: currentUser.user_id,
                        amount: amount.toString(),
                        description: 'ငွေဖြည့်ခြင်း',
                        status: 'success',
                        created_at: new Date().toISOString()
                    }
                ]);
                
                currentUser.balance = newBalance;
                
                document.getElementById('userBalance').textContent = formatCurrency(newBalance) + ' MMK';
                
                hideSection('topupScreen');
                
                showAlert('ငွေဖြည့်ခြင်းအောင်မြင်ပါသည်', 'success');
                
                createParticles();
                
                setTimeout(() => {
                    loadHistory();
                }, 1000);
            }
        } catch (error) {
            console.error('ငွေပေးချေမှု simulate လုပ်ရာတွင် အမှားရှိသည်:', error);
            showCustomError('ငွေပေးချေမှုဆောင်ရွက်ရာတွင် အမှားရှိပါသည်။ ကျေးဇူးပြု၍ နောက်မှ ထပ်မံကြိုးစားပါ။');
        }
    }, processingTime);
}

function isValidMyanmarPhone(phone) {
    const phoneRegex = /^09\d{7,9}$/;
    return phoneRegex.test(phone);
}

function generateUserId() {
    return 'USR' + Date.now().toString() + Math.floor(Math.random() * 1000).toString().padStart(3, '0');
}

function generateSessionToken() {
    return 'SESSION' + Date.now().toString() + Math.floor(Math.random() * 1000000).toString().padStart(6, '0');
}

function setupDemoData() {
    const lastHiddenTime = localStorage.getItem('hideDownloadBar');
    const downloadBar = document.getElementById('downloadBar');
    
    if (downloadBar) {
        if (!lastHiddenTime || (new Date().getTime() - parseInt(lastHiddenTime)) > 7 * 24 * 60 * 60 * 1000) {
            downloadBar.style.display = 'flex';
        } else {
            downloadBar.style.display = 'none';
        }
    }
}
    </script>
</body>
</html>

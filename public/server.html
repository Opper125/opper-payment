<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OPPER Payment - Admin Dashboard</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --primary-color: #4F46E5;
            --secondary-color: #EC4899;
            --background-color: #F3F4F6;
            --card-background: #FFFFFF;
            --text-color: #1F2937;
            --muted-text-color: #6B7280;
            --border-color: #E5E7EB;
            --success-color: #10B981;
            --warning-color: #F59E0B;
            --danger-color: #EF4444;
            --info-color: #3B82F6;
        }

        body {
            font-family: 'Poppins', sans-serif;
            background-color: var(--background-color);
            color: var(--text-color);
            margin: 0;
            display: flex;
            min-height: 100vh;
            transition: background-color 0.3s, color 0.3s;
        }

        .dark-mode {
            --background-color: #1F2937;
            --card-background: #374151;
            --text-color: #F3F4F6;
            --muted-text-color: #9CA3AF;
            --border-color: #4B5563;
        }

        .sidebar {
            width: 260px;
            background-color: var(--card-background);
            padding: 20px;
            box-shadow: 2px 0 10px rgba(0,0,0,0.05);
            display: flex;
            flex-direction: column;
            transition: background-color 0.3s;
        }

        .sidebar-header {
            display: flex;
            align-items: center;
            gap: 10px;
            padding-bottom: 20px;
            border-bottom: 1px solid var(--border-color);
            margin-bottom: 20px;
        }

        .sidebar-header img {
            width: 40px;
            height: 40px;
        }

        .sidebar-header h1 {
            font-size: 1.5rem;
            color: var(--primary-color);
            margin: 0;
        }

        .sidebar-nav ul {
            list-style: none;
            padding: 0;
            margin: 0;
            flex-grow: 1;
        }

        .sidebar-nav li a {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 15px;
            color: var(--muted-text-color);
            text-decoration: none;
            border-radius: 8px;
            font-weight: 500;
            transition: background-color 0.2s, color 0.2s;
        }

        .sidebar-nav li a:hover,
        .sidebar-nav li a.active {
            background-color: var(--primary-color);
            color: white;
        }

        .sidebar-nav li a i {
            width: 20px;
            text-align: center;
        }

        .sidebar-footer {
            margin-top: auto;
            padding-top: 20px;
            border-top: 1px solid var(--border-color);
        }

        .theme-toggle {
            background: none;
            border: 1px solid var(--border-color);
            color: var(--muted-text-color);
            padding: 8px 12px;
            border-radius: 6px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            width: 100%;
            justify-content: center;
        }

        .main-content {
            flex-grow: 1;
            padding: 30px;
            overflow-y: auto;
        }

        .page {
            display: none;
        }

        .page.active {
            display: block;
        }

        .page-header {
            margin-bottom: 30px;
        }

        .page-header h2 {
            font-size: 2rem;
            margin: 0 0 5px 0;
        }

        .page-header p {
            color: var(--muted-text-color);
            margin: 0;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background-color: var(--card-background);
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.05);
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .stat-card .icon {
            font-size: 1.8rem;
            padding: 15px;
            border-radius: 50%;
            color: white;
        }

        .stat-card .icon.total-users { background-color: var(--primary-color); }
        .stat-card .icon.approved-users { background-color: var(--success-color); }
        .stat-card .icon.pending-kyc { background-color: var(--warning-color); }
        .stat-card .icon.total-transactions { background-color: var(--secondary-color); }
        .stat-card .icon.active-announcements { background-color: var(--info-color); }


        .stat-card .info h3 {
            font-size: 1.5rem;
            margin: 0 0 5px 0;
        }

        .stat-card .info p {
            color: var(--muted-text-color);
            margin: 0;
            font-size: 0.9rem;
        }

        .card {
            background-color: var(--card-background);
            padding: 25px;
            border-radius: 12px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.05);
            margin-bottom: 30px;
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid var(--border-color);
        }

        .card-header h3 {
            font-size: 1.25rem;
            margin: 0;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        th, td {
            padding: 12px 15px;
            text-align: left;
            border-bottom: 1px solid var(--border-color);
        }

        th {
            background-color: var(--background-color);
            font-weight: 600;
            font-size: 0.9rem;
        }

        td {
            font-size: 0.95rem;
        }

        .status-badge {
            padding: 5px 10px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 500;
            text-transform: capitalize;
        }

        .status-approved { background-color: #D1FAE5; color: #065F46; }
        .status-pending { background-color: #FEF3C7; color: #92400E; }
        .status-rejected { background-color: #FEE2E2; color: #991B1B; }
        .status-active { background-color: #DBEAFE; color: #1E40AF; }
        .status-inactive { background-color: #E5E7EB; color: #4B5563; }


        .btn {
            padding: 10px 18px;
            border: none;
            border-radius: 8px;
            font-weight: 500;
            cursor: pointer;
            transition: background-color 0.2s, box-shadow 0.2s;
            font-size: 0.9rem;
        }

        .btn-primary {
            background-color: var(--primary-color);
            color: white;
        }
        .btn-primary:hover { background-color: #4338CA; }

        .btn-secondary {
            background-color: var(--secondary-color);
            color: white;
        }
        .btn-secondary:hover { background-color: #DB2777; }

        .btn-success { background-color: var(--success-color); color: white; }
        .btn-success:hover { background-color: #059669; }

        .btn-danger { background-color: var(--danger-color); color: white; }
        .btn-danger:hover { background-color: #DC2626; }

        .btn-warning { background-color: var(--warning-color); color: black; }
        .btn-warning:hover { background-color: #D97706; }

        .btn-sm {
            padding: 6px 12px;
            font-size: 0.8rem;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            font-weight: 500;
            margin-bottom: 8px;
            font-size: 0.9rem;
        }

        .form-group input[type="text"],
        .form-group input[type="email"],
        .form-group input[type="number"],
        .form-group input[type="password"],
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 12px;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            background-color: var(--background-color);
            color: var(--text-color);
            font-size: 0.95rem;
            box-sizing: border-box;
        }
        .form-group textarea {
            min-height: 100px;
            resize: vertical;
        }

        .form-group input[type="checkbox"] {
            margin-right: 8px;
        }

        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.5);
            align-items: center;
            justify-content: center;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background-color: var(--card-background);
            padding: 30px;
            border-radius: 12px;
            width: 90%;
            max-width: 600px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .modal-header h3 {
            margin: 0;
            font-size: 1.5rem;
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 1.8rem;
            cursor: pointer;
            color: var(--muted-text-color);
        }

        .modal-footer {
            margin-top: 30px;
            text-align: right;
        }

        .modal-footer .btn {
            margin-left: 10px;
        }

        .action-buttons button {
            margin-right: 8px;
        }
        .action-buttons button:last-child {
            margin-right: 0;
        }

        #toast-container {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 2000;
        }

        .toast {
            background-color: var(--text-color);
            color: var(--card-background);
            padding: 15px 20px;
            border-radius: 8px;
            margin-bottom: 10px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            opacity: 0;
            transform: translateX(100%);
            transition: opacity 0.3s, transform 0.3s;
        }

        .toast.show {
            opacity: 1;
            transform: translateX(0);
        }

        .toast.success { background-color: var(--success-color); color: white; }
        .toast.error { background-color: var(--danger-color); color: white; }
        .toast.info { background-color: var(--info-color); color: white; }

        /* Login Page Styles */
        .login-container {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 100%;
            height: 100vh;
            background-color: var(--background-color);
        }

        .login-card {
            background-color: var(--card-background);
            padding: 40px;
            border-radius: 12px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            width: 100%;
            max-width: 400px;
            text-align: center;
        }

        .login-card h2 {
            font-size: 1.8rem;
            color: var(--primary-color);
            margin-bottom: 10px;
        }

        .login-card p {
            color: var(--muted-text-color);
            margin-bottom: 30px;
        }
        .login-card .form-group input {
            background-color: var(--background-color); /* Ensure inputs use background color for contrast */
        }

        .loading-spinner {
            border: 4px solid rgba(0, 0, 0, 0.1);
            width: 36px;
            height: 36px;
            border-radius: 50%;
            border-left-color: var(--primary-color);
            animation: spin 1s ease infinite;
            margin: 20px auto;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

    </style>
</head>
<body>
    <div id="admin-login-page" class="login-container">
        <div class="login-card">
            <img src="https://github.com/Opper125/opper-payment/raw/main/logo.png" alt="OPPER Logo" style="width: 60px; margin-bottom: 15px;">
            <h2>Admin Dashboard</h2>
            <p>Please log in to continue</p>
            <div class="form-group">
                <label for="admin-email">Email</label>
                <input type="email" id="admin-email" placeholder="admin@opper.com">
            </div>
            <div class="form-group">
                <label for="admin-password">Password</label>
                <input type="password" id="admin-password" placeholder="Enter password">
            </div>
            <button class="btn btn-primary" style="width: 100%;" id="admin-login-btn">Login</button>
            <div id="admin-login-error" style="color: var(--danger-color); margin-top: 15px; display: none;"></div>
        </div>
    </div>

    <div class="sidebar" id="admin-sidebar" style="display: none;">
        <div class="sidebar-header">
            <img src="https://github.com/Opper125/opper-payment/raw/main/logo.png" alt="OPPER Logo">
            <h1>OPPER</h1>
        </div>
        <nav class="sidebar-nav">
            <ul>
                <li><a href="#dashboard" class="active" data-page="dashboard"><i class="fas fa-tachometer-alt"></i> Dashboard</a></li>
                <li><a href="#users" data-page="users"><i class="fas fa-users"></i> Users</a></li>
                <li><a href="#kyc" data-page="kyc"><i class="fas fa-id-card"></i> KYC Requests</a></li>
                <li><a href="#transactions" data-page="transactions"><i class="fas fa-exchange-alt"></i> Transactions</a></li>
                <li><a href="#announcements" data-page="announcements"><i class="fas fa-bullhorn"></i> Announcements</a></li>
                <li><a href="#settings" data-page="settings"><i class="fas fa-cog"></i> Settings</a></li>
            </ul>
        </nav>
        <div class="sidebar-footer">
            <button class="theme-toggle" id="theme-toggle-btn">
                <i class="fas fa-moon"></i> <span>Dark Mode</span>
            </button>
            <button class="btn btn-danger" style="width: 100%; margin-top: 15px;" id="admin-logout-btn">
                <i class="fas fa-sign-out-alt"></i> Logout
            </button>
        </div>
    </div>

    <div class="main-content" id="admin-main-content" style="display: none;">
        <!-- Dashboard Page -->
        <section id="dashboard-page" class="page active">
            <div class="page-header">
                <h2>Dashboard</h2>
                <p>Overview of your application.</p>
            </div>
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="icon total-users"><i class="fas fa-users"></i></div>
                    <div class="info">
                        <h3 id="stat-total-users">0</h3>
                        <p>Total Users</p>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="icon approved-users"><i class="fas fa-user-check"></i></div>
                    <div class="info">
                        <h3 id="stat-approved-users">0</h3>
                        <p>Approved Users</p>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="icon pending-kyc"><i class="fas fa-user-clock"></i></div>
                    <div class="info">
                        <h3 id="stat-pending-kyc">0</h3>
                        <p>Pending KYC</p>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="icon total-transactions"><i class="fas fa-receipt"></i></div>
                    <div class="info">
                        <h3 id="stat-total-transactions">0</h3>
                        <p>Total Transactions</p>
                    </div>
                </div>
                 <div class="stat-card">
                    <div class="icon active-announcements"><i class="fas fa-bullhorn"></i></div>
                    <div class="info">
                        <h3 id="stat-active-announcements">0</h3>
                        <p>Active Announcements</p>
                    </div>
                </div>
            </div>
            <div class="card">
                <div class="card-header">
                    <h3>Recent Activity</h3>
                </div>
                <div id="recent-activity-log">
                    <p>No recent activity.</p>
                </div>
            </div>
        </section>

        <!-- Users Page -->
        <section id="users-page" class="page">
            <div class="page-header">
                <h2>Users Management</h2>
                <p>View and manage user accounts.</p>
            </div>
            <div class="card">
                <div class="card-header">
                    <h3>All Users</h3>
                    <input type="text" id="user-search" placeholder="Search users by phone or name..." style="padding: 8px; border-radius: 6px; border: 1px solid var(--border-color); width: 300px;">
                </div>
                <table id="users-table">
                    <thead>
                        <tr>
                            <th>User ID</th>
                            <th>Phone</th>
                            <th>Name</th>
                            <th>Balance (Ks)</th>
                            <th>KYC Status</th>
                            <th>Joined At</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        <!-- User rows will be populated here -->
                    </tbody>
                </table>
                <div id="users-loading" class="loading-spinner" style="display:none;"></div>
            </div>
        </section>

        <!-- KYC Requests Page -->
        <section id="kyc-page" class="page">
            <div class="page-header">
                <h2>KYC Requests</h2>
                <p>Review and process KYC submissions.</p>
            </div>
            <div class="card">
                <div class="card-header">
                    <h3>Pending KYC Requests</h3>
                </div>
                <table id="kyc-table">
                    <thead>
                        <tr>
                            <th>User ID</th>
                            <th>Phone</th>
                            <th>Submitted At</th>
                            <th>Passport No.</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        <!-- KYC rows will be populated here -->
                    </tbody>
                </table>
                 <div id="kyc-loading" class="loading-spinner" style="display:none;"></div>
            </div>
        </section>

        <!-- Transactions Page -->
        <section id="transactions-page" class="page">
            <div class="page-header">
                <h2>Transactions</h2>
                <p>View all transactions.</p>
            </div>
            <div class="card">
                <div class="card-header">
                    <h3>Transaction History</h3>
                     <input type="text" id="transaction-search" placeholder="Search by ID, phone, or amount..." style="padding: 8px; border-radius: 6px; border: 1px solid var(--border-color); width: 300px;">
                </div>
                <table id="transactions-table">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>From Phone</th>
                            <th>To Phone</th>
                            <th>Amount (Ks)</th>
                            <th>Note</th>
                            <th>Date</th>
                        </tr>
                    </thead>
                    <tbody>
                        <!-- Transaction rows will be populated here -->
                    </tbody>
                </table>
                <div id="transactions-loading" class="loading-spinner" style="display:none;"></div>
            </div>
        </section>

        <!-- Announcements Page -->
        <section id="announcements-page" class="page">
            <div class="page-header">
                <h2>Announcements</h2>
                <p>Manage app announcements and gift boxes.</p>
            </div>
            <div class="card">
                <div class="card-header">
                    <h3>Create New Announcement</h3>
                </div>
                <form id="create-announcement-form">
                    <div class="form-group">
                        <label for="announcement-type">Type</label>
                        <select id="announcement-type" required>
                            <option value="text">Text</option>
                            <option value="image">Image</option>
                            <option value="gift_box">Gift Box</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="announcement-title">Title</label>
                        <input type="text" id="announcement-title" required>
                    </div>
                    <div class="form-group">
                        <label for="announcement-content">Content</label>
                        <textarea id="announcement-content"></textarea>
                    </div>
                    <div class="form-group" id="image-url-group" style="display: none;">
                        <label for="announcement-image-url">Image URL (Direct Link)</label>
                        <input type="text" id="announcement-image-url">
                        <small>Upload image to a service like Imgur and paste the direct image link here.</small>
                    </div>
                    <div id="gift-box-fields" style="display: none;">
                        <div class="form-group">
                            <label for="announcement-gift-amount">Total Gift Amount (Ks)</label>
                            <input type="number" id="announcement-gift-amount" min="0">
                        </div>
                        <div class="form-group">
                            <label for="announcement-gift-limit">User Limit (Number of Claimers)</label>
                            <input type="number" id="announcement-gift-limit" min="1">
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="announcement-is-active">
                            <input type="checkbox" id="announcement-is-active" checked> Active
                        </label>
                    </div>
                    <button type="submit" class="btn btn-primary">Create Announcement</button>
                </form>
            </div>

            <div class="card">
                <div class="card-header">
                    <h3>Manage Announcements</h3>
                </div>
                <table id="announcements-table">
                    <thead>
                        <tr>
                            <th>Title</th>
                            <th>Type</th>
                            <th>Status</th>
                            <th>Created At</th>
                            <th>Gift Details</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        <!-- Announcement rows will be populated here -->
                    </tbody>
                </table>
                <div id="announcements-loading" class="loading-spinner" style="display:none;"></div>
            </div>
        </section>

        <!-- Settings Page -->
        <section id="settings-page" class="page">
            <div class="page-header">
                <h2>Settings</h2>
                <p>Configure application settings.</p>
            </div>
            <div class="card">
                <div class="card-header">
                    <h3>General Settings</h3>
                </div>
                <div class="form-group">
                    <label for="allow-transfers">
                        <input type="checkbox" id="allow-transfers"> Allow Money Transfers
                    </label>
                </div>
                <button class="btn btn-primary" id="save-settings-btn">Save Settings</button>
            </div>
            <div class="card">
                <div class="card-header">
                    <h3>Bulk Operations</h3>
                </div>
                <div class="form-group">
                    <label for="bulk-deposit-amount">Bulk Deposit Amount (Ks) for Approved Users</label>
                    <input type="number" id="bulk-deposit-amount" min="0" placeholder="Enter amount">
                </div>
                <button class="btn btn-secondary" id="bulk-deposit-btn">Execute Bulk Deposit</button>
            </div>
        </section>
    </div>

    <!-- KYC Details Modal -->
    <div id="kyc-details-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>KYC Details</h3>
                <button class="modal-close" data-modal-id="kyc-details-modal">&times;</button>
            </div>
            <div id="kyc-modal-body">
                <p><strong>User ID:</strong> <span id="modal-kyc-user-id"></span></p>
                <p><strong>Phone:</strong> <span id="modal-kyc-phone"></span></p>
                <p><strong>Passport Number:</strong> <span id="modal-kyc-passport-number"></span></p>
                <p><strong>Address:</strong> <span id="modal-kyc-address"></span></p>
                <p><strong>Submitted At:</strong> <span id="modal-kyc-submitted-at"></span></p>
                <div style="margin-top: 15px;">
                    <p><strong>Passport Image:</strong></p>
                    <img id="modal-kyc-passport-image" src="/placeholder.svg" alt="Passport Image" style="max-width: 100%; border-radius: 8px; margin-bottom: 10px;">
                    <a id="modal-kyc-passport-image-link" href="" target="_blank" class="btn btn-sm btn-primary">View Full Passport</a>
                </div>
                <div style="margin-top: 15px;">
                    <p><strong>Selfie Image:</strong></p>
                    <img id="modal-kyc-selfie-image" src="/placeholder.svg" alt="Selfie Image" style="max-width: 100%; border-radius: 8px;">
                     <a id="modal-kyc-selfie-image-link" href="" target="_blank" class="btn btn-sm btn-primary">View Full Selfie</a>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-success" id="approve-kyc-btn">Approve</button>
                <button class="btn btn-danger" id="reject-kyc-btn">Reject</button>
                <button class="btn modal-cancel" data-modal-id="kyc-details-modal">Close</button>
            </div>
        </div>
    </div>

    <!-- Edit Announcement Modal -->
    <div id="edit-announcement-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Edit Announcement</h3>
                <button class="modal-close" data-modal-id="edit-announcement-modal">&times;</button>
            </div>
            <form id="edit-announcement-form">
                <input type="hidden" id="edit-announcement-id">
                <div class="form-group">
                    <label for="edit-announcement-type">Type</label>
                    <select id="edit-announcement-type" required>
                        <option value="text">Text</option>
                        <option value="image">Image</option>
                        <option value="gift_box">Gift Box</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="edit-announcement-title">Title</label>
                    <input type="text" id="edit-announcement-title" required>
                </div>
                <div class="form-group">
                    <label for="edit-announcement-content">Content</label>
                    <textarea id="edit-announcement-content"></textarea>
                </div>
                <div class="form-group" id="edit-image-url-group" style="display: none;">
                    <label for="edit-announcement-image-url">Image URL</label>
                    <input type="text" id="edit-announcement-image-url">
                </div>
                <div id="edit-gift-box-fields" style="display: none;">
                    <div class="form-group">
                        <label for="edit-announcement-gift-amount">Total Gift Amount (Ks)</label>
                        <input type="number" id="edit-announcement-gift-amount" min="0">
                    </div>
                    <div class="form-group">
                        <label for="edit-announcement-gift-limit">User Limit</label>
                        <input type="number" id="edit-announcement-gift-limit" min="1">
                    </div>
                     <p><strong>Claimed Count:</strong> <span id="edit-gift-claimed-count">0</span></p>
                </div>
                <div class="form-group">
                    <label for="edit-announcement-is-active">
                        <input type="checkbox" id="edit-announcement-is-active"> Active
                    </label>
                </div>
                 <div class="modal-footer">
                    <button type="submit" class="btn btn-primary">Save Changes</button>
                    <button type="button" class="btn modal-cancel" data-modal-id="edit-announcement-modal">Cancel</button>
                </div>
            </form>
        </div>
    </div>


    <div id="toast-container"></div>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script>
        const supabaseUrl = "https://vtsczzlnhsrgnbkfyizi.supabase.co";
        const supabaseKey = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZ0c2N6emxuaHNyZ25ia2Z5aXppIiwicm9sZSI6InNlcnZpY2Vfcm9sZSIsImlhdCI6MTc0MjY4NjA4MywiZXhwIjoyMDU4MjYyMDgzfQ.j-3H9E9XlY0oHkprkRZU3jWk2xY_j02YjY_j02YjY_j"; // Replace with your SERVICE_ROLE_KEY for admin
        const supabase = window.supabase.createClient(supabaseUrl, supabaseKey);

        // DOM Elements
        const adminLoginPage = document.getElementById('admin-login-page');
        const adminSidebar = document.getElementById('admin-sidebar');
        const adminMainContent = document.getElementById('admin-main-content');
        const adminLoginBtn = document.getElementById('admin-login-btn');
        const adminLogoutBtn = document.getElementById('admin-logout-btn');
        const adminLoginError = document.getElementById('admin-login-error');
        const navLinks = document.querySelectorAll('.sidebar-nav a');
        const pages = document.querySelectorAll('.main-content .page');
        const themeToggleBtn = document.getElementById('theme-toggle-btn');

        // Modals
        const kycDetailsModal = document.getElementById('kyc-details-modal');
        const editAnnouncementModal = document.getElementById('edit-announcement-modal');

        // KYC Modal Buttons
        const approveKycBtn = document.getElementById('approve-kyc-btn');
        const rejectKycBtn = document.getElementById('reject-kyc-btn');
        let currentKycUserId = null;
        let currentEditingAnnouncementId = null;


        // Toast Notification Function
        function showToast(message, type = 'info', duration = 3000) {
            const toastContainer = document.getElementById('toast-container');
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.textContent = message;
            toastContainer.appendChild(toast);

            setTimeout(() => toast.classList.add('show'), 10); // Trigger transition
            setTimeout(() => {
                toast.classList.remove('show');
                setTimeout(() => toast.remove(), 300); // Remove after transition
            }, duration);
        }

        // Admin Auth
        adminLoginBtn.addEventListener('click', async () => {
            const email = document.getElementById('admin-email').value;
            const password = document.getElementById('admin-password').value;

            // Basic validation (in a real app, use Supabase Auth for admins or a secure check)
            if (email === 'crakb68@gmail.com' && password === '155872') { // Replace with secure admin check
                localStorage.setItem('opperAdminLoggedIn', 'true');
                showAdminDashboard();
                loadDashboardStats();
                loadUsers();
                loadKycRequests();
                loadTransactions();
                loadAnnouncements();
                loadSettings();
            } else {
                adminLoginError.textContent = 'Invalid email or password.';
                adminLoginError.style.display = 'block';
            }
        });

        adminLogoutBtn.addEventListener('click', () => {
            localStorage.removeItem('opperAdminLoggedIn');
            showAdminLoginPage();
        });

        function checkAdminLogin() {
            if (localStorage.getItem('opperAdminLoggedIn') === 'true') {
                showAdminDashboard();
                loadDashboardStats();
                loadUsers();
                loadKycRequests();
                loadTransactions();
                loadAnnouncements();
                loadSettings();
            } else {
                showAdminLoginPage();
            }
        }

        function showAdminDashboard() {
            adminLoginPage.style.display = 'none';
            adminSidebar.style.display = 'flex';
            adminMainContent.style.display = 'block';
        }

        function showAdminLoginPage() {
            adminLoginPage.style.display = 'flex';
            adminSidebar.style.display = 'none';
            adminMainContent.style.display = 'none';
        }


        // Navigation
        navLinks.forEach(link => {
            link.addEventListener('click', (e) => {
                e.preventDefault();
                const pageId = link.getAttribute('href').substring(1) + '-page';

                pages.forEach(page => page.classList.remove('active'));
                document.getElementById(pageId).classList.add('active');

                navLinks.forEach(navLink => navLink.classList.remove('active'));
                link.classList.add('active');

                // Load data for the selected page if needed
                if (pageId === 'users-page') loadUsers();
                if (pageId === 'kyc-page') loadKycRequests();
                if (pageId === 'transactions-page') loadTransactions();
                if (pageId === 'announcements-page') loadAnnouncements();
                if (pageId === 'settings-page') loadSettings();
            });
        });

        // Theme Toggle
        themeToggleBtn.addEventListener('click', () => {
            document.body.classList.toggle('dark-mode');
            const isDarkMode = document.body.classList.contains('dark-mode');
            themeToggleBtn.innerHTML = isDarkMode
                ? '<i class="fas fa-sun"></i> <span>Light Mode</span>'
                : '<i class="fas fa-moon"></i> <span>Dark Mode</span>';
            localStorage.setItem('opperAdminTheme', isDarkMode ? 'dark' : 'light');
        });

        function applySavedTheme() {
            const savedTheme = localStorage.getItem('opperAdminTheme');
            if (savedTheme === 'dark') {
                document.body.classList.add('dark-mode');
                themeToggleBtn.innerHTML = '<i class="fas fa-sun"></i> <span>Light Mode</span>';
            }
        }

        // Data Loading Functions
        async function loadDashboardStats() {
            try {
                const { data: userStats, error: userError } = await supabase.rpc('get_user_stats');
                if (userError) throw userError;

                document.getElementById('stat-total-users').textContent = userStats.total || 0;
                document.getElementById('stat-approved-users').textContent = userStats.approved || 0;
                document.getElementById('stat-pending-kyc').textContent = userStats.pending || 0;

                const { count: transactionCount, error: transError } = await supabase
                    .from('transactions')
                    .select('*', { count: 'exact', head: true });
                if (transError) throw transError;
                document.getElementById('stat-total-transactions').textContent = transactionCount || 0;

                const { count: announcementCount, error: annError } = await supabase
                    .from('announcements')
                    .select('*', { count: 'exact', head: true })
                    .eq('is_active', true);
                if (annError) throw annError;
                document.getElementById('stat-active-announcements').textContent = announcementCount || 0;


            } catch (error) {
                console.error('Error loading dashboard stats:', error);
                showToast('Failed to load dashboard stats.', 'error');
            }
        }

        async function loadUsers(searchTerm = '') {
            const usersLoading = document.getElementById('users-loading');
            usersLoading.style.display = 'block';
            const usersTableBody = document.querySelector('#users-table tbody');
            usersTableBody.innerHTML = '';
            try {
                let query = supabase.from('users').select(`
                    user_id, phone, name, balance, passport_status, created_at,
                    auth_user:auth_users(email)
                `).order('created_at', { ascending: false });

                if (searchTerm) {
                    query = query.or(`name.ilike.%${searchTerm}%,phone.ilike.%${searchTerm}%`);
                }

                const { data: users, error } = await query;
                if (error) throw error;

                if (users.length === 0) {
                    usersTableBody.innerHTML = '<tr><td colspan="7">No users found.</td></tr>';
                } else {
                    users.forEach(user => {
                        const row = usersTableBody.insertRow();
                        row.innerHTML = `
                            <td>${user.user_id}</td>
                            <td>${user.phone || 'N/A'}</td>
                            <td>${user.name || 'N/A'}</td>
                            <td>${user.balance.toLocaleString()}</td>
                            <td><span class="status-badge status-${user.passport_status}">${user.passport_status}</span></td>
                            <td>${new Date(user.created_at).toLocaleDateString()}</td>
                            <td class="action-buttons">
                                <button class="btn btn-sm btn-primary" onclick="viewUser('${user.user_id}')">View</button>
                                <button class="btn btn-sm btn-warning" onclick="editUser('${user.user_id}')">Edit</button>
                            </td>
                        `;
                    });
                }
            } catch (error) {
                console.error('Error loading users:', error);
                showToast('Failed to load users.', 'error');
                usersTableBody.innerHTML = '<tr><td colspan="7">Error loading users.</td></tr>';
            } finally {
                usersLoading.style.display = 'none';
            }
        }
        document.getElementById('user-search').addEventListener('input', (e) => loadUsers(e.target.value));


        async function loadKycRequests() {
            const kycLoading = document.getElementById('kyc-loading');
            kycLoading.style.display = 'block';
            const kycTableBody = document.querySelector('#kyc-table tbody');
            kycTableBody.innerHTML = '';
            try {
                const { data: kycRequests, error } = await supabase
                    .from('users')
                    .select('user_id, phone, submitted_at, passport_number, passport_image, selfie_image, address')
                    .eq('passport_status', 'pending')
                    .order('submitted_at', { ascending: true });

                if (error) throw error;

                if (kycRequests.length === 0) {
                    kycTableBody.innerHTML = '<tr><td colspan="5">No pending KYC requests.</td></tr>';
                } else {
                    kycRequests.forEach(req => {
                        const row = kycTableBody.insertRow();
                        row.innerHTML = `
                            <td>${req.user_id}</td>
                            <td>${req.phone || 'N/A'}</td>
                            <td>${new Date(req.submitted_at).toLocaleString()}</td>
                            <td>${req.passport_number || 'N/A'}</td>
                            <td class="action-buttons">
                                <button class="btn btn-sm btn-primary" onclick="openKycDetailsModal('${req.user_id}')">Review</button>
                            </td>
                        `;
                    });
                }
            } catch (error) {
                console.error('Error loading KYC requests:', error);
                showToast('Failed to load KYC requests.', 'error');
                kycTableBody.innerHTML = '<tr><td colspan="5">Error loading KYC requests.</td></tr>';
            } finally {
                kycLoading.style.display = 'none';
            }
        }

        async function loadTransactions(searchTerm = '') {
            const transactionsLoading = document.getElementById('transactions-loading');
            transactionsLoading.style.display = 'block';
            const transactionsTableBody = document.querySelector('#transactions-table tbody');
            transactionsTableBody.innerHTML = '';
            try {
                let query = supabase.from('transactions').select('*').order('created_at', { ascending: false });

                if (searchTerm) {
                    query = query.or(`id.ilike.%${searchTerm}%,from_phone.ilike.%${searchTerm}%,to_phone.ilike.%${searchTerm}%,amount.eq.${isNaN(searchTerm) ? -1 : searchTerm}`);
                }

                const { data: transactions, error } = await query;
                if (error) throw error;

                if (transactions.length === 0) {
                    transactionsTableBody.innerHTML = '<tr><td colspan="6">No transactions found.</td></tr>';
                } else {
                    transactions.forEach(tx => {
                        const row = transactionsTableBody.insertRow();
                        row.innerHTML = `
                            <td>${tx.id}</td>
                            <td>${tx.from_phone} (${tx.from_name || 'N/A'})</td>
                            <td>${tx.to_phone} (${tx.to_name || 'N/A'})</td>
                            <td>${tx.amount.toLocaleString()}</td>
                            <td>${tx.note || '-'}</td>
                            <td>${new Date(tx.created_at).toLocaleString()}</td>
                        `;
                    });
                }
            } catch (error) {
                console.error('Error loading transactions:', error);
                showToast('Failed to load transactions.', 'error');
                transactionsTableBody.innerHTML = '<tr><td colspan="6">Error loading transactions.</td></tr>';
            } finally {
                transactionsLoading.style.display = 'none';
            }
        }
        document.getElementById('transaction-search').addEventListener('input', (e) => loadTransactions(e.target.value));


        async function loadAnnouncements() {
            const announcementsLoading = document.getElementById('announcements-loading');
            announcementsLoading.style.display = 'block';
            const announcementsTableBody = document.querySelector('#announcements-table tbody');
            announcementsTableBody.innerHTML = '';
            try {
                const { data, error } = await supabase
                    .from('announcements')
                    .select('*')
                    .order('created_at', { ascending: false });

                if (error) throw error;

                if (data.length === 0) {
                    announcementsTableBody.innerHTML = '<tr><td colspan="6">No announcements found.</td></tr>';
                } else {
                    data.forEach(ann => {
                        const row = announcementsTableBody.insertRow();
                        let giftDetails = '-';
                        if (ann.type === 'gift_box') {
                            giftDetails = `Amount: ${ann.gift_amount.toLocaleString()} Ks, Limit: ${ann.gift_user_limit}, Claimed: ${ann.gift_claimed_count}`;
                        }
                        row.innerHTML = `
                            <td>${ann.title}</td>
                            <td>${ann.type}</td>
                            <td><span class="status-badge status-${ann.is_active ? 'active' : 'inactive'}">${ann.is_active ? 'Active' : 'Inactive'}</span></td>
                            <td>${new Date(ann.created_at).toLocaleDateString()}</td>
                            <td>${giftDetails}</td>
                            <td class="action-buttons">
                                <button class="btn btn-sm btn-primary" onclick="openEditAnnouncementModal('${ann.id}')">Edit</button>
                                <button class="btn btn-sm btn-danger" onclick="deleteAnnouncement('${ann.id}')">Delete</button>
                            </td>
                        `;
                    });
                }
            } catch (error) {
                console.error('Error loading announcements:', error);
                showToast('Failed to load announcements.', 'error');
                announcementsTableBody.innerHTML = '<tr><td colspan="6">Error loading announcements.</td></tr>';
            } finally {
                announcementsLoading.style.display = 'none';
            }
        }


        async function loadSettings() {
            try {
                const { data, error } = await supabase
                    .from('settings')
                    .select('allow_transfers')
                    .eq('id', 1)
                    .single();

                if (error) throw error;
                document.getElementById('allow-transfers').checked = data.allow_transfers;
            } catch (error) {
                console.error('Error loading settings:', error);
                showToast('Failed to load settings.', 'error');
            }
        }

        // KYC Actions
        async function openKycDetailsModal(userId) {
            currentKycUserId = userId;
            try {
                const { data: kyc, error } = await supabase
                    .from('users')
                    .select('user_id, phone, passport_number, address, submitted_at, passport_image, selfie_image')
                    .eq('user_id', userId)
                    .single();
                if (error) throw error;

                document.getElementById('modal-kyc-user-id').textContent = kyc.user_id;
                document.getElementById('modal-kyc-phone').textContent = kyc.phone || 'N/A';
                document.getElementById('modal-kyc-passport-number').textContent = kyc.passport_number || 'N/A';
                document.getElementById('modal-kyc-address').textContent = kyc.address || 'N/A';
                document.getElementById('modal-kyc-submitted-at').textContent = new Date(kyc.submitted_at).toLocaleString();

                const passportImg = document.getElementById('modal-kyc-passport-image');
                const passportLink = document.getElementById('modal-kyc-passport-image-link');
                passportImg.src = kyc.passport_image || 'https://via.placeholder.com/300x200?text=No+Passport';
                passportLink.href = kyc.passport_image || '#';


                const selfieImg = document.getElementById('modal-kyc-selfie-image');
                const selfieLink = document.getElementById('modal-kyc-selfie-image-link');
                selfieImg.src = kyc.selfie_image || 'https://via.placeholder.com/300x200?text=No+Selfie';
                selfieLink.href = kyc.selfie_image || '#';


                kycDetailsModal.classList.add('active');
            } catch (error) {
                console.error('Error fetching KYC details:', error);
                showToast('Failed to load KYC details.', 'error');
            }
        }

        approveKycBtn.addEventListener('click', async () => {
            if (!currentKycUserId) return;
            try {
                const { error } = await supabase
                    .from('users')
                    .update({ passport_status: 'approved' })
                    .eq('user_id', currentKycUserId);
                if (error) throw error;
                showToast('KYC approved successfully.', 'success');
                kycDetailsModal.classList.remove('active');
                loadKycRequests();
                loadDashboardStats(); // Refresh stats
            } catch (error) {
                console.error('Error approving KYC:', error);
                showToast('Failed to approve KYC.', 'error');
            }
        });

        rejectKycBtn.addEventListener('click', async () => {
            if (!currentKycUserId) return;
            try {
                const { error } = await supabase
                    .from('users')
                    .update({ passport_status: 'rejected' })
                    .eq('user_id', currentKycUserId);
                if (error) throw error;
                showToast('KYC rejected successfully.', 'info');
                kycDetailsModal.classList.remove('active');
                loadKycRequests();
                loadDashboardStats(); // Refresh stats
            } catch (error) {
                console.error('Error rejecting KYC:', error);
                showToast('Failed to reject KYC.', 'error');
            }
        });


        // Announcement Form Logic
        const announcementTypeSelect = document.getElementById('announcement-type');
        const imageUrlGroup = document.getElementById('image-url-group');
        const giftBoxFields = document.getElementById('gift-box-fields');

        announcementTypeSelect.addEventListener('change', function() {
            imageUrlGroup.style.display = this.value === 'image' ? 'block' : 'none';
            giftBoxFields.style.display = this.value === 'gift_box' ? 'block' : 'none';
        });

        const createAnnouncementForm = document.getElementById('create-announcement-form');
        createAnnouncementForm.addEventListener('submit', async function(e) {
            e.preventDefault();
            const type = document.getElementById('announcement-type').value;
            const title = document.getElementById('announcement-title').value;
            const content = document.getElementById('announcement-content').value;
            const imageUrl = document.getElementById('announcement-image-url').value;
            const giftAmount = parseInt(document.getElementById('announcement-gift-amount').value) || 0;
            const giftLimit = parseInt(document.getElementById('announcement-gift-limit').value) || 0;
            const isActive = document.getElementById('announcement-is-active').checked;

            let announcementData = { type, title, content, is_active: isActive, created_by: 'admin' };

            if (type === 'image' && imageUrl) {
                announcementData.image_url = imageUrl;
            }
            if (type === 'gift_box') {
                if (giftAmount <= 0 || giftLimit <= 0) {
                    showToast('Gift amount and user limit must be greater than 0 for gift boxes.', 'error');
                    return;
                }
                announcementData.gift_amount = giftAmount;
                announcementData.gift_user_limit = giftLimit;
                announcementData.gift_claimed_count = 0; // Initialize
            }

            try {
                const { error } = await supabase.from('announcements').insert([announcementData]);
                if (error) throw error;
                showToast('Announcement created successfully!', 'success');
                createAnnouncementForm.reset();
                imageUrlGroup.style.display = 'none';
                giftBoxFields.style.display = 'none';
                loadAnnouncements();
                loadDashboardStats();
            } catch (error) {
                console.error('Error creating announcement:', error);
                showToast('Failed to create announcement.', 'error');
            }
        });

        // Edit Announcement Modal Logic
        const editAnnouncementTypeSelect = document.getElementById('edit-announcement-type');
        const editImageUrlGroup = document.getElementById('edit-image-url-group');
        const editGiftBoxFields = document.getElementById('edit-gift-box-fields');

        editAnnouncementTypeSelect.addEventListener('change', function() {
            editImageUrlGroup.style.display = this.value === 'image' ? 'block' : 'none';
            editGiftBoxFields.style.display = this.value === 'gift_box' ? 'block' : 'none';
        });

        async function openEditAnnouncementModal(announcementId) {
            currentEditingAnnouncementId = announcementId;
            try {
                const { data: ann, error } = await supabase
                    .from('announcements')
                    .select('*')
                    .eq('id', announcementId)
                    .single();
                if (error) throw error;

                document.getElementById('edit-announcement-id').value = ann.id;
                document.getElementById('edit-announcement-type').value = ann.type;
                document.getElementById('edit-announcement-title').value = ann.title;
                document.getElementById('edit-announcement-content').value = ann.content || '';
                document.getElementById('edit-announcement-is-active').checked = ann.is_active;

                editImageUrlGroup.style.display = ann.type === 'image' ? 'block' : 'none';
                document.getElementById('edit-announcement-image-url').value = ann.image_url || '';

                editGiftBoxFields.style.display = ann.type === 'gift_box' ? 'block' : 'none';
                document.getElementById('edit-announcement-gift-amount').value = ann.gift_amount || 0;
                document.getElementById('edit-announcement-gift-limit').value = ann.gift_user_limit || 0;
                document.getElementById('edit-gift-claimed-count').textContent = ann.gift_claimed_count || 0;


                editAnnouncementModal.classList.add('active');
            } catch (error) {
                console.error('Error fetching announcement for edit:', error);
                showToast('Failed to load announcement details.', 'error');
            }
        }

        const editAnnouncementForm = document.getElementById('edit-announcement-form');
        editAnnouncementForm.addEventListener('submit', async function(e) {
            e.preventDefault();
            if (!currentEditingAnnouncementId) return;

            const type = document.getElementById('edit-announcement-type').value;
            const title = document.getElementById('edit-announcement-title').value;
            const content = document.getElementById('edit-announcement-content').value;
            const imageUrl = document.getElementById('edit-announcement-image-url').value;
            const giftAmount = parseInt(document.getElementById('edit-announcement-gift-amount').value) || 0;
            const giftLimit = parseInt(document.getElementById('edit-announcement-gift-limit').value) || 0;
            const isActive = document.getElementById('edit-announcement-is-active').checked;

            let updatedData = { type, title, content, is_active: isActive };

            if (type === 'image') {
                updatedData.image_url = imageUrl;
            } else {
                 updatedData.image_url = null; // Clear if not image type
            }

            if (type === 'gift_box') {
                 if (giftAmount <= 0 || giftLimit <= 0) {
                    showToast('Gift amount and user limit must be greater than 0 for gift boxes.', 'error');
                    return;
                }
                updatedData.gift_amount = giftAmount;
                updatedData.gift_user_limit = giftLimit;
                // gift_claimed_count is not directly editable here, it's managed by claims
            } else {
                updatedData.gift_amount = null;
                updatedData.gift_user_limit = null;
                updatedData.gift_claimed_count = null;
            }


            try {
                const { error } = await supabase
                    .from('announcements')
                    .update(updatedData)
                    .eq('id', currentEditingAnnouncementId);
                if (error) throw error;
                showToast('Announcement updated successfully!', 'success');
                editAnnouncementModal.classList.remove('active');
                loadAnnouncements();
                loadDashboardStats();
            } catch (error) {
                console.error('Error updating announcement:', error);
                showToast('Failed to update announcement.', 'error');
            }
        });

        async function deleteAnnouncement(announcementId) {
            if (!confirm('Are you sure you want to delete this announcement? This action cannot be undone.')) {
                return;
            }
            try {
                // First, delete related gift claims if it's a gift box
                const { data: annDetails, error: fetchError } = await supabase
                    .from('announcements')
                    .select('type')
                    .eq('id', announcementId)
                    .single();

                if (fetchError) throw fetchError;

                if (annDetails.type === 'gift_box') {
                    const { error: claimDeleteError } = await supabase
                        .from('gift_claims')
                        .delete()
                        .eq('announcement_id', announcementId);
                    if (claimDeleteError) throw claimDeleteError;
                }

                // Then delete the announcement
                const { error } = await supabase
                    .from('announcements')
                    .delete()
                    .eq('id', announcementId);
                if (error) throw error;
                showToast('Announcement deleted successfully!', 'success');
                loadAnnouncements();
                loadDashboardStats();
            } catch (error) {
                console.error('Error deleting announcement:', error);
                showToast('Failed to delete announcement. Check if there are related gift claims.', 'error');
            }
        }


        // Settings Actions
        document.getElementById('save-settings-btn').addEventListener('click', async () => {
            const allowTransfers = document.getElementById('allow-transfers').checked;
            try {
                const { error } = await supabase
                    .from('settings')
                    .update({ allow_transfers: allowTransfers })
                    .eq('id', 1); // Assuming settings table has a single row with id 1
                if (error) throw error;
                showToast('Settings saved successfully!', 'success');
            } catch (error) {
                console.error('Error saving settings:', error);
                showToast('Failed to save settings.', 'error');
            }
        });

        document.getElementById('bulk-deposit-btn').addEventListener('click', async () => {
            const amount = parseInt(document.getElementById('bulk-deposit-amount').value);
            if (isNaN(amount) || amount <= 0) {
                showToast('Please enter a valid positive amount for bulk deposit.', 'error');
                return;
            }

            if (!confirm(`Are you sure you want to deposit ${amount.toLocaleString()} Ks to ALL approved users?`)) {
                return;
            }

            try {
                const { data, error } = await supabase.rpc('bulk_deposit_to_approved_users', { deposit_amount: amount });
                if (error) throw error;

                if (data.success) {
                    showToast(`Successfully deposited ${data.amount_per_user.toLocaleString()} Ks to ${data.affected_users} approved users.`, 'success');
                    loadUsers(); // Refresh user balances
                    loadDashboardStats();
                    document.getElementById('bulk-deposit-amount').value = '';
                } else {
                    showToast(`Bulk deposit failed: ${data.message}`, 'error');
                }
            } catch (error) {
                console.error('Error executing bulk deposit:', error);
                showToast('Failed to execute bulk deposit.', 'error');
            }
        });


        // Modal Close Handlers
        document.querySelectorAll('.modal-close, .modal-cancel').forEach(btn => {
            btn.addEventListener('click', () => {
                const modalId = btn.getAttribute('data-modal-id');
                if (modalId) {
                    document.getElementById(modalId).classList.remove('active');
                } else { // Fallback for modals without specific data-modal-id on cancel
                    btn.closest('.modal').classList.remove('active');
                }
            });
        });


        // Initial Load
        applySavedTheme();
        checkAdminLogin();

        // Dummy functions for user actions (replace with actual implementation)
        function viewUser(userId) { showToast(`Viewing user: ${userId}`, 'info'); }
        function editUser(userId) { showToast(`Editing user: ${userId}`, 'info'); }

    </script>
</body>
</html>
